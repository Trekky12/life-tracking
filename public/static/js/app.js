"use strict";function handleNetworkChange(e){setOffline(!navigator.onLine)}function setOffline(e){if(e){document.body.classList.add("offline"),document.getElementById("offline-alert").classList.remove("hidden"),setFormFieldsDisabled(!0);document.querySelectorAll(".alert.hide-offline").forEach(function(e,t){e.classList.add("hidden")}),bell.classList.add("disabled")}else document.body.classList.remove("offline"),document.getElementById("offline-alert").classList.add("hidden"),setFormFieldsDisabled(!1),isCached&&window.location.reload(),bell.classList.remove("disabled"),syncSubscription()}function setFormFieldsDisabled(e){document.querySelectorAll('form input, form select, form button[type="submit"]').forEach(function(t,n){t.classList.contains("disabled")||(e?t.setAttribute("disabled",!0):t.removeAttribute("disabled"))})}function initialize(){return"PushManager"in window?"showNotification"in ServiceWorkerRegistration.prototype?"denied"===Notification.permission?(console.warn("Notifications are denied by the user"),void notificationsDisabled("incompatible")):(null!==pushButton&&pushButton.addEventListener("click",function(){isSubscribed?unsubscribeUser():subscribeUser()}),void syncSubscription()):(console.warn("Notifications are not supported by this browser"),void notificationsDisabled("incompatible")):(console.warn("Push notifications are not supported by this browser"),void notificationsDisabled("incompatible"))}function syncSubscription(){navigator.serviceWorker.ready.then(function(e){return e.getNotifications().then(e=>{e.forEach(e=>{e.close()})}),e}).then(function(e){return e.pushManager.getSubscription()}).then(function(e){if(!e)throw notificationsDisabled("disabled"),"No Subscription returned";return updateSubscriptionOnServer(e,"PUT").then(function(t){return e}).catch(function(){throw notificationsDisabled("disabled"),"No Subscription on server"})}).then(function(e){return updateButton("enabled"),getUnreadNotifications(e).then(function(){return e})}).then(function(e){return getNotifications(e).then(function(){return e})}).then(function(e){return getCategorySubscriptions(e).then(function(){return e})}).then(function(e){loadMoreFunctions(e)}).catch(function(e){console.error("Error when updating the subscription",e)}).finally(function(){hideLoadingShowButton()})}function subscribeUser(){const e=urlB64ToUint8Array(jsObject.applicationServerPublicKey);updateButton("computing"),navigator.serviceWorker.ready.then(function(t){return console.log("Subscribing.."),t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e})}).then(function(e){return console.log("User is subscribed."),updateSubscriptionOnServer(e,"POST").then(function(){return e})}).then(function(e){return getCategorySubscriptions(e)}).then(function(){updateButton("enabled")}).catch(function(e){"denied"===Notification.permission?(console.warn("Notifications are denied by the user."),updateButton("incompatible")):(console.error("Impossible to subscribe to push notifications",e),updateButton("disabled"))})}function unsubscribeUser(){navigator.serviceWorker.ready.then(function(e){return e.pushManager.getSubscription()}).then(function(e){if(!e)throw updateButton("disabled"),"No Subscription returned";return updateSubscriptionOnServer(e,"DELETE").then(function(){return e})}).then(function(e){e.unsubscribe(),console.log("User is unsubscribed.")}).then(function(){categoriesList.classList.add("hidden"),updateButton("disabled")}).catch(function(e){console.error("Error unsubscribing",e),updateButton("disabled")})}function updateSubscriptionOnServer(e,t="POST"){const n=e.getKey("p256dh"),i=e.getKey("auth"),o=(PushManager.supportedContentEncodings||["aesgcm"])[0];let s={endpoint:e.endpoint,publicKey:n?btoa(String.fromCharCode.apply(null,new Uint8Array(n))):null,authToken:i?btoa(String.fromCharCode.apply(null,new Uint8Array(i))):null,contentEncoding:o};return getCSRFToken().then(function(e){return s.csrf_name=e.csrf_name,s.csrf_value=e.csrf_value,fetch(jsObject.notifications_subscribe,{method:t,credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(function(e){return e.json()}).then(function(e){if("success"!=e.status)throw"Error updating subscription";return e})})}function urlB64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}function updateButton(e){if(null!==pushButton)switch(e){case"enabled":pushButton.disabled=!1,pushButton.textContent=lang.disable_notifications,isSubscribed=!0,bell.classList.remove("disabled");break;case"disabled":pushButton.disabled=!1,pushButton.textContent=lang.enable_notifications,isSubscribed=!1,bell.classList.add("disabled");break;case"computing":pushButton.disabled=!0,pushButton.textContent=lang.loading;break;case"incompatible":pushButton.disabled=!0,pushButton.textContent=lang.no_notifications_possible,bell.classList.add("disabled");break;default:console.error("Unhandled push button state",e)}}function getCategorySubscriptions(e){if(null!==categoriesList){let t=e.endpoint,n={endpoint:t};return loadingIcon.classList.remove("hidden"),getCSRFToken().then(function(e){return n.csrf_name=e.csrf_name,n.csrf_value=e.csrf_value,fetch(jsObject.notifications_clients_categories,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}).then(function(e){return e.json()}).then(function(e){"error"!==e.status&&(loadingIcon.classList.add("hidden"),categoriesElements.forEach(function(n,i){let o=parseInt(n.value);-1!==e.data.indexOf(o)?n.setAttribute("checked",!0):n.removeAttribute("checked"),n.addEventListener("click",function(){return n.checked?setCategorySubscriptions(t,1,o).then(function(e){console.log(e)}):setCategorySubscriptions(t,0,o).then(function(e){console.log(e)})})}),categoriesList.classList.remove("hidden"))}).catch(function(e){console.log(e)})}return emptyPromise()}function setCategorySubscriptions(e,t,n){let i={endpoint:e,category:n,type:t};return getCSRFToken().then(function(e){return i.csrf_name=e.csrf_name,i.csrf_value=e.csrf_value,fetch(jsObject.notifications_clients_set_category,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}).then(function(e){return e.json()}).then(function(e){return e}).catch(function(e){console.log(e)})}function getNotifications(e){if(null!==notificationsList){let t=notificationsList.childElementCount,n=e.endpoint;loadingIcon.classList.remove("hidden"),loadMore.classList.add("hidden");let i={endpoint:n,count:10,start:t};return getCSRFToken().then(function(e){return i.csrf_name=e.csrf_name,i.csrf_value=e.csrf_value,fetch(jsObject.notifications_get,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}).then(function(e){return e.json()}).then(function(e){if("error"!==e.status){loadingIcon.classList.add("hidden");let n=parseInt(e.count);t+10<n&&loadMore.classList.remove("hidden"),setNotificationCount(e.unseen),e.data.forEach(function(t,n){let i=document.createElement("div");i.classList="notification",i.innerHtml=t.message,i.dataset.id=t.id,t.seen&&(i.classList=i.classList+" seen");let o=document.createElement("div");o.classList="notification-header";let s=document.createElement("h2");if(s.innerHTML=t.title,o.appendChild(s),t.category){let n=document.createElement("span");n.innerHTML=lang.category+": "+e.categories[t.category].name,o.appendChild(n)}let c=document.createElement("div");c.classList="notification-content";let r=document.createElement("p");r.innerHTML=t.message;let a=document.createElement("div");a.classList="createdOn",a.innerHTML=moment(t.createdOn).format(i18n.dateformatJS.datetime),c.appendChild(r),c.appendChild(a),i.appendChild(o),i.appendChild(c),notificationsList.appendChild(i)})}}).catch(function(e){console.log(e)})}return emptyPromise()}function redirect(){null!==notificationsList&&(window.location=jsObject.notifications_clients_manage)}function hideLoadingShowButton(){null!==pushButton&&pushButton.classList.remove("hidden"),null!==loadingIcon&&loadingIcon.classList.add("hidden")}function getUnreadNotifications(e){let t={endpoint:e.endpoint};return getCSRFToken().then(function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.notifications_get_unread,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}).then(function(e){return e.json()}).then(function(e){"error"!==e.status&&setNotificationCount(e.data)}).catch(function(e){console.log(e)})}function loadMoreFunctions(e){null!==loadMore&&(loadMore.addEventListener("click",function(t){getNotifications(e)}),document.addEventListener("scroll",function(){let t=document.body,n=document.documentElement;(n.scrollTop>0&&n.scrollTop+n.clientHeight+100>=n.scrollHeight||t.scrollTop>0&&t.scrollTop+t.clientHeight+100>=t.scrollHeight)&&(loadMore.classList.contains("hidden")||getNotifications(e))}))}function emptyPromise(e=null){return new Promise(t=>{t(e)})}function setNotificationCount(e){badges.forEach(function(t,n){let i=parseInt(e);void 0===e&&(i=parseInt(t.dataset.badge)+1),t.dataset.badge=i,i>0?t.classList.add("has-Notification"):t.classList.remove("has-Notification")})}function notificationsDisabled(e){updateButton(e),bell.classList.add("disabled"),bell.classList.remove("active"),redirect(),hideLoadingShowButton()}const pushButton=document.querySelector("#enable_notifications"),categoriesList=document.querySelector("#notifications_categories_list"),categoriesElements=document.querySelectorAll("#notifications_categories_list input.set_notifications_category"),notificationsList=document.querySelector("#notifications"),loadingIcon=document.querySelector("#loadingIconNotifications"),loadMore=document.querySelector("#loadMore"),badges=document.querySelectorAll(".header-inner .badge"),bell=document.querySelector("#iconBell");let isSubscribed=!1;var isCached=!1;window.addEventListener("online",handleNetworkChange),window.addEventListener("offline",handleNetworkChange),document.addEventListener("DOMContentLoaded",function(){let e=Math.round(document.querySelector("meta[name='timestamp']").getAttribute("content")),t=Math.round(Date.now()/1e3);(localStorage.getItem("isCached")||e+10<=t)&&(localStorage.removeItem("isCached"),console.log("this is cached!"),setOffline(!0),isCached=!0)}),"serviceWorker"in navigator?(navigator.serviceWorker.addEventListener("message",function(e){console.log("Received a message from service worker"),1===e.data.type?(console.log("Notification received"),console.log(e.data.type),setNotificationCount()):2===e.data.type?console.log("Notification Click"):3===e.data.type?(console.log("Loaded content from cache instead of network!"),localStorage.setItem("isCached",!0)):4===e.data.type?console.log("Notification dismissed"):alert(e.data.type)}),navigator.serviceWorker.register("/sw.js").then(function(e){console.log("Service worker successfully registered on scope",e.scope),initialize()}).catch(function(e){console.error("Service Worker Error",e),notificationsDisabled("incompatible")})):notificationsDisabled("incompatible");