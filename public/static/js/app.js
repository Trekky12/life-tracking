"use strict";const pushButton=document.querySelector("#enable_notifications"),categoriesList=document.querySelector("#notifications_categories_list"),categoriesElements=document.querySelectorAll("#notifications_categories_list input.set_notifications_category"),loadingIconManage=document.querySelector("#loadingIconManageNotifications"),iftttUrlWrapper=document.querySelector("#ifttt_url_wrapper"),badges=document.querySelectorAll(".header-inner .badge"),offlineAlert=document.getElementById("offline-alert"),toast=document.getElementById("toastmessage"),offlineElementsAlert=document.getElementById("offline-entries-alert"),appLoadingWindowOverlay=document.getElementById("loading-overlay");let isSubscribed=!1;var isCached=!1;let isAppResumed=!1,isInBackground=!1;function handleNetworkChange(e){setOffline(!navigator.onLine)}function setOffline(e){if(e){document.body.classList.add("offline"),offlineAlert.classList.remove("hidden"),setFormFieldsDisabled(!0),document.querySelectorAll(".alert.hide-offline").forEach((function(e,t){e.classList.add("hidden")}))}else document.body.classList.remove("offline"),offlineAlert.classList.add("hidden"),setFormFieldsDisabled(!1),isCached&&window.location.reload(),syncSubscription()}function setFormFieldsDisabled(e){if(!("indexedDB"in window)){return console.log("This browser doesn't support IndexedDB"),void document.querySelectorAll('form input, form select, form button[type="submit"]').forEach((function(t,n){t.classList.contains("disabled")||(e?t.setAttribute("disabled",!0):t.removeAttribute("disabled"))}))}saveFormDataWhenOffline()}function getIndexedDB(){let e=indexedDB.open("lifeTrackingData",2);return e.onupgradeneeded=function(){let t=e.result;t.objectStoreNames.contains("forms")||t.createObjectStore("forms",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("keys")||t.createObjectStore("keys",{keyPath:"project"})},e}function saveFormDataWhenOffline(){let e=getIndexedDB();e.onsuccess=function(){let t=e.result;document.querySelectorAll("form").forEach((function(e,n){"post"===e.method&&"timesheetNoticeForm"!==e.id&&e.addEventListener("submit",(function(n){n.preventDefault();let o=new FormData(e);o.has("time")||o.append("time",(new Date).toLocaleTimeString());let i=new URLSearchParams(o).toString(),s=t.transaction("forms","readwrite").objectStore("forms").add({action:e.action,type:"POST",data:i});s.onsuccess=function(){console.log("saved locally"),appLoadingWindowOverlay.classList.add("hidden"),showToast(lang.entry_saved_locally,"green"),offlineElementsAlert.classList.remove("hidden"),e.reset()},s.onerror=function(){console.log("Error",s.error),appLoadingWindowOverlay.classList.add("hidden"),showToast(lang.entry_saved_locally_error,"red")}}))}))}}function saveDataWhenOffline(e,t="POST",n=null,o=!0){let i=getIndexedDB();i.onsuccess=function(){let s=i.result.transaction("forms","readwrite").objectStore("forms").add({action:e,type:t,data:n});s.onsuccess=function(){console.log("saved locally"),appLoadingWindowOverlay.classList.add("hidden"),showToast(lang.entry_saved_locally,"green"),offlineElementsAlert.classList.remove("hidden"),o&&(allowedReload=!0,window.location.reload())},s.onerror=function(){console.log("Error",s.error),appLoadingWindowOverlay.classList.add("hidden"),showToast(lang.entry_saved_locally_error,"red")}}}function showToast(e,t){toast.classList.add("show"),toast.innerHTML=e,toast.classList.add(t),setTimeout((function(){toast.classList.remove("show"),toast.classList.remove(t)}),3e3)}function initServiceWorker(){if("serviceWorker"in navigator?navigator.serviceWorker.register("/sw.js").then((function(e){return console.log("Service worker successfully registered on scope",e.scope),navigator.serviceWorker.addEventListener("message",(function(e){console.log("Received a message from service worker"),handleMessage(e.data)})),"PushManager"in window&&"showNotification"in ServiceWorkerRegistration.prototype?"denied"===Notification.permission?(console.warn("Push notifications are denied by the user"),void notificationsDisabled("incompatible")):(null!==pushButton&&pushButton.addEventListener("click",(function(){isSubscribed?unsubscribeUser():subscribeUser()})),void syncSubscription()):(console.warn("Push notifications are not supported by this browser"),void notificationsDisabled("incompatible"))})).catch((function(e){console.error("Service Worker Error",e),notificationsDisabled("incompatible")})):notificationsDisabled("incompatible"),null!==iftttUrlWrapper){iftttUrlWrapper.querySelectorAll(".ifttt_client_wrapper").forEach((function(e){let t=e.querySelector('input[name="ifttt_url"]'),n=e.querySelector(".notifications_categories_list_ifttt");""!==t.value&&getCategorySubscriptions(n,t.value);let o=e.querySelector("button#ifttt_url_remove");o&&o.addEventListener("click",(function(e){return _sendSubscriptionRequest({endpoint:t.value,type:"ifttt"},"DELETE").then((function(e){console.log(e)})).then((function(e){window.location.reload(!0)}))}))}))}setAppBadge()}function syncSubscription(){navigator.serviceWorker.ready.then((function(e){return e.getNotifications().then((e=>{e.forEach((e=>{e.close()}))})),e})).then((function(e){return e.pushManager.getSubscription()})).then((function(e){if(!e)throw notificationsDisabled("disabled"),"No Push Subscription returned";return updateSubscriptionOnServer(e,"PUT").then((function(t){return e})).catch((function(){throw notificationsDisabled("disabled"),"No Push Subscription on server"}))})).then((function(e){return updateButton("enabled"),e})).then((function(e){return getCategorySubscriptions(categoriesList,e.endpoint).then((function(){return e}))})).catch((function(e){console.error("Error when updating the subscription",e)})).finally((function(){hideLoadingShowButton()}))}function subscribeUser(){const e=urlB64ToUint8Array(jsObject.applicationServerPublicKey);updateButton("computing"),navigator.serviceWorker.ready.then((function(t){return console.log("Subscribing.."),t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e})})).then((function(e){return console.log("User is subscribed."),updateSubscriptionOnServer(e,"POST").then((function(){return e}))})).then((function(e){return getCategorySubscriptions(categoriesList,e.endpoint)})).then((function(){updateButton("enabled")})).catch((function(e){"denied"===Notification.permission?(console.warn("Notifications are denied by the user."),updateButton("incompatible")):(console.error("Impossible to subscribe to push notifications",e),updateButton("disabled"))}))}function unsubscribeUser(){navigator.serviceWorker.ready.then((function(e){return e.pushManager.getSubscription()})).then((function(e){if(!e)throw updateButton("disabled"),"No Subscription returned";return updateSubscriptionOnServer(e,"DELETE").then((function(){return e}))})).then((function(e){e.unsubscribe(),console.log("User is unsubscribed.")})).then((function(){categoriesList.classList.add("hidden"),updateButton("disabled")})).catch((function(e){console.error("Error unsubscribing",e),updateButton("disabled")}))}function updateSubscriptionOnServer(e,t="POST"){const n=e.getKey("p256dh"),o=e.getKey("auth"),i=(PushManager.supportedContentEncodings||["aesgcm"])[0];return _sendSubscriptionRequest({endpoint:e.endpoint,publicKey:n?btoa(String.fromCharCode.apply(null,new Uint8Array(n))):null,authToken:o?btoa(String.fromCharCode.apply(null,new Uint8Array(o))):null,contentEncoding:i},t)}function _sendSubscriptionRequest(e,t){return getCSRFToken().then((function(n){return e.csrf_name=n.csrf_name,e.csrf_value=n.csrf_value,fetch(jsObject.notifications_subscribe,{method:t,credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((function(e){return e.json()})).then((function(e){if("success"!=e.status)throw"Error updating subscription";return e}))})).catch((function(e){console.error("Error unsubscribing",e)}))}function urlB64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),o=new Uint8Array(n.length);for(let e=0;e<n.length;++e)o[e]=n.charCodeAt(e);return o}function updateButton(e){if(null!==pushButton)switch(e){case"enabled":pushButton.disabled=!1,pushButton.textContent=lang.disable_push_notifications,isSubscribed=!0;break;case"disabled":pushButton.disabled=!1,pushButton.textContent=lang.enable_push_notifications,isSubscribed=!1;break;case"computing":pushButton.disabled=!0,pushButton.textContent=lang.loading;break;case"incompatible":pushButton.disabled=!0,pushButton.textContent=lang.no_push_notifications_possible,document.querySelector("p#ifttt_enable").classList.remove("hidden"),iftttUrlWrapper.classList.remove("hidden");let t=iftttUrlWrapper.querySelector("button#ifttt_url_save");t.addEventListener("click",(function(e){return _sendSubscriptionRequest({endpoint:t.closest(".ifttt_client_wrapper").querySelector('input[name="ifttt_url"]').value,type:"ifttt"},"POST").then((function(e){window.location.reload(!0)}))}));break;default:console.error("Unhandled push button state",e)}}function getCategorySubscriptions(e,t){if(null!==e){let n=e.nextElementSibling,o={endpoint:t};return n.classList.remove("hidden"),getCSRFToken().then((function(e){return o.csrf_name=e.csrf_name,o.csrf_value=e.csrf_value,fetch(jsObject.notifications_clients_categories,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})})).then((function(e){return e.json()})).then((function(o){if("error"!==o.status){n.classList.add("hidden"),e.querySelectorAll("input.set_notifications_category_client").forEach((function(e,n){let i=e.value;-1!==o.data.indexOf(i)?e.setAttribute("checked",!0):e.removeAttribute("checked"),e.addEventListener("click",(function(){return e.checked?setNotificationCategorySubscriptions(t,1,i).then((function(e){console.log(e)})):setNotificationCategorySubscriptions(t,0,i).then((function(e){console.log(e)}))}))})),e.classList.remove("hidden")}})).catch((function(e){console.log(e)}))}return emptyPromise()}function setNotificationCategorySubscriptions(e,t,n){let o={endpoint:e,category:n,type:t};return getCSRFToken().then((function(e){return o.csrf_name=e.csrf_name,o.csrf_value=e.csrf_value,fetch(jsObject.notifications_clients_set_category,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})})).then((function(e){return e.json()})).then((function(e){return e})).catch((function(e){console.log(e)}))}function redirect(){null!==document.querySelector("#notifications")&&(window.location=jsObject.notifications_clients_manage)}function hideLoadingShowButton(){null!==pushButton&&pushButton.classList.remove("hidden"),document.querySelectorAll(".loading-icon-notification-categories").forEach((function(e){e.classList.add("hidden")}))}function emptyPromise(e=null){return new Promise((t=>{t(e)}))}function setNotificationCount(e){badges.forEach((function(t,n){let o=parseInt(e);void 0===e&&(o=parseInt(t.dataset.badge)+1),t.dataset.badge=o,o>0?t.classList.add("has-Notification"):t.classList.remove("has-Notification")}))}function setAppBadge(){"setAppBadge"in navigator&&badges.forEach((function(e,t){let n=parseInt(e.dataset.badge);n>0?(console.log("Set App Badge"),navigator.setAppBadge(n)):navigator.clearAppBadge()}))}function notificationsDisabled(e){updateButton(e),hideLoadingShowButton()}function handleMessage(e){1===e.type?(console.log("Push Notification received"),console.log(e.type),console.log(e.data),setNotificationCount(e.data),setAppBadge()):2===e.type?console.log("Push Notification Click"):3===e.type?(console.log("Loaded content from cache instead of network!"),localStorage.setItem("isCached",!0)):4===e.type?console.log("Push Notification dismissed"):alert(e.type)}async function getUnreadNotifications(){const e=await fetch(jsObject.notifications_unread,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}),t=await e.json();"error"!==t.status&&(setNotificationCount(t.unseen),setAppBadge())}window.addEventListener("online",handleNetworkChange),window.addEventListener("offline",handleNetworkChange),initServiceWorker(),document.addEventListener("DOMContentLoaded",(function(){let e=Math.round(document.querySelector("meta[name='timestamp']").getAttribute("content")),t=Math.round(Date.now()/1e3);if((localStorage.getItem("isCached")||e+30<=t)&&(localStorage.removeItem("isCached"),console.log("this is cached!"),console.log(e),console.log(t),setOffline(!0),isCached=!0),!("indexedDB"in window))return;let n=getIndexedDB();n.onsuccess=function(){let e=n.result,t=e.transaction("forms","readwrite").objectStore("forms").getAll();t.onsuccess=function(){if(!(t.result.length<=0||(offlineElementsAlert.classList.remove("hidden"),isCached))){let n=[],o=0,i=0;t.result.forEach((function(t,s){n.push(getCSRFToken().then((function(e){let n=new URLSearchParams(t.data);return n.set("csrf_name",e.csrf_name),n.set("csrf_value",e.csrf_value),fetch(t.action,{method:t.type,credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n})})).then((function(n){return new Promise((function(s,r){if(n.ok){let n=e.transaction("forms","readwrite").objectStore("forms").delete(t.id);n.onsuccess=function(e){o++,s()},n.onerror=function(e){i++,r(e)}}else r("error, wrong response")}))})))})),Promise.all(n).then((function(e){let t="orange";o>0&&i<=0&&(offlineElementsAlert.classList.add("hidden"),t="green"),o<=0&&i>0&&(t="red"),showToast(lang.locally_saved_entries_submitted+" "+lang.locally_saved_entries_submitted_success+": "+o+", "+lang.locally_saved_entries_submitted_error+": "+i,t)}))}}}})),window.addEventListener("blur",(function(){isAppResumed=!1,isInBackground=!0})),window.addEventListener("focus",(function(){isInBackground&&!isAppResumed&&(isAppResumed=!0,isInBackground=!1,getUnreadNotifications())}));