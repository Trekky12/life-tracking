"use strict";const loadingIconBoard=document.querySelector("#loadingIconBoard"),stacksWrapper=document.querySelector(".stack-wrapper"),new_stack_element=document.querySelector("#templates .stack-dummy");let boardData=[];function renderBoard(){"error"!==boardData.status&&(stacksWrapper.innerHTML="",Object.values(boardData.stacks).forEach((function(e){let t=document.querySelector("#templates .stack").cloneNode(!0);t.dataset.stack=e.id,1==e.archive&&t.classList.add("archived"),t.querySelector(".stack-header span.title").innerHTML=e.name,t.querySelector("a#create-card").dataset.stack=e.id,Object.values(e.cards).forEach((function(e){let a=document.querySelector("#templates .board-card").cloneNode(!0);if(a.dataset.card=e.id,1==e.archive&&a.classList.add("archived"),a.querySelector(".card-title").innerHTML=e.title,e.description&&a.querySelector(".description").classList.remove("hidden"),e.date||e.time){let t=a.querySelector(".card-date");if(t.classList.remove("hidden"),e.date){let a=moment(e.date,"YYYY-MM-DD");moment().isSameOrAfter(a)&&t.classList.add("due"),t.innerHTML=moment(e.date,"YYYY-MM-DD").format(i18n.dateformatJS.date)}e.time&&(t.innerHTML=t.innerHTML+" "+moment(e.time,"HH:mm:ss").format("HH:mm"))}let n=a.querySelector(".check");n.classList.add("btn-archive"),n.dataset.url=jsObject.card_archive+e.id,n.dataset.archive=e.archive;let r=a.querySelector(".card-labels .handle");e.labels.forEach((function(e){let t=boardData.labels[e],n=document.createElement("div");n.classList.add("card-label"),n.style.backgroundColor=t.background_color,n.style.color=t.text_color,a.querySelector(".card-labels").insertBefore(n,r)})),e.users.forEach((function(e){boardData.users[e];a.querySelectorAll(".card-member").forEach((function(t){t.dataset.user==e&&t.classList.remove("hidden")}))})),t.querySelector(".card-wrapper").appendChild(a)})),stacksWrapper.appendChild(t)})),stacksWrapper.appendChild(new_stack_element),document.querySelectorAll(".card-wrapper").forEach((function(e){new Sortable(e,{group:{name:"cards"},draggable:".board-card",handle:isMobile()?".handle":".board-card",dataIdAttr:"data-card",ghostClass:"card-placeholder",onUpdate:function(e){changeCardPosition(this.toArray())},onAdd:function(e){var t=e.to.closest(".stack").dataset.stack,a=e.item.dataset.card;e.newIndex;let n=this.toArray();var r={card:a,stack:t};getCSRFToken().then((function(e){return r.csrf_name=e.csrf_name,r.csrf_value=e.csrf_value,fetch(jsObject.card_movestack_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})})).then((function(e){return e.json()})).then((function(){return changeCardPosition(n)})).catch((function(e){console.log(e)}))}})})))}function loadBoard(){return fetch(jsObject.boards_data,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}).then((function(e){return e.json()})).catch((function(e){console.log(e)}))}document.addEventListener("DOMContentLoaded",(async function(){loadingIconBoard.classList.remove("hidden"),boardData=await loadBoard(),renderBoard(),loadingIconBoard.classList.add("hidden")})),document.addEventListener("click",(function(e){let t=e.target.closest(".stack-header");if(t){e.preventDefault(),document.getElementById("loading-overlay").classList.remove("hidden");let n=t.closest(".stack").dataset.stack,r=getElementFromID(boardData.stacks,n);stackModal.querySelector('input[name="id"]').value=r.id,stackModal.querySelector('input[name="name"]').value=r.name,stackModal.querySelector('input[name="position"]').value=r.position;var a="<a href='#' data-url='"+jsObject.stack_archive+r.id+"' data-archive='"+r.archive+"' class='btn-archive'>"+document.getElementById("iconArchive").innerHTML+"</a> \n                                    <a href='#' data-url='"+jsObject.stack_delete+r.id+"' class='btn-delete' data-type='stack'>"+document.getElementById("iconTrash").innerHTML+"</a>";stackModal.querySelector(".edit-bar").innerHTML=a,document.getElementById("stack-add-btn").value=lang.update,openDialog(stackModal),document.getElementById("loading-overlay").classList.add("hidden")}let n=e.target.closest(".btn-archive");if(n){n.parentElement.style.backgroundColor=n.value,e.preventDefault();var r=n.dataset.url,l=parseInt(n.dataset.archive);if(1===l){if(!confirm(lang.undo_archive))return!1}else if(!confirm(lang.really_archive))return!1;var o={archive:0===l?1:0};getCSRFToken().then((function(e){return o.csrf_name=e.csrf_name,o.csrf_value=e.csrf_value,fetch(r,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})})).then((function(e){return e.json()})).then((function(e){allowedReload=!0,window.location.reload(!0)})).catch((function(e){if(console.log(e),document.body.classList.contains("offline")){let e=new URLSearchParams(o).toString();saveDataWhenOffline(r,"POST",e)}}))}e.target.closest("#create-stack")&&(e.preventDefault(),openDialog(stackModal)),e.target.closest("#stack-close-btn")&&closeDialog(stackModal),e.target.closest("#create-label")&&(e.preventDefault(),openDialog(labelModal)),e.target.closest("#label-close-btn")&&closeDialog(labelModal);let d=e.target.closest("a.edit-label");if(d){e.preventDefault(),document.getElementById("loading-overlay").classList.remove("hidden");var c=d.dataset.label;fetch(jsObject.label_get_url+c,{method:"GET",credentials:"same-origin"}).then((function(e){return e.json()})).then((function(e){if("error"!==e.status){labelModal.querySelector('input[name="id"]').value=e.entry.id,labelModal.querySelector('input[name="name"]').value=e.entry.name,labelModal.querySelector('input[name="background_color"]').value=e.entry.background_color,labelModal.querySelector('input[name="background_color"]').parentElement.style.backgroundColor=e.entry.background_color,labelModal.querySelector('input[name="text_color"]').value=e.entry.text_color,labelModal.querySelector('input[name="text_color"]').parentElement.style.backgroundColor=e.entry.text_color;var t="<a href='#' data-url='"+jsObject.label_delete+e.entry.id+"' class='btn-delete' data-type='label'>"+document.getElementById("iconTrash").innerHTML+"</a>";labelModal.querySelector(".edit-bar").innerHTML=t,document.getElementById("label-add-btn").value=lang.update,openDialog(labelModal)}})).then((function(){document.getElementById("loading-overlay").classList.add("hidden")})).catch((function(e){console.log(e)}))}let s=e.target.closest(".create-card");if(s){e.preventDefault();var i=s.dataset.stack;cardModal.querySelector('input[name="stack"]').value=i,openDialog(cardModal)}e.target.closest("#card-close-btn")&&(e.preventDefault(),closeDialog(cardModal));let u=e.target.closest(".board-card-content");if(u){e.preventDefault(),document.getElementById("loading-overlay").classList.remove("hidden");let t=u.closest(".stack").dataset.stack,n=u.closest(".board-card").dataset.card,r=getElementFromID(boardData.stacks,t),l=getElementFromID(r.cards,n);if(cardModal.querySelector('input[name="id"]').value=l.id,cardModal.querySelector('input[name="title"]').value=l.title,cardModal.querySelector('input[name="position"]').value=l.position,cardModal.querySelector('input[name="stack"]').value=l.stack,cardModal.querySelector('input[name="archive"]').value=l.archive,l.date){var m=cardModal.querySelector('input[name="date"]');m.value=l.date,m._flatpickr.setDate(l.date),m.parentElement.parentElement.querySelectorAll(".show-sibling").forEach((function(e,t){e.classList.add("hidden")})),m.parentElement.classList.remove("hidden")}if(l.time){var f=cardModal.querySelector('input[name="time"]');f.value=l.time,f.parentElement.parentElement.querySelectorAll(".show-sibling").forEach((function(e,t){e.classList.add("hidden")})),f.parentElement.classList.remove("hidden")}var h=cardModal.querySelector('textarea[name="description"]');if(l.description){h.value=l.description,h.parentElement.parentElement.querySelectorAll(".show-sibling").forEach((function(e,t){e.classList.add("hidden")})),h.parentElement.classList.remove("hidden")}cardModal.querySelector("#createdBy").innerHTML=l.createdBy,cardModal.querySelector("#createdOn").innerHTML=moment(l.createdOn).format(i18n.dateformatJS.datetime),cardModal.querySelector("#changedBy").innerHTML=l.changedBy,cardModal.querySelector("#changedOn").innerHTML=moment(l.changedOn).format(i18n.dateformatJS.datetime),cardModal.querySelector(".form-group.card-dates").classList.remove("hidden");let o=cardModal.querySelector('select[name="users[]"]');cardModal.querySelectorAll(".avatar-small, .avatar-small").forEach((function(e,t){let a=parseInt(e.dataset.user);var n=o.querySelector("option[value='"+a+"']");void 0!==l.users&&-1!==l.users.indexOf(a)?(e.classList.add("selected"),n.selected=!0):(e.classList.remove("selected"),n.selected=!1)})),selector.reset(),selector.setValue(l.labels.map(String));a="<a href='#' data-url='"+jsObject.card_archive+l.id+"' data-archive='"+l.archive+"' class='btn-archive'>"+document.getElementById("iconArchive").innerHTML+"</a> \n                                    <a href='#' data-url='"+jsObject.card_delete+l.id+"' class='btn-delete' data-type='card'>"+document.getElementById("iconTrash").innerHTML+"</a>";cardModal.querySelector(".edit-bar").innerHTML=a,document.getElementById("card-add-btn").value=lang.update,openDialog(cardModal),document.getElementById("loading-overlay").classList.add("hidden")}}));let openedDialogData=null;const selector=new Selectr("select#card-label-list",{searchable:!1,customClass:"selectr-boards",renderOption:function(e){return["<div class='select-option-label' style='background-color:",e.dataset.backgroundColor,"; color:",e.dataset.textColor,"'><span>",e.textContent,"</span></div>"].join("")},renderSelection:function(e){return['<div class="select-label" style="background-color:',e.dataset.backgroundColor,"; color:",e.dataset.textColor,'"><span>',e.textContent.trim(),"</span></div>"].join("")},placeholder:lang.labels});var simplemde=null;document.addEventListener("keydown",(function(e){27===e.keyCode&&(isVisible(stackModal)&&closeDialog(stackModal),isVisible(labelModal)&&closeDialog(labelModal),isVisible(cardModal)&&closeDialog(cardModal))})),document.addEventListener("change",(function(e){let t=e.target.closest('input[type="color"]');t&&(t.parentElement.style.backgroundColor=t.value)}));const stackModal=document.getElementById("stack-modal");stackModal.querySelector("form").addEventListener("submit",(function(e){e.preventDefault(),save(stackModal,jsObject.stack_save)}));const labelModal=document.getElementById("label-modal");labelModal.querySelector("form").addEventListener("submit",(function(e){e.preventDefault(),save(labelModal,jsObject.label_save)}));const cardModal=document.getElementById("card-modal");cardModal.querySelector("form").addEventListener("submit",(function(e){e.preventDefault(),save(cardModal,jsObject.card_save)})),cardModal.addEventListener("keypress",(function(e){13===e.keyCode&&(e.preventDefault(),save(cardModal,jsObject.card_save))}));let avatars=document.querySelectorAll("#card-modal .avatar");avatars.forEach((function(e,t){e.addEventListener("click",(function(t){t.preventDefault();var a=e.dataset.user,n=document.querySelector("#card-modal select#users option[value='"+a+"']");n.selected?(n.selected=!1,e.classList.remove("selected")):(n.selected=!0,e.classList.add("selected"))}))}));let siblings=cardModal.querySelectorAll(".show-sibling");function openDialog(e){if(openedDialogData=formToJSON(e.querySelector("form")),freeze(),e.style.display="block",isMobile()||e.querySelector('input[type="text"]').focus(),e===cardModal){var t=cardModal.querySelector('textarea[name="description"]');simplemde=new SimpleMDE({element:t,autosave:{enabled:!1},forceSync:!0,spellChecker:!1,promptURLs:!0,status:!1,styleSelectedText:!isMobile(),minHeight:"50px"}),""!==t.value&&simplemde.togglePreview()}}function closeDialog(e){let t=formToJSON(e.querySelector("form")),a=lang.really_close;if(e===stackModal&&(a=lang.really_close_stack),e===cardModal&&(a=lang.really_close_card),e===labelModal&&(a=lang.really_close_label),JSON.stringify(openedDialogData)!==JSON.stringify(t)&&!confirm(a))return!1;if(unfreeze(),e.style.display="none",e===labelModal){e.querySelectorAll(".color-wrapper").forEach((function(e,t){e.style.backgroundColor="black"}))}if(e===cardModal){simplemde&&(simplemde.toTextArea(),simplemde=null),cardModal.querySelectorAll(".show-sibling").forEach((function(e,t){e.classList.remove("hidden")})),cardModal.querySelectorAll(".hidden-field").forEach((function(e,t){e.classList.add("hidden")})),cardModal.querySelector('textarea[name="description"]').style.height="auto",cardModal.querySelector("#createdBy").innerHTML="",cardModal.querySelector("#createdOn").innerHTML="",cardModal.querySelector("#changedBy").innerHTML="",cardModal.querySelector("#changedOn").innerHTML="",cardModal.querySelectorAll(".form-group.card-dates").forEach((function(e,t){e.classList.add("hidden")})),cardModal.querySelector('select[name="labels[]"]').value="",cardModal.querySelector('select[name="users[]"]').value="",cardModal.querySelectorAll(".avatar-small, .avatar-small").forEach((function(e,t){e.classList.remove("selected")})),cleanURL()}document.getElementById("stack-add-btn").value=lang.add,document.getElementById("card-add-btn").value=lang.add,document.getElementById("label-add-btn").value=lang.add,e.querySelector("form").reset(),e.querySelectorAll('input[type="hidden"].reset-field').forEach((function(e){e.value=""})),e.querySelector(".edit-bar").innerHTML="",openedDialogData=null}function cleanURL(){var e=window.location.toString();if(e.indexOf("?")>0){var t=e.substring(0,e.indexOf("?"));window.history.replaceState({},document.title,t)}}function addCardtoURL(e){var t=window.location.toString(),a=t.indexOf("?")>0?"&":"?";t.indexOf("card")<=0&&window.history.replaceState({},document.title,t+a+"card="+e)}function formToJSON(e){let t={};return new FormData(e).forEach((function(e,a){if(a.endsWith("[]")){let n=a.slice(0,-2);Array.isArray(t[n])||(t[n]=[]),t[n].push(e)}else t[a]=e})),t}function save(e,t){document.getElementById("loading-overlay").classList.remove("hidden"),cleanURL();var a=e.querySelector('input[name="id"]').value;let n=e.querySelector("form");getCSRFToken().then((function(e){let r=formToJSON(n);return r.csrf_name=e.csrf_name,r.csrf_value=e.csrf_value,fetch(t+a,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})})).then((function(e){return e.json()})).then((function(e){allowedReload=!0,window.location.reload(!0)})).catch((function(e){if(console.log(e),document.body.classList.contains("offline")){let e=new URLSearchParams(new FormData(n)).toString();saveDataWhenOffline(t+a,"POST",e)}}))}siblings.forEach((function(e,t){e.addEventListener("click",(function(t){t.preventDefault(),e.classList.add("hidden"),e.parentNode.querySelectorAll(".hidden-field").forEach((function(e){e.classList.remove("hidden");let t=e.querySelector("input");t&&t.focus();let a=e.querySelector("textarea");a&&a.focus();let n=cardModal.querySelector('input[name="date"]');t===n&&n._flatpickr.open()})),simplemde&&(simplemde.codemirror.refresh(),simplemde.codemirror.focus())}))}));let sidebarToggle=document.getElementById("sidebar-toggle");sidebarToggle.addEventListener("click",(function(e){e.preventDefault(),isMobile()?(sidebarToggle.parentElement.classList.remove("desktop-hidden"),sidebarToggle.parentElement.classList.toggle("mobile-visible"),sidebarToggle.parentElement.classList.contains("mobile-visible")?(setCookie("sidebar_mobilevisible",1),setCookie("sidebar_desktophidden",0)):setCookie("sidebar_mobilevisible",0)):(sidebarToggle.parentElement.classList.remove("mobile-visible"),sidebarToggle.parentElement.classList.toggle("desktop-hidden"),sidebarToggle.parentElement.classList.contains("desktop-hidden")?(setCookie("sidebar_desktophidden",1),setCookie("sidebar_mobilevisible",0)):setCookie("sidebar_desktophidden",0))}));let checkBoxArchivedItems=document.getElementById("checkboxArchivedItems");async function updateBoard(){let e=await loadBoard();JSON.stringify(boardData)!==JSON.stringify(e)&&(console.log("Update Board Data"),loadingIconBoard.classList.remove("hidden"),boardData=e,renderBoard(),loadingIconBoard.classList.add("hidden"))}checkBoxArchivedItems.addEventListener("click",(function(e){var t={state:checkBoxArchivedItems.checked?1:0};getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.set_archive,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){allowedReload=!0,window.location.reload(!0)})).catch((function(e){console.log(e)}))})),setInterval((async function(){var e=isVisible(stackModal),t=isVisible(cardModal),a=isVisible(labelModal);!0==!e&&!0==!t&&!0==!a&&await updateBoard()}),1e4),window.addEventListener("beforeunload",(function(e){var t=isVisible(stackModal),a=isVisible(cardModal),n=isVisible(labelModal);allowedReload||!0!==t&&!0!==a&&!0!==n||(e.returnValue=lang.really_close_page)}));const sidebar=document.getElementById("sidebar"),masthead=document.getElementById("masthead"),pageBody=document.getElementsByTagName("BODY")[0];function sidebarAdjustments(){let e=masthead.offsetHeight,t=window.scrollY;if(t<e){let a=e-t;sidebar.style.paddingTop=a+"px"}else sidebar.style.paddingTop=0}window.addEventListener("scroll",(function(){pageBody.classList.contains("mobile-navigation-open")&&sidebarAdjustments()}));var sortable=new Sortable(stacksWrapper,{group:{name:"stacks"},draggable:".stack",handle:isMobile()?".handle":".stack-header",dataIdAttr:"data-stack",filter:".stack-dummy",onEnd:function(e){var t={stack:this.toArray()};getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.stack_position_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){return updateBoard()})).catch((function(e){console.log(e)}))}});function getElementFromID(e,t){for(let a in e){let n=e[a];if(n.id==t)return n}return null}function changeCardPosition(e){var t={card:e};return getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.card_position_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){return updateBoard()})).catch((function(e){console.log(e)}))}