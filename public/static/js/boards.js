!function(e){e(document).ready(function(){function a(a,t){e("#loading-overlay").removeClass("hidden"),l();var n=a.find('input[name="id"]').val(),i=a.find("form").serialize();i+="&"+getCSRFToken(!0),e.ajax({url:t+n,method:"POST",data:i,success:function(e){allowedReload=!0,window.location.reload()},error:function(e){alert(e)}})}function t(a){e("#loading-overlay").removeClass("hidden"),e.ajax({url:jsObject.card_get_url+a,method:"GET",success:function(a){if("error"!==a.status){if(s.find('input[name="id"]').val(a.entry.id),s.find('input[name="title"]').val(a.entry.title),s.find('input[name="position"]').val(a.entry.position),s.find('input[name="stack"]').val(a.entry.stack),s.find('input[name="archive"]').val(a.entry.archive),a.entry.date){var t=s.find('input[name="date"]');t.val(a.entry.date),s.find("input.date-display").datepicker("setDate",moment(a.entry.date).toDate()),t.parent().siblings(".show-sibling").addClass("hidden"),t.parent().removeClass("hidden")}if(a.entry.time){var n=s.find('input[name="time"]');n.val(a.entry.time),n.parent().siblings(".show-sibling").addClass("hidden"),n.parent().removeClass("hidden")}var i=s.find('textarea[name="description"]');a.entry.description&&(i.val(a.entry.description),i.parent().siblings(".show-sibling").addClass("hidden"),i.parent().removeClass("hidden")),s.find("#createdBy").html(a.entry.createdBy),s.find("#createdOn").html(moment(a.entry.createdOn).format(i18n.dateformatJSFull)),s.find("#changedBy").html(a.entry.changedBy),s.find("#changedOn").html(moment(a.entry.changedOn).format(i18n.dateformatJSFull)),s.find(".form-group.card-dates").removeClass("hidden"),s.find('select[name="users[]"]').val(a.entry.users);var r=s.find(".avatar-small, .avatar-small");e.each(r,function(t,n){var i=e(n).data("user");-1!==jQuery.inArray(i,a.entry.users)?e(n).addClass("selected"):e(n).removeClass("selected")}),s.find('select[name="labels[]"]').val(a.entry.labels),e("#card-add-btn").button("option","label",lang.update);var d="<a href='#' data-url='"+jsObject.card_archive+a.entry.id+"' data-archive='"+a.entry.archive+"' class='btn-archive'><i class='fa fa-archive' aria-hidden='true'></i></a> \n                                    <a href='#' data-url='"+jsObject.card_delete+a.entry.id+"' class='btn-delete'><i class='fa fa-trash' aria-hidden='true'></i></a>";s.parent().find(".ui-dialog-titlebar .edit-bar").html(d),e("select#card-label-list").trigger("chosen:updated"),s.dialog("open")}else l()}}).done(function(){e("#loading-overlay").addClass("hidden")})}function n(){s.dialog({width:e(window).width()>550?550:"auto"}),"none"!==e(".menu-toggle").css("display")?e(".stack-wrapper").sortable({axis:!1}):e(".stack-wrapper").sortable({axis:"x"})}function i(){var a=e(".sidebar");e(window).scrollTop()<e("#masthead").outerHeight()?a.css("padding-top",e("#masthead").outerHeight()-e(window).scrollTop()):a.css("padding-top",0)}function l(){var e=window.location.toString();if(e.indexOf("?")>0){var a=e.substring(0,e.indexOf("?"));window.history.replaceState({},document.title,a)}}function r(e,a,t,n){t=t||365;var i=new Date;i.setDate(i.getDate()+t);var l=[e+"="+a,"expires="+i.toUTCString(),"path="+n||"/"];document.cookie=l.join(";")}getCSRFToken(!1);var d,o,s,c,u,f,p=null;d=e("#stack-form").dialog({autoOpen:!1,autoResize:!0,width:330,modal:!0,buttons:[{text:lang.add,id:"stack-add-btn",click:function(){a(d,jsObject.stack_save)},class:"button"},{text:lang.cancel,click:function(){e(this).dialog("close")},class:"button gray"}],create:function(){e(this).parent().children(".ui-dialog-titlebar").append('<span class="edit-bar"></span>')},open:function(a,t){"none"!==e(".menu-toggle").css("display")&&e(this).parent().focus()},close:function(){e("#stack-add-btn").button("option","label",lang.add),o[0].reset(),o.find('input[type="hidden"].reset-field').val(""),e(this).parent().find(".ui-dialog-titlebar .edit-bar").html("")}}),o=d.find("form").on("submit",function(e){e.preventDefault(),a(d,jsObject.stack_save)}),e("a.create-stack").on("click",function(e){e.preventDefault(),d.dialog("open")}),e(".stack-header").on("click",function(a){a.preventDefault(),e("#loading-overlay").removeClass("hidden");var t=e(this).data("stack");e.ajax({url:jsObject.stack_get_url+t,method:"GET",success:function(a){if("error"!==a.status){d.find('input[name="id"]').val(a.entry.id),d.find('input[name="name"]').val(a.entry.name),d.find('input[name="position"]').val(a.entry.position),e("#stack-add-btn").button("option","label",lang.update);var t="<a href='#' data-url='"+jsObject.stack_archive+a.entry.id+"' data-archive='"+a.entry.archive+"' class='btn-archive'><i class='fa fa-archive' aria-hidden='true'></i></a> \n                                    <a href='#' data-url='"+jsObject.stack_delete+a.entry.id+"' class='btn-delete'><i class='fa fa-trash' aria-hidden='true'></i></a>";d.parent().find(".ui-dialog-titlebar .edit-bar").html(t),d.dialog("open")}}}).done(function(){e("#loading-overlay").addClass("hidden")})}),s=e("#card-form").dialog({autoOpen:!1,autoResize:!0,width:550,modal:!0,buttons:[{text:lang.add,id:"card-add-btn",click:function(){a(s,jsObject.card_save)},class:"button"},{text:lang.cancel,click:function(){e(this).dialog("close")},class:"button gray"}],open:function(){var a=s.find('textarea[name="description"]');p=new SimpleMDE({element:a[0],autosave:{enabled:!1},forceSync:!0,spellChecker:!1,promptURLs:!0,status:!1,styleSelectedText:"none"===e(".menu-toggle").css("display"),minHeight:"50px"}),""!==a.val()&&p.togglePreview(),"none"!==e(".menu-toggle").css("display")&&e(this).parent().focus()},create:function(){e(this).parent().children(".ui-dialog-titlebar").append('<span class="edit-bar"></span>')},close:function(){e("#card-add-btn").button("option","label",lang.add),p&&(p.toTextArea(),p=null),c[0].reset(),c.find('input[type="hidden"].reset-field').val(""),e(this).parent().find(".ui-dialog-titlebar .edit-bar").html(""),c.find(".show-sibling").removeClass("hidden"),c.find(".hidden-field").addClass("hidden"),s.find('textarea[name="description"]').height("auto"),s.find("#createdBy").html(""),s.find("#createdOn").html(""),s.find("#changedBy").html(""),s.find("#changedOn").html(""),s.find(".form-group.card-dates").addClass("hidden"),s.find('select[name="labels[]"]').val(""),e("select#card-label-list").trigger("chosen:updated"),s.find('select[name="users[]"]').val(""),s.find(".avatar-small, .avatar-small").removeClass("selected"),l()}}),c=s.find("form").on("submit",function(e){e.preventDefault(),a(s,jsObject.card_save)}),e("a.create-card").on("click",function(a){a.preventDefault();var t=e(this).data("stack");c.find('input[name="stack"]').val(t),s.dialog("open")}),e(".board-card").on("click",function(a){a.preventDefault();t(e(this).data("card"))}),e(".show-sibling").on("click",function(a){return a.preventDefault(),e(this).addClass("hidden"),e(this).siblings(".hidden-field").removeClass("hidden").find("input, textarea").focus(),p&&p.codemirror.refresh(),!1}),u=e("#label-form").dialog({autoOpen:!1,autoResize:!0,width:330,modal:!0,buttons:[{text:lang.add,id:"label-add-btn",click:function(){a(u,jsObject.label_save)},class:"button"},{text:lang.cancel,click:function(){e(this).dialog("close")},class:"button gray"}],create:function(){e(this).parent().children(".ui-dialog-titlebar").append('<span class="edit-bar"></span>')},open:function(a,t){"none"!==e(".menu-toggle").css("display")&&e(this).parent().focus()},close:function(){e("#label-add-btn").button("option","label",lang.add),f[0].reset(),f.find('input[type="hidden"].reset-field').val(""),e(this).parent().find(".ui-dialog-titlebar .edit-bar").html(""),e(this).find(".color-wrapper").css("background-color","black")}}),f=u.find("form").on("submit",function(e){e.preventDefault(),a(u,jsObject.label_save)}),e("a.create-label").on("click",function(e){e.preventDefault(),u.dialog("open")}),e("a.edit-label").on("click",function(a){a.preventDefault(),e("#loading-overlay").removeClass("hidden");var t=e(this).data("label");e.ajax({url:jsObject.label_get_url+t,method:"GET",success:function(a){if("error"!==a.status){u.find('input[name="id"]').val(a.entry.id),u.find('input[name="name"]').val(a.entry.name),u.find('input[name="background_color"]').val(a.entry.background_color),u.find('input[name="background_color"]').parent(".color-wrapper").css("background-color",a.entry.background_color),u.find('input[name="text_color"]').val(a.entry.text_color),u.find('input[name="text_color"]').parent(".color-wrapper").css("background-color",a.entry.text_color),e("#label-add-btn").button("option","label",lang.update);var t="<a href='#' data-url='"+jsObject.label_delete+a.entry.id+"' class='btn-delete'><i class='fa fa-trash' aria-hidden='true'></i></a>";u.parent().find(".ui-dialog-titlebar .edit-bar").html(t),u.dialog("open")}}}).done(function(){e("#loading-overlay").addClass("hidden")})}),e(".stack-wrapper").sortable({items:".stack",axis:"x",tolerance:"pointer",helper:"clone",handle:".stack-header",cursor:"move",containment:"parent",start:function(e,a){a.helper.removeClass("stack-border")},stop:function(e,a){},update:function(a,t){var n=e(this).sortable("serialize");n+="&"+getCSRFToken(!0),e.ajax({data:n,type:"POST",url:jsObject.stack_position_url})}}).disableSelection(),e(".card-wrapper").sortable({connectWith:".card-wrapper",dropOnEmpty:!0,helper:"clone",placeholder:"card-placeholder",update:function(a,t){var n=e(this).sortable("serialize");n+="&"+getCSRFToken(!0),e.ajax({data:n,type:"POST",url:jsObject.card_position_url})},receive:function(a,t){var n=e(this).data("stack"),i={card:t.item.data("card"),stack:n},l=getCSRFToken(!1);i.csrf_name=l.csrf_name,i.csrf_value=l.csrf_value,e.ajax({data:i,type:"POST",url:jsObject.card_movestack_url})}}).disableSelection(),e("body").on("click",".btn-archive",function(a){a.preventDefault();var t=e(this).data("url"),n=e(this).data("archive");if(1===n){if(!confirm(lang.undo_archive))return!1}else if(!confirm(lang.really_archive))return!1;var i={archive:n?0:1},l=getCSRFToken(!1);i.csrf_name=l.csrf_name,i.csrf_value=l.csrf_value,e.ajax({url:t,method:"POST",data:i,success:function(e){allowedReload=!0,window.location.reload()},error:function(e){alert(e)}})}),e("#card-form .avatar").on("click",function(a){a.preventDefault();var t=e(this).data("user"),n=e("#card-form select#users option[value='"+t+"']");n.prop("selected")?(n.prop("selected",!1),e(this).removeClass("selected")):(n.prop("selected",!0),e(this).addClass("selected"))}),e(".avatar").disableSelection(),n(),e(window).resize(function(){n()}),e("#sidebar-toggle").on("click",function(a){a.preventDefault(),"none"!==e(".menu-toggle").css("display")?(e(this).parent().removeClass("desktop-hidden"),e(this).parent().toggleClass("mobile-visible"),e(this).parent().hasClass("mobile-visible")?(r("sidebar_mobilevisible",1),r("sidebar_desktophidden",0)):r("sidebar_mobilevisible",0)):(e(this).parent().removeClass("mobile-visible"),e(this).parent().toggleClass("desktop-hidden"),e(this).parent().hasClass("desktop-hidden")?(r("sidebar_desktophidden",1),r("sidebar_mobilevisible",0)):r("sidebar_desktophidden",0))}),e(document).on("change",'input[type="color"]',function(){e(this).parent(".color-wrapper").css("background-color",""+e(this).val())}),e("select#card-label-list").chosen({width:"100%",disable_search:!0,placeholder_text_multiple:lang.labels}),i(),e(window).scroll(function(){i()}),e("#checkboxArchivedItems").on("click",function(a){var t={state:e(this).is(":checked")?1:0},n=getCSRFToken(!1);t.csrf_name=n.csrf_name,t.csrf_value=n.csrf_value,e.ajax({url:jsObject.set_archive,method:"POST",data:t,success:function(e){allowedReload=!0,window.location.reload()},error:function(e){alert(e)}})}),e(".avatar-small").tooltip(),setInterval(function(){var e=d.dialog("isOpen"),a=s.dialog("isOpen"),t=u.dialog("isOpen");!0==!e&&!0==!a&&!0==!t&&window.location.reload()},3e4),s.keypress(function(e){13===e.keyCode&&(e.preventDefault(),a(s,jsObject.card_save))}),e("#addComment").on("click",function(a){a.preventDefault();var t={card:s.find('input[name="id"]').val(),comment:s.find('textarea[name="comment"]').val()},n=getCSRFToken(!1);t.csrf_name=n.csrf_name,t.csrf_value=n.csrf_value,e.ajax({url:jsObject.comment_save,method:"POST",data:t,success:function(e){allowedReload=!0,window.location.reload()},error:function(e){alert(e)}})});var h=window.location.href.match(/(?:\?card=([0-9]*))/);if(null!==h&&h.length>1){t(h[1])}e(window).on("beforeunload",function(){var e=d.dialog("isOpen"),a=s.dialog("isOpen"),t=u.dialog("isOpen");if(!allowedReload&&(!0===e||!0===a||!0===t))return lang.really_close})})}(jQuery);