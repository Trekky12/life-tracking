"use strict";function createKeyMaterial(e){let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}function deriveKEK(e,t,n){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:n,hash:"SHA-512"},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function encryptData(e,t){try{const n=window.crypto.getRandomValues(new Uint8Array(16)),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n},e,(new TextEncoder).encode(t)),a=new Uint8Array(r);let o=new Uint8Array(n.byteLength+a.byteLength);o.set(n,0),o.set(a,n.byteLength);return buff_to_base64(o)}catch(e){throw console.error(`Error Encrypting - ${e}`),e}}async function decryptData(e,t){try{const n=base64_to_buf(t),r=n.slice(0,16),a=n.slice(16),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:r},e,a);return(new TextDecoder).decode(o)}catch(e){throw console.log(`Error Decrypting - ${e}`),e}}async function createKeyObject(e){return window.crypto.subtle.importKey("raw",e,"AES-GCM",!1,["encrypt","decrypt"])}function buff_to_base64(e){return btoa(String.fromCharCode.apply(null,e))}function base64_to_buf(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(null)))}function fromHexString(e){return Uint8Array.from(e.match(/.{1,2}/g).map((e=>parseInt(e,16))))}async function getEncryptionParameters(){let e={},t=await getCSRFToken();e.csrf_name=t.csrf_name,e.csrf_value=t.csrf_value;let n=await fetch(jsObject.timesheets_notice_params,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await n.json();if("success"!==r.status)throw"Unable to retrieve parameters";return r}async function getRawMasterKeyFromKEK(e,t,n){try{if("test"!==await decryptData(e,t))throw"Wrong message!"}catch(e){throw console.error(`Unable to decrypt test message - ${e}`),e}let r;try{r=base64_to_buf(await decryptData(e,n))}catch(e){throw console.error(`Unable to decrypt masterKey - ${e}`),e}return r}async function getStore(){if("indexedDB"in window){let e=indexedDB.open("lifeTrackingData",2);return new Promise((function(t,n){e.onsuccess=function(){var n=e.result.transaction("keys","readwrite").objectStore("keys");t(n)}}))}}async function getMasterKeyFromPW(e,t,n=!0){const r=t.iterations,a=base64_to_buf(t.salt),o=await createKeyMaterial(e),c=await deriveKEK(o,a,r);let i=await getRawMasterKeyFromKEK(c,t.testMessageEncryptedWithKEK,t.masterKeyEncryptedWithKEK);if(n){(await getStore()).add({project:projectID,key:c})}return i}async function getKEKfromStore(){let e=await getStore();return await new Promise((function(t,n){let r=e.get(projectID);r.onsuccess=function(e){r.result&&t(r.result.key),t(null)}}))}function IsJsonString(e){try{JSON.parse(e)}catch(e){return!1}return!0}async function getMasterKeyFromStoreOrInput(e,t){let n,r=await getKEKfromStore();if(r)try{n=await getRawMasterKeyFromKEK(r,t.data.testMessageEncryptedWithKEK,t.data.masterKeyEncryptedWithKEK)}catch(t){let n=await getStore();await n.delete(e);return!1}else{let e=await inputDialog(lang.timesheets_notice_password);if(!1===e)return!1;try{n=await getMasterKeyFromPW(e,t.data,!0)}catch(e){return console.log(e),!1}}return await createKeyObject(n)}function createInputDialog(e,t){var n=document.createElement("div");n.id="input-modal",n.classList.add("modal"),n.classList.add("vertical-centered");var r=document.createElement("div");r.classList.add("modal-inner");var a=document.createElement("form"),o=document.createElement("div");o.classList.add("modal-content");var c=document.createElement("p");c.textContent=e,o.appendChild(c);var i=document.createElement("input");i.type="text",i.classList.add("form-control"),o.appendChild(i);var s=document.createElement("div");s.classList.add("modal-footer");var d=document.createElement("div");d.classList.add("buttons");var l=document.createElement("button");l.type="button",l.classList.add("button"),l.textContent=lang.ok;var u=document.createElement("button");function y(e){"Enter"===e.key?(e.preventDefault(),n.remove(),t(i.value),document.removeEventListener("keydown",y)):"Escape"!==e.key&&27!==e.keyCode||(e.preventDefault(),n.remove(),t(!1),document.removeEventListener("keydown",y))}u.classList.add("button","button-text","cancel"),u.type="button",u.textContent=lang.cancel,d.appendChild(l),d.appendChild(u),s.appendChild(d),a.appendChild(o),a.appendChild(s),r.appendChild(a),n.appendChild(r),document.body.appendChild(n),n.style.display="block",i.focus(),l.onclick=function(){n.remove(),t(i.value)},u.onclick=function(){n.remove(),t(!1),document.removeEventListener("keydown",y)},document.addEventListener("keydown",y)}function inputDialog(e){return new Promise(((t,n)=>{createInputDialog(e,t)}))}