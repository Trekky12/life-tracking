"use strict";const latField=document.querySelector("input#geoLat"),lngField=document.querySelector("input#geoLng"),accField=document.querySelector("input#geoAcc"),idField=document.querySelector('input[name="id"]'),mapContainers=document.querySelectorAll(".geo-map"),updateLocButtons=document.querySelectorAll(".update-location"),deleteLocButtons=document.querySelectorAll(".delete-location"),getAdressButtons=document.querySelectorAll(".set_address"),geoOptions={enableHighAccuracy:!0,timeout:6e4,maximumAge:0};let map=[],map_marker=[],lastAccuracy=9999999,timeout=null;function getLocation(e){navigator.geolocation?navigator.geolocation.getCurrentPosition((function(t){locationRetrieved(t,e)}),locationError,geoOptions):console.log("Geolocation is not supported by this browser.")}function locationRetrieved(e,t){if(console.log(e),e.coords.accuracy<lastAccuracy){let a=latField,o=lngField,n=accField,r=mapContainers[t];r&&(a=r.parentNode.querySelector(".geo-lat"),o=r.parentNode.querySelector(".geo-lng"),n=r.parentNode.querySelector(".geo-acc")),a.value=e.coords.latitude,o.value=e.coords.longitude,n.value=e.coords.accuracy,lastAccuracy=e.coords.accuracy,r&&drawMap(r,t)}e.coords.accuracy>50?(console.log("Accuracy not exact"),timeout=setTimeout((function(){getLocation()}),5e3)):console.log("Accuracy reached")}function locationError(e){switch(e.code){case e.PERMISSION_DENIED:console.log("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:console.log("Location information is unavailable.");break;case e.TIMEOUT:console.log("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:console.log("An unknown error occurred.")}}function drawMap(e,t){if(null!==e){let a=e.parentNode.querySelector(".geo-lat"),o=e.parentNode.querySelector(".geo-lng"),n=e.parentNode.querySelector(".geo-acc"),r=e.parentNode.querySelector(".delete-location"),l=e.parentNode.querySelector(".geo-draggable");if(null===a||null===o)return;let c=a.value,u=o.value,i=n?n.value:0,d=!l||"0"!==l.value;if(0===c.length||0===u.length)return;null===map[t]&&(e.style.height="300px",e.classList.add("visible"),r&&r.classList.remove("hidden"),map[t]=L.map(e).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(map[t])),null!==map_marker[t]&&map[t].removeLayer(map_marker[t]),map_marker[t]=L.marker([c,u],{draggable:d}),map_marker[t].addTo(map[t]),d&&(map_marker[t].on("drag",(function(e){let t=e.target,r=t.getLatLng();a.value=r.lat,o.value=r.lng,n&&(n.value=0),t._popup.setContent('<a href="#" data-lat="'+r.lat+'" data-lng="'+r.lng+'" class="btn-get-address">'+lang.address+"</a>"),clearTimeout(timeout)})),map[t].on("click",(function(e){map_marker[t].setLatLng(e.latlng),map_marker[t].off("mouseover"),map_marker[t].off("popupopen"),map_marker[t].fire("drag")})));let s="";i>0&&(s=lang.accuracy+": "+i+" m<br/>");let p='<a href="#" data-lat="'+c+'" data-lng="'+u+'" class="btn-get-address" id="marker-popup">'+lang.address+"</a>";if(map_marker[t].bindPopup(s+p),i>0){let e=null;map_marker[t].off("mouseover"),map_marker[t].off("popupopen"),map_marker[t].on("mouseover",(function(a){e=L.circle(a.target.getLatLng(),{opacity:.5,radius:i}).addTo(map[t])})),map_marker[t].on("mouseout",(function(a){map[t].hasLayer(e)&&map[t].removeLayer(e)})),map_marker[t].on("dragstart",(function(){map_marker[t].off("mouseover"),map_marker[t].off("popupopen")})),map_marker[t].on("popupopen",(function(a){e=L.circle(a.target.getLatLng(),{opacity:.5,radius:i}).addTo(map[t])})),map_marker[t].on("popupclose",(function(a){map[t].hasLayer(e)&&map[t].removeLayer(e)}))}let m=new L.featureGroup([map_marker[t]]);map[t].fitBounds(m.getBounds())}}function removeMap(e,t,a){t.style.height="0px",t.classList.remove("visible"),e.classList.add("hidden"),map[a].off(),map[a].remove(),map[a]=null;let o=t.parentNode.querySelector(".geo-lat"),n=t.parentNode.querySelector(".geo-lng"),r=t.parentNode.querySelector(".geo-acc");o.value="",n.value="",r.value="",clearTimeout(timeout)}mapContainers.forEach((function(e,t){map[t]=null,map_marker[t]=null,drawMap(e,t)})),null!==latField&&null!==lngField&&null!==accField&&null===idField&&0===latField.value.length&&0===lngField.value.length&&0===accField.value.length&&getLocation(0),null!==updateLocButtons&&updateLocButtons.forEach((function(e,t){e.addEventListener("click",(function(e){e.preventDefault(),clearTimeout(timeout),lastAccuracy=9999999,getLocation(t)}))})),null!==deleteLocButtons&&deleteLocButtons.forEach((function(e,t){e.addEventListener("click",(function(a){a.preventDefault();let o=e.parentNode.parentNode.querySelector(".geo-map");removeMap(e,o,t)}))})),null!==getAdressButtons&&getAdressButtons.forEach((function(e,t){e.addEventListener("click",(function(a){a.preventDefault();let o=e.previousElementSibling.value,n=e.parentNode.querySelector("input.geo-lat"),r=e.parentNode.querySelector("input.geo-lng"),l=e.nextElementSibling;o&&fetch(jsObject.get_location_of_address+"?address="+o,{method:"GET",credentials:"same-origin"}).then((function(e){return e.json()})).then((function(e){if(console.log(e),"success"==e.status){let a=e.data;if(a.length>0){let e=a[0];n.value=e.lat,r.value=e.lon,drawMap(l,t)}else alert(lang.nothing_found)}else alert(lang.nothing_found)}))}))}));