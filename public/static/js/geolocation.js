"use strict";function getLocation(e){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){locationRetrieved(t,e)},locationError,geoOptions):console.log("Geolocation is not supported by this browser.")}function locationRetrieved(e,t){if(console.log(e),e.coords.accuracy<lastAccuracy){let o=latField,a=lngField,l=accField,n=mapContainers[t];n&&(o=n.parentNode.querySelector(".geo-lat"),a=n.parentNode.querySelector(".geo-lng"),l=n.parentNode.querySelector(".geo-acc")),o.value=e.coords.latitude,a.value=e.coords.longitude,l.value=e.coords.accuracy,lastAccuracy=e.coords.accuracy,n&&drawMap(n,t)}e.coords.accuracy>50?(console.log("Accuracy not exact"),timeout=setTimeout(function(){getLocation()},5e3)):console.log("Accuracy reached")}function locationError(e){switch(e.code){case e.PERMISSION_DENIED:console.log("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:console.log("Location information is unavailable.");break;case e.TIMEOUT:console.log("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:console.log("An unknown error occurred.")}}function drawMap(e,t){if(null!==e){let o=e.parentNode.querySelector(".geo-lat"),a=e.parentNode.querySelector(".geo-lng"),l=e.parentNode.querySelector(".geo-acc"),n=e.parentNode.querySelector(".delete-location");if(null===o||null===a)return;let r=o.value,c=a.value,u=l?l.value:0;if(0===r.length||0===c.length)return;null===map[t]&&(e.style.height="300px",e.classList.add("visible"),n&&n.classList.remove("hidden"),map[t]=L.map(e).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(map[t])),null!==map_marker[t]&&map[t].removeLayer(map_marker[t]),map_marker[t]=L.marker([r,c],{draggable:!0}),map_marker[t].on("drag",function(e){let t=e.target,n=t.getLatLng();o.value=n.lat,a.value=n.lng,l&&(l.value=0),t._popup.setContent('<a href="#" data-lat="'+n.lat+'" data-lng="'+n.lng+'" class="btn-get-address">'+lang.address+"</a>"),clearTimeout(timeout)}),map_marker[t].addTo(map[t]),map[t].on("click",function(e){map_marker[t].setLatLng(e.latlng),map_marker[t].off("mouseover"),map_marker[t].fire("drag")});let i="";u>0&&(i=lang.accuracy+": "+u+" m<br/>");let d='<a href="#" data-lat="'+r+'" data-lng="'+c+'" class="btn-get-address" id="marker-popup">'+lang.address+"</a>";if(map_marker[t].bindPopup(i+d),u>0){let e=null;map_marker[t].off("mouseover"),map_marker[t].on("mouseover",function(o){e=L.circle(o.target.getLatLng(),{opacity:.5,radius:u}).addTo(map[t])}),map_marker[t].on("mouseout",function(o){map[t].hasLayer(e)&&map[t].removeLayer(e)}),map_marker[t].on("dragstart",function(){map_marker[t].off("mouseover")})}let s=new L.featureGroup([map_marker[t]]);map[t].fitBounds(s.getBounds())}}function removeMap(e,t,o){t.style.height="0px",t.classList.remove("visible"),e.classList.add("hidden"),map[o].off(),map[o].remove(),map[o]=null;let a=t.parentNode.querySelector(".geo-lat"),l=t.parentNode.querySelector(".geo-lng"),n=t.parentNode.querySelector(".geo-acc");a.value="",l.value="",n.value="",clearTimeout(timeout)}const latField=document.querySelector("input#geoLat"),lngField=document.querySelector("input#geoLng"),accField=document.querySelector("input#geoAcc"),idField=document.querySelector('input[name="id"]'),mapContainers=document.querySelectorAll(".geo-map"),updateLocButtons=document.querySelectorAll(".update-location"),deleteLocButtons=document.querySelectorAll(".delete-location"),getAdressButtons=document.querySelectorAll(".set_address"),geoOptions={enableHighAccuracy:!0,timeout:6e4,maximumAge:0};let map=[],map_marker=[],lastAccuracy=9999999,timeout=null;mapContainers.forEach(function(e,t){map[t]=null,map_marker[t]=null,drawMap(e,t)}),null!==latField&&null!==lngField&&null!==accField&&null===idField&&0===latField.value.length&&0===lngField.value.length&&0===accField.value.length&&getLocation(0),null!==updateLocButtons&&updateLocButtons.forEach(function(e,t){e.addEventListener("click",function(e){e.preventDefault(),clearTimeout(timeout),lastAccuracy=9999999,getLocation(t)})}),null!==deleteLocButtons&&deleteLocButtons.forEach(function(e,t){e.addEventListener("click",function(o){o.preventDefault();let a=e.parentNode.parentNode.querySelector(".geo-map");removeMap(e,a,t)})}),null!==getAdressButtons&&getAdressButtons.forEach(function(e,t){e.addEventListener("click",function(o){o.preventDefault();let a=e.previousElementSibling.value,l=e.parentNode.querySelector("input.geo-lat"),n=e.parentNode.querySelector("input.geo-lng"),r=e.nextElementSibling;a&&fetch(jsObject.get_location_of_address+"?address="+a,{method:"GET",credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){if(console.log(e),"success"==e.status){let o=e.data;if(o.length>0){let e=o[0];l.value=e.lat,n.value=e.lon,drawMap(r,t)}else alert("Nothing found")}else alert("Nothing found")})})});