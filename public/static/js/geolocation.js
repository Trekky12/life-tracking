"use strict";const latField=document.querySelector("input#geoLat"),lngField=document.querySelector("input#geoLng"),accField=document.querySelector("input#geoAcc"),idField=document.querySelector('input[name="id"]'),mapContainers=document.querySelectorAll(".geo-map"),updateLocButtons=document.querySelectorAll(".update-location"),deleteLocButtons=document.querySelectorAll(".delete-location"),getAdressButtons=document.querySelectorAll(".set_address"),geoOptions={enableHighAccuracy:!0,timeout:6e4,maximumAge:0};let map=[],map_marker=[],lastAccuracy=9999999,timeout=null;function getLocation(e){navigator.geolocation?navigator.geolocation.getCurrentPosition((function(t){locationRetrieved(t,e)}),locationError,geoOptions):console.log("Geolocation is not supported by this browser.")}function locationRetrieved(e,t){if(console.log(e),e.coords.accuracy<lastAccuracy&&t>=0){let o=latField,a=lngField,n=accField,r=mapContainers[t];r&&(o=r.parentNode.querySelector(".geo-lat"),a=r.parentNode.querySelector(".geo-lng"),n=r.parentNode.querySelector(".geo-acc")),o.value=e.coords.latitude,a.value=e.coords.longitude,n.value=e.coords.accuracy,lastAccuracy=e.coords.accuracy,r&&drawMap(r,t)}e.coords.accuracy>50?(console.log("Accuracy not exact"),timeout=setTimeout((function(){getLocation(t)}),5e3)):(console.log("Accuracy reached"),getLastLocationTime().then((function(t){Math.round(Date.now()/1e3)>=t+300&&storeLocation(e)})).catch((function(e){console.log(e)})))}function locationError(e){switch(e.code){case e.PERMISSION_DENIED:console.log("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:console.log("Location information is unavailable.");break;case e.TIMEOUT:console.log("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:console.log("An unknown error occurred.")}}function drawMap(e,t){if(null!==e){let o=e.parentNode.querySelector(".geo-lat"),a=e.parentNode.querySelector(".geo-lng"),n=e.parentNode.querySelector(".geo-acc"),r=e.parentNode.querySelector(".map-btn"),l=e.parentNode.querySelector(".delete-location"),c=e.parentNode.querySelector(".geo-draggable");if(null===o||null===a)return;let u=o.value,i=a.value,s=n?n.value:0,d=!c||"0"!==c.value;if(0===u.length||0===i.length)return;null===map[t]&&(e.style.height="300px",e.classList.add("visible"),r.classList.add("map-visible"),l&&l.classList.remove("hidden"),map[t]=L.map(e).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(map[t])),null!==map_marker[t]&&map[t].removeLayer(map_marker[t]),map_marker[t]=L.marker([u,i],{draggable:d}),map_marker[t].addTo(map[t]),d&&(map_marker[t].on("drag",(function(e){let t=e.target,r=t.getLatLng();o.value=r.lat,a.value=r.lng,n&&(n.value=0),t._popup.setContent('<a href="#" data-lat="'+r.lat+'" data-lng="'+r.lng+'" class="btn-get-address">'+lang.address+"</a>"),clearTimeout(timeout)})),map[t].on("click",(function(e){map_marker[t].setLatLng(e.latlng),map_marker[t].off("mouseover"),map_marker[t].off("popupopen"),map_marker[t].fire("drag")})));let p="";s>0&&(p=lang.accuracy+": "+s+" m<br/>");let m='<a href="#" data-lat="'+u+'" data-lng="'+i+'" class="btn-get-address" id="marker-popup">'+lang.address+"</a>";if(map_marker[t].bindPopup(p+m),s>0){let e=null;map_marker[t].off("mouseover"),map_marker[t].off("popupopen"),map_marker[t].on("mouseover",(function(o){e=L.circle(o.target.getLatLng(),{opacity:.5,radius:s}).addTo(map[t])})),map_marker[t].on("mouseout",(function(o){map[t].hasLayer(e)&&map[t].removeLayer(e)})),map_marker[t].on("dragstart",(function(){map_marker[t].off("mouseover"),map_marker[t].off("popupopen")})),map_marker[t].on("popupopen",(function(o){e=L.circle(o.target.getLatLng(),{opacity:.5,radius:s}).addTo(map[t])})),map_marker[t].on("popupclose",(function(o){map[t].hasLayer(e)&&map[t].removeLayer(e)}))}let g=new L.featureGroup([map_marker[t]]);map[t].fitBounds(g.getBounds())}}function removeMap(e,t,o){t.style.height="0px",t.classList.remove("visible"),e.classList.add("hidden"),map[o].off(),map[o].remove(),map[o]=null;let a=t.parentNode.querySelector(".geo-lat"),n=t.parentNode.querySelector(".geo-lng"),r=t.parentNode.querySelector(".geo-acc");a.value="",n.value="",r&&(r.value=""),t.parentNode.querySelector(".map-btn").classList.remove("map-visible"),clearTimeout(timeout)}function getLastLocationTime(){return fetch(jsObject.location_last,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}).then((function(e){return e.json()})).then((function(e){if("success"==e.status)return e.ts;throw"Error"}))}function storeLocation(e){let t={gps_loc:e.coords.latitude+","+e.coords.longitude,gps_acc:e.coords.accuracy};return getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.location_record,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){console.log(e)})).catch((function(e){console.log(e)}))}mapContainers.forEach((function(e,t){map[t]=null,map_marker[t]=null,drawMap(e,t)})),null!==latField&&null!==lngField&&null!==accField&&null===idField&&0===latField.value.length&&0===lngField.value.length&&0===accField.value.length?getLocation(0):getLastLocationTime().then((function(e){Math.round(Date.now()/1e3)>=e+300&&getLocation(-1)})).catch((function(e){console.log(e)})),null!==updateLocButtons&&updateLocButtons.forEach((function(e,t){e.addEventListener("click",(function(e){e.preventDefault(),clearTimeout(timeout),lastAccuracy=9999999,getLocation(t)}))})),null!==deleteLocButtons&&deleteLocButtons.forEach((function(e,t){e.addEventListener("click",(function(o){o.preventDefault();let a=e.parentNode.parentNode.querySelector(".geo-map");removeMap(e,a,t)}))})),null!==getAdressButtons&&getAdressButtons.forEach((function(e,t){e.addEventListener("click",(function(o){o.preventDefault();let a=e.previousElementSibling.value,n=e.parentNode.querySelector("input.geo-lat"),r=e.parentNode.querySelector("input.geo-lng"),l=e.nextElementSibling;a&&fetch(jsObject.get_location_of_address+"?address="+a,{method:"GET",credentials:"same-origin"}).then((function(e){return e.json()})).then((function(e){if(console.log(e),"success"==e.status){let o=e.data;if(o.length>0){let e=o[0];n.value=e.lat,r.value=e.lon,drawMap(l,t)}else alert(lang.nothing_found)}else alert(lang.nothing_found)}))}))}));