"use strict";const detailsModal=document.getElementById("details-modal");var mymap=L.map("mapid").setView([default_location.lat,default_location.lng],default_location.zoom);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);const from=document.getElementById("inputStart").value,to=document.getElementById("inputEnd").value;var controlLayer=null,circleLayer=new L.LayerGroup;let markers=[],tableCount=[];var clusterToggleLayer=new L.LayerGroup;let layerLocation=new L.LayerGroup,layerFinances=new L.LayerGroup,layerCars=new L.LayerGroup,layerSplittedBills=new L.LayerGroup,layerTimesheets=new L.LayerGroup,layerTrips=new L.LayerGroup,layerDirections=new L.LayerGroup,layerLocationMarkers=new L.LayerGroup,layerFinancesMarkers=new L.LayerGroup,layerCarsMarkers=new L.LayerGroup,layerSplittedBillsMarkers=new L.LayerGroup,layerTimesheetsMarkers=new L.LayerGroup,layerLocationClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"location")},maxClusterRadius:50}),layerFinancesClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"finances")},maxClusterRadius:50}),layerCarsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"cars")},maxClusterRadius:50}),layerSplittedBillsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"splittedbills")},maxClusterRadius:50}),layerTimesheetsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"timesheets")},maxClusterRadius:50});async function getMarkers(){try{const e=await fetch(jsObject.location_markers+"?from="+from+"&to="+to,{method:"GET",credentials:"same-origin"}),a=await e.json();drawMarkers(a.markers,!1),addRouteDetails(a.count)}catch(e){console.log(e)}}function drawMarkers(e,a=!1){let r=[],t=[],l=0;for(l in e){let a=e[l];if(a.type>=4&&(null===a.data.start_lat&&null!==a.data.end_lat&&(a.data.start_lat=a.data.end_lat),null===a.data.start_lng&&null!==!a.data.end_lng&&(a.data.start_lng=a.data.end_lng),null!==a.data.start_lat&&null!==a.data.start_lng&&(a.lat=a.data.start_lat,a.lng=a.data.start_lng)),null===a.lat||null===a.lng)continue;0==a.type&&r.push([a.lat,a.lng,l]);let n=createMarker(a);if(t.push(n),a.data&&null!==a.data.end_lat&&null!==a.data.end_lng&&a.data.start_lat!==a.data.end_lat&&a.data.start_lng!==a.data.end_lng){a.lat=a.data.end_lat,a.lng=a.data.end_lng,a.acc=a.data.end_acc;let e=createMarker(a);if(5==a.type)if(a.isCarrental)e.bindPopup(n.getPopup());else if(a.isTrain){let a=[],r=calculateMidPoint(n,e),t=quadraticBezierPoints(n,r,e);a[0]=L.polyline(t,{color:"black",weight:"5"}).bindPopup(n.getPopup()),a[1]=L.polyline(t,{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(n.getPopup()),a[2]=L.polyline(t,{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(a)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(a.isPlane){let a=calculateMidPoint(n,e),r=quadraticBezierPoints(n,a,e),t=L.polyline(r,{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(n.getPopup());layerTrips.addLayer(t),layerTrips.removeLayer(e)}else if(a.isCar){let a=[],r=calculateMidPoint(n,e),t=quadraticBezierPoints(n,r,e);a[0]=L.polyline(t,{color:"gray",weight:"5"}).bindPopup(n.getPopup()),a[1]=L.polyline(t,{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(a)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(a.isShip){let a=calculateMidPoint(n,e),r=quadraticBezierPoints(n,a,e),t=L.polyline(r,{color:"blue",weight:"5",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup());layerTrips.addLayer(t),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}t.push(e)}}if(a?(layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers)):(layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters)),mymap.addLayer(layerLocation),mymap.addLayer(layerFinances),mymap.addLayer(layerCars),mymap.addLayer(layerSplittedBills),mymap.addLayer(layerTimesheets),mymap.addLayer(layerTrips),t.length>0){var n=new L.featureGroup(t);mymap.fitBounds(n.getBounds())}var o=L.polyline(r);layerDirections.addLayer(o),a||clusterToggleLayer.addTo(mymap),(controlLayer=L.control.layers(null,null,{collapsed:!1})).addOverlay(clusterToggleLayer,"<span id='toggleClustering'>"+document.getElementById("iconClustering").innerHTML+"</span>"),controlLayer.addOverlay(layerLocation,"<span id='layerLocation'>"+document.getElementById("iconLocation").innerHTML+"</span>"),controlLayer.addOverlay(layerFinances,"<span id='layerFinances'>"+document.getElementById("iconFinances").innerHTML+"</span>"),controlLayer.addOverlay(layerCars,"<span id='layerCars'>"+document.getElementById("iconCars").innerHTML+"</span>"),controlLayer.addOverlay(layerSplittedBills,"<span id='layerSplittedBills'>"+document.getElementById("iconSplittedBills").innerHTML+"</span>"),controlLayer.addOverlay(layerTimesheets,"<span id='layerTimesheets'>"+document.getElementById("iconTimesheets").innerHTML+"</span>"),controlLayer.addOverlay(layerTrips,"<span id='layerTrips'>"+document.getElementById("iconTrips").innerHTML+"</span>"),controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),controlLayer.addTo(mymap),circleLayer.addTo(mymap)}mymap.on("zoom",(function(){removeCircleLayer()})),getMarkers(),mymap.on("overlayremove",(function(e){e.layer===layerLocation&&(controlLayer.removeLayer(layerDirections),setTimeout((function(){mymap.removeLayer(layerDirections)}),10)),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationClusters),layerFinances.removeLayer(layerFinancesClusters),layerCars.removeLayer(layerCarsClusters),layerSplittedBills.removeLayer(layerSplittedBillsClusters),layerTimesheets.removeLayer(layerTimesheetsClusters),layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers))})),mymap.on("overlayadd",(function(e){e.layer!==layerLocation||mymap.hasLayer(layerDirections)||controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationMarkers),layerFinances.removeLayer(layerFinancesMarkers),layerCars.removeLayer(layerCarsMarkers),layerSplittedBills.removeLayer(layerSplittedBillsMarkers),layerTimesheets.removeLayer(layerTimesheetsMarkers),layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters))})),mymap.on("movestart zoomstart",(function(e){isMapMove=!0})),mymap.on("moveend zoomend",(function(e){isMapMove=!1}));var lc=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0}});mymap.addControl(lc);let locationFilter=document.getElementById("show-filter");function createClusterIcon(e,a){var r=e.getChildCount();return new L.DivIcon({html:"<div><span>"+r+"</span></div>",className:"marker-cluster "+a,iconSize:new L.Point(40,40)})}function addCircleLayer(e,a,r,t){let l={opacity:.5,radius:r,weight:5,color:t},n=L.circle([e,a],l),o={weight:10,color:t},s=L.polygon([[e,a]],o);circleLayer.addLayer(n),circleLayer.addLayer(s)}function removeCircleLayer(){circleLayer.clearLayers()}function createMarker(e){var a=e.dt+"<br/>",r="";e.acc>0&&(r=lang.accuracy+" : "+e.acc+" m<br/>");var t='<a href="#" data-lat="'+e.lat+'" data-lng="'+e.lng+'" class="btn-get-address">'+lang.address+"</a>",l=e.steps>0?lang.steps+": "+e.steps+"<br/>":"",n='<br/><br/><a href="#" data-url="'+jsObject.delete_marker_url+e.id+'" class="btn-delete">'+lang.delete_text+"</a>";let o="";o=e.popup?e.popup:a+r+l+t;let s={},i="#3388ff";switch(e.type){case 0:s.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconLocation").innerHTML}),o+=n;break;case 1:s.icon=L.ExtraMarkers.icon({markerColor:"green",shape:"circle",innerHTML:document.getElementById("iconFinances").innerHTML}),i="green",o+="<br/><br/><strong>"+e.description+" - "+e.value+" "+i18n.currency+"</strong>";break;case 2:s.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconCars").innerHTML}),i="yellow",o+="<br/><br/><strong>"+(0==e.description?lang.car_refuel:lang.car_service)+"</strong>";break;case 3:s.icon=L.ExtraMarkers.icon({markerColor:"orange",shape:"circle",innerHTML:document.getElementById("iconSplittedBills").innerHTML}),i="orange",o+="<br/><br/><strong>"+e.description+"</strong>";break;case 4:s.icon=L.ExtraMarkers.icon({markerColor:"pink",shape:"circle",innerHTML:document.getElementById("iconTimesheets").innerHTML}),i="pink";break;case 5:e.isCarrental?s.icon=L.ExtraMarkers.icon({markerColor:"red",shape:"circle",innerHTML:document.getElementById("iconCarRentals").innerHTML}):e.isHotel?s.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconHotels").innerHTML}):e.isEvent?s.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconEvents").innerHTML}):e.isPlane&&(s.icon=L.ExtraMarkers.icon({markerColor:"black",shape:"circle",innerHTML:document.getElementById("iconPlanes").innerHTML}))}var c=L.marker([e.lat,e.lng],s);switch(e.acc>0&&(c.on("mouseover",(function(a){addCircleLayer(e.lat,e.lng,e.acc,i)})),c.on("mouseout",(function(e){removeCircleLayer()})),c.on("popupopen",(function(a){addCircleLayer(e.lat,e.lng,e.acc,i)})),c.on("popupclose",(function(e){removeCircleLayer()}))),e.type){case 0:layerLocationMarkers.addLayer(c),layerLocationClusters.addLayer(c);break;case 1:layerFinancesMarkers.addLayer(c),layerFinancesClusters.addLayer(c);break;case 2:layerCarsMarkers.addLayer(c),layerCarsClusters.addLayer(c);break;case 3:layerSplittedBillsMarkers.addLayer(c),layerSplittedBillsClusters.addLayer(c);break;case 4:layerTimesheetsMarkers.addLayer(c),layerTimesheetsClusters.addLayer(c);break;case 5:layerTrips.addLayer(c)}return c.bindPopup(o),c}function addRouteDetails(e){let a=detailsModal.querySelector(".modal-content");a.innerHTML="";for(const[r,t]of Object.entries(e)){if(!t||Array.isArray(t)&&0===t.length||"object"==typeof t&&0===Object.keys(t).length)continue;const e=Object.values(t).reduce(((e,a)=>e+Number(a)),0),l=document.createElement("details");l.classList.add("dt-wrapper");const n=document.createElement("summary"),o=lang[`${r}_module_name`]??r;n.textContent=`${o} (${e})`,l.appendChild(n);const s=document.createElement("table");s.classList.add("table","table-hover","small","dt-table");const i=document.createElement("thead"),c=document.createElement("tr"),d=document.createElement("th");d.textContent=lang.date;const y=document.createElement("th");y.textContent=lang.count,c.appendChild(d),c.appendChild(y),i.appendChild(c),s.appendChild(i);const u=document.createElement("tbody");for(const[e,a]of Object.entries(t)){const r=document.createElement("tr"),t=document.createElement("td");t.textContent=e;const l=document.createElement("td");l.textContent=a,r.appendChild(t),r.appendChild(l),u.appendChild(r)}s.appendChild(u),l.appendChild(s),a.appendChild(l)}}null!==locationFilter&&locationFilter.addEventListener("click",(function(e){e.preventDefault();let a=document.getElementById("search-form");a.style.height=a.scrollHeight+"px",a.classList.toggle("collapsed"),locationFilter.classList.toggle("hiddenSearch")})),document.getElementById("show-details-modal").addEventListener("click",(function(e){detailsModal.classList.add("visible")})),document.getElementById("modal-close-btn").addEventListener("click",(function(e){detailsModal.classList.remove("visible")}));