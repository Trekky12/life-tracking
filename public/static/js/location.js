"use strict";var mymap=L.map("mapid").setView([default_location.lat,default_location.lng],default_location.zoom);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);const from=document.getElementById("inputStart").value,to=document.getElementById("inputEnd").value;var controlLayer=null,circleLayer=new L.LayerGroup;let markers=[];var clusterToggleLayer=new L.LayerGroup;let layerLocation=new L.LayerGroup,layerFinances=new L.LayerGroup,layerCars=new L.LayerGroup,layerSplittedBills=new L.LayerGroup,layerTimesheets=new L.LayerGroup,layerTrips=new L.LayerGroup,layerDirections=new L.LayerGroup,layerLocationMarkers=new L.LayerGroup,layerFinancesMarkers=new L.LayerGroup,layerCarsMarkers=new L.LayerGroup,layerSplittedBillsMarkers=new L.LayerGroup,layerTimesheetsMarkers=new L.LayerGroup,layerLocationClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"location")},maxClusterRadius:50}),layerFinancesClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"finances")},maxClusterRadius:50}),layerCarsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"cars")},maxClusterRadius:50}),layerSplittedBillsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"splittedbills")},maxClusterRadius:50}),layerTimesheetsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"timesheets")},maxClusterRadius:50});async function getMarkers(){try{const e=await fetch(jsObject.location_markers+"?from="+from+"&to="+to,{method:"GET",credentials:"same-origin"}),r=await e.json();markers=r,drawMarkers(r,!1)}catch(e){console.log(e)}}function drawMarkers(e,r=!1){let a=[],l=[],t=0;for(t in e){let r=e[t];if(r.type>=4&&(null===r.data.start_lat&&null!==r.data.end_lat&&(r.data.start_lat=r.data.end_lat),null===r.data.start_lng&&null!==!r.data.end_lng&&(r.data.start_lng=r.data.end_lng),null!==r.data.start_lat&&null!==r.data.start_lng&&(r.lat=r.data.start_lat,r.lng=r.data.start_lng)),null===r.lat||null===r.lng)continue;0==r.type&&a.push([r.lat,r.lng,t]);let n=createMarker(r);if(l.push(n),r.data&&null!==r.data.end_lat&&null!==r.data.end_lng&&r.data.start_lat!==r.data.end_lat&&r.data.start_lng!==r.data.end_lng){r.lat=r.data.end_lat,r.lng=r.data.end_lng,r.acc=r.data.end_acc;let e=createMarker(r);if(5==r.type)if(r.isCarrental)e.bindPopup(n.getPopup());else if(r.isTrain){let r=[],a=calculateMidPoint(n,e),l=quadraticBezierPoints(n,a,e);r[0]=L.polyline(l,{color:"black",weight:"5"}).bindPopup(n.getPopup()),r[1]=L.polyline(l,{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(n.getPopup()),r[2]=L.polyline(l,{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(r)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(r.isPlane){let r=calculateMidPoint(n,e),a=quadraticBezierPoints(n,r,e),l=L.polyline(a,{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(n.getPopup());layerTrips.addLayer(l),layerTrips.removeLayer(e)}else if(r.isCar){let r=[],a=calculateMidPoint(n,e),l=quadraticBezierPoints(n,a,e);r[0]=L.polyline(l,{color:"gray",weight:"5"}).bindPopup(n.getPopup()),r[1]=L.polyline(l,{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(r)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(r.isShip){let r=calculateMidPoint(n,e),a=quadraticBezierPoints(n,r,e),l=L.polyline(a,{color:"blue",weight:"5",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup());layerTrips.addLayer(l),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}l.push(e)}}if(r?(layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers)):(layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters)),mymap.addLayer(layerLocation),mymap.addLayer(layerFinances),mymap.addLayer(layerCars),mymap.addLayer(layerSplittedBills),mymap.addLayer(layerTimesheets),mymap.addLayer(layerTrips),l.length>0){var n=new L.featureGroup(l);mymap.fitBounds(n.getBounds())}var s=L.polyline(a);layerDirections.addLayer(s),r||clusterToggleLayer.addTo(mymap),(controlLayer=L.control.layers(null,null,{collapsed:!1})).addOverlay(clusterToggleLayer,"<span id='toggleClustering'>"+document.getElementById("iconClustering").innerHTML+"</span>"),controlLayer.addOverlay(layerLocation,"<span id='layerLocation'>"+document.getElementById("iconLocation").innerHTML+"</span>"),controlLayer.addOverlay(layerFinances,"<span id='layerFinances'>"+document.getElementById("iconFinances").innerHTML+"</span>"),controlLayer.addOverlay(layerCars,"<span id='layerCars'>"+document.getElementById("iconCars").innerHTML+"</span>"),controlLayer.addOverlay(layerSplittedBills,"<span id='layerSplittedBills'>"+document.getElementById("iconSplittedBills").innerHTML+"</span>"),controlLayer.addOverlay(layerTimesheets,"<span id='layerTimesheets'>"+document.getElementById("iconTimesheets").innerHTML+"</span>"),controlLayer.addOverlay(layerTrips,"<span id='layerTrips'>"+document.getElementById("iconTrips").innerHTML+"</span>"),controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),controlLayer.addTo(mymap),circleLayer.addTo(mymap)}mymap.on("zoom",(function(){removeCircleLayer()})),getMarkers(),mymap.on("overlayremove",(function(e){e.layer===layerLocation&&(controlLayer.removeLayer(layerDirections),setTimeout((function(){mymap.removeLayer(layerDirections)}),10)),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationClusters),layerFinances.removeLayer(layerFinancesClusters),layerCars.removeLayer(layerCarsClusters),layerSplittedBills.removeLayer(layerSplittedBillsClusters),layerTimesheets.removeLayer(layerTimesheetsClusters),layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers))})),mymap.on("overlayadd",(function(e){e.layer!==layerLocation||mymap.hasLayer(layerDirections)||controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationMarkers),layerFinances.removeLayer(layerFinancesMarkers),layerCars.removeLayer(layerCarsMarkers),layerSplittedBills.removeLayer(layerSplittedBillsMarkers),layerTimesheets.removeLayer(layerTimesheetsMarkers),layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters))})),mymap.on("movestart zoomstart",(function(e){isMapMove=!0})),mymap.on("moveend zoomend",(function(e){isMapMove=!1}));var lc=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0}});mymap.addControl(lc);let locationFilter=document.getElementById("show-filter");function createClusterIcon(e,r){var a=e.getChildCount();return new L.DivIcon({html:"<div><span>"+a+"</span></div>",className:"marker-cluster "+r,iconSize:new L.Point(40,40)})}function addCircleLayer(e,r,a,l){let t={opacity:.5,radius:a,weight:5,color:l},n=L.circle([e,r],t),s={weight:10,color:l},i=L.polygon([[e,r]],s);circleLayer.addLayer(n),circleLayer.addLayer(i)}function removeCircleLayer(){circleLayer.clearLayers()}function createMarker(e){var r=e.dt+"<br/>",a="";e.acc>0&&(a=lang.accuracy+" : "+e.acc+" m<br/>");var l='<a href="#" data-lat="'+e.lat+'" data-lng="'+e.lng+'" class="btn-get-address">'+lang.address+"</a>",t=e.steps>0?lang.steps+": "+e.steps+"<br/>":"",n='<br/><br/><a href="#" data-url="'+jsObject.delete_marker_url+e.id+'" class="btn-delete">'+lang.delete_text+"</a>";let s="";s=e.popup?e.popup:r+a+t+l;let i={},o="#3388ff";switch(e.type){case 0:i.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconLocation").innerHTML}),s+=n;break;case 1:i.icon=L.ExtraMarkers.icon({markerColor:"green",shape:"circle",innerHTML:document.getElementById("iconFinances").innerHTML}),o="green",s+="<br/><br/><strong>"+e.description+" - "+e.value+" "+i18n.currency+"</strong>";break;case 2:i.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconCars").innerHTML}),o="yellow",s+="<br/><br/><strong>"+(0==e.description?lang.car_refuel:lang.car_service)+"</strong>";break;case 3:i.icon=L.ExtraMarkers.icon({markerColor:"orange",shape:"circle",innerHTML:document.getElementById("iconSplittedBills").innerHTML}),o="orange",s+="<br/><br/><strong>"+e.description+"</strong>";break;case 4:i.icon=L.ExtraMarkers.icon({markerColor:"pink",shape:"circle",innerHTML:document.getElementById("iconTimesheets").innerHTML}),o="pink";break;case 5:e.isCarrental?i.icon=L.ExtraMarkers.icon({markerColor:"red",shape:"circle",innerHTML:document.getElementById("iconCarRentals").innerHTML}):e.isHotel?i.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconHotels").innerHTML}):e.isEvent?i.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconEvents").innerHTML}):e.isPlane&&(i.icon=L.ExtraMarkers.icon({markerColor:"black",shape:"circle",innerHTML:document.getElementById("iconPlanes").innerHTML}))}var c=L.marker([e.lat,e.lng],i);switch(c.acc>0&&(c.on("mouseover",(function(e){addCircleLayer(c.lat,c.lng,c.acc,o)})),c.on("mouseout",(function(e){removeCircleLayer()})),c.on("popupopen",(function(e){addCircleLayer(c.lat,c.lng,c.acc,o)})),c.on("popupclose",(function(e){removeCircleLayer()}))),e.type){case 0:layerLocationMarkers.addLayer(c),layerLocationClusters.addLayer(c);break;case 1:layerFinancesMarkers.addLayer(c),layerFinancesClusters.addLayer(c);break;case 2:layerCarsMarkers.addLayer(c),layerCarsClusters.addLayer(c);break;case 3:layerSplittedBillsMarkers.addLayer(c),layerSplittedBillsClusters.addLayer(c);break;case 4:layerTimesheetsMarkers.addLayer(c),layerTimesheetsClusters.addLayer(c);break;case 5:layerTrips.addLayer(c)}return c.bindPopup(s),c}null!==locationFilter&&locationFilter.addEventListener("click",(function(e){e.preventDefault();let r=document.getElementById("search-form");r.style.height=r.scrollHeight+"px",r.classList.toggle("collapsed"),locationFilter.classList.toggle("hiddenSearch")}));