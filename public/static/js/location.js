"use strict";const detailsModal=document.getElementById("details-modal"),loadingOverlay=document.getElementById("loading-overlay");var mymap=L.map("mapid").setView([default_location.lat,default_location.lng],default_location.zoom);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);var circleLayer=new L.LayerGroup;let markers=[];var clusterToggleLayer=new L.LayerGroup;let layerLocation=new L.LayerGroup,layerFinances=new L.LayerGroup,layerCars=new L.LayerGroup,layerSplittedBills=new L.LayerGroup,layerTimesheets=new L.LayerGroup,layerTrips=new L.LayerGroup,layerDirections=new L.LayerGroup,layerLocationMarkers=new L.LayerGroup,layerFinancesMarkers=new L.LayerGroup,layerCarsMarkers=new L.LayerGroup,layerSplittedBillsMarkers=new L.LayerGroup,layerTimesheetsMarkers=new L.LayerGroup,layerLocationClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"location")},maxClusterRadius:50}),layerFinancesClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"finances")},maxClusterRadius:50}),layerCarsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"cars")},maxClusterRadius:50}),layerSplittedBillsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"splittedbills")},maxClusterRadius:50}),layerTimesheetsClusters=L.markerClusterGroup({iconCreateFunction:function(e){return createClusterIcon(e,"timesheets")},maxClusterRadius:50}),controlLayer=L.control.layers(null,null,{collapsed:!1});controlLayer.addOverlay(clusterToggleLayer,"<span id='toggleClustering'>"+document.getElementById("iconClustering").innerHTML+"</span>"),controlLayer.addOverlay(layerLocation,"<span id='layerLocation'>"+document.getElementById("iconLocation").innerHTML+"</span>"),controlLayer.addOverlay(layerFinances,"<span id='layerFinances'>"+document.getElementById("iconFinances").innerHTML+"</span>"),controlLayer.addOverlay(layerCars,"<span id='layerCars'>"+document.getElementById("iconCars").innerHTML+"</span>"),controlLayer.addOverlay(layerSplittedBills,"<span id='layerSplittedBills'>"+document.getElementById("iconSplittedBills").innerHTML+"</span>"),controlLayer.addOverlay(layerTimesheets,"<span id='layerTimesheets'>"+document.getElementById("iconTimesheets").innerHTML+"</span>"),controlLayer.addOverlay(layerTrips,"<span id='layerTrips'>"+document.getElementById("iconTrips").innerHTML+"</span>"),controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),controlLayer.addTo(mymap),circleLayer.addTo(mymap),mymap.addLayer(layerLocation),mymap.addLayer(layerFinances),mymap.addLayer(layerCars),mymap.addLayer(layerSplittedBills),mymap.addLayer(layerTimesheets),mymap.addLayer(layerTrips),mymap.on("zoom",(function(){removeCircleLayer()}));let fitBounds=!0;async function getMarkersInDateRange(){try{loadingOverlay.classList.remove("hidden");const e=document.getElementById("inputStart").value,a=document.getElementById("inputEnd").value,r=await fetch(jsObject.location_markers+"?from="+e+"&to="+a,{method:"GET",credentials:"same-origin"}),t=await r.json();drawMarkers(t.markers,!1),addRouteDetails(t.count),loadingOverlay.classList.add("hidden")}catch(e){console.log(e)}}async function getMarkersInBounds(e,a,r,t){try{loadingOverlay.classList.remove("hidden");const l=await fetch(`${jsObject.location_markers}?minLat=${e}&maxLat=${a}&minLng=${r}&maxLng=${t}`,{method:"GET",credentials:"same-origin"}),n=await l.json();drawMarkers(n.markers,!1),addRouteDetails(n.count),loadingOverlay.classList.add("hidden")}catch(e){console.log(e)}}function drawMarkers(e,a=!1){layerLocation.clearLayers(),layerLocationClusters.clearLayers(),layerLocationMarkers.clearLayers(),layerFinances.clearLayers(),layerFinancesClusters.clearLayers(),layerFinancesMarkers.clearLayers(),layerCars.clearLayers(),layerCarsClusters.clearLayers(),layerCarsMarkers.clearLayers(),layerSplittedBills.clearLayers(),layerSplittedBillsClusters.clearLayers(),layerSplittedBillsMarkers.clearLayers(),layerTimesheets.clearLayers(),layerTimesheetsMarkers.clearLayers(),layerTimesheetsClusters.clearLayers(),layerDirections.clearLayers();let r=[],t=[],l=0;for(l in e){let a=e[l];if(a.type>=4&&(null===a.data.start_lat&&null!==a.data.end_lat&&(a.data.start_lat=a.data.end_lat),null===a.data.start_lng&&null!==!a.data.end_lng&&(a.data.start_lng=a.data.end_lng),null!==a.data.start_lat&&null!==a.data.start_lng&&(a.lat=a.data.start_lat,a.lng=a.data.start_lng)),null===a.lat||null===a.lng)continue;0==a.type&&r.push([a.lat,a.lng,l]);let n=createMarker(a);if(t.push(n),a.data&&null!==a.data.end_lat&&null!==a.data.end_lng&&a.data.start_lat!==a.data.end_lat&&a.data.start_lng!==a.data.end_lng){a.lat=a.data.end_lat,a.lng=a.data.end_lng,a.acc=a.data.end_acc;let e=createMarker(a);if(5==a.type)if(a.isCarrental)e.bindPopup(n.getPopup());else if(a.isTrain){let a=[],r=calculateMidPoint(n,e),t=quadraticBezierPoints(n,r,e);a[0]=L.polyline(t,{color:"black",weight:"5"}).bindPopup(n.getPopup()),a[1]=L.polyline(t,{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(n.getPopup()),a[2]=L.polyline(t,{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(a)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(a.isPlane){let a=calculateMidPoint(n,e),r=quadraticBezierPoints(n,a,e),t=L.polyline(r,{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(n.getPopup());layerTrips.addLayer(t),layerTrips.removeLayer(e)}else if(a.isCar){let a=[],r=calculateMidPoint(n,e),t=quadraticBezierPoints(n,r,e);a[0]=L.polyline(t,{color:"gray",weight:"5"}).bindPopup(n.getPopup()),a[1]=L.polyline(t,{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup()),layerTrips.addLayer(L.layerGroup(a)),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}else if(a.isShip){let a=calculateMidPoint(n,e),r=quadraticBezierPoints(n,a,e),t=L.polyline(r,{color:"blue",weight:"5",dashArray:"10, 10",dashOffset:"0"}).bindPopup(n.getPopup());layerTrips.addLayer(t),layerTrips.removeLayer(n),layerTrips.removeLayer(e)}t.push(e)}}if(a?(layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers)):(layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters)),t.length>0&&fitBounds){var n=new L.featureGroup(t);mymap.fitBounds(n.getBounds())}var s=L.polyline(r);layerDirections.addLayer(s),a||clusterToggleLayer.addTo(mymap)}document.addEventListener("DOMContentLoaded",(async function(){const e=new URLSearchParams(window.location.search);if(e.has("minLat")&&e.has("minLng")&&e.has("maxLat")&&e.has("maxLng")){const a=parseFloat(e.get("minLat")),r=parseFloat(e.get("minLng")),t=parseFloat(e.get("maxLat")),l=parseFloat(e.get("maxLng")),n=L.latLngBounds([a,r],[t,l]);mymap.fitBounds(n),await getMarkersInBounds(a,t,r,l),fitBounds=!1,mymap.on("moveend",(async function(){markers=[];var e=mymap.getBounds();await getMarkersInBounds(e.getSouthWest().lat,e.getNorthEast().lat,e.getSouthWest().lng,e.getNorthEast().lng,!1)}))}else await getMarkersInDateRange()})),mymap.on("overlayremove",(function(e){e.layer===layerLocation&&(controlLayer.removeLayer(layerDirections),setTimeout((function(){mymap.removeLayer(layerDirections)}),10)),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationClusters),layerFinances.removeLayer(layerFinancesClusters),layerCars.removeLayer(layerCarsClusters),layerSplittedBills.removeLayer(layerSplittedBillsClusters),layerTimesheets.removeLayer(layerTimesheetsClusters),layerLocation.addLayer(layerLocationMarkers),layerFinances.addLayer(layerFinancesMarkers),layerCars.addLayer(layerCarsMarkers),layerSplittedBills.addLayer(layerSplittedBillsMarkers),layerTimesheets.addLayer(layerTimesheetsMarkers))})),mymap.on("overlayadd",(function(e){e.layer!==layerLocation||mymap.hasLayer(layerDirections)||controlLayer.addOverlay(layerDirections,"<span id='layerDirections'>"+document.getElementById("iconDirections").innerHTML+"</span>"),e.layer===clusterToggleLayer&&(layerLocation.removeLayer(layerLocationMarkers),layerFinances.removeLayer(layerFinancesMarkers),layerCars.removeLayer(layerCarsMarkers),layerSplittedBills.removeLayer(layerSplittedBillsMarkers),layerTimesheets.removeLayer(layerTimesheetsMarkers),layerLocation.addLayer(layerLocationClusters),layerFinances.addLayer(layerFinancesClusters),layerCars.addLayer(layerCarsClusters),layerSplittedBills.addLayer(layerSplittedBillsClusters),layerTimesheets.addLayer(layerTimesheetsClusters))})),mymap.on("movestart zoomstart",(function(e){isMapMove=!0})),mymap.on("moveend zoomend",(function(e){isMapMove=!1}));var lc=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0}});mymap.addControl(lc);let locationFilter=document.getElementById("show-filter");function createClusterIcon(e,a){var r=e.getChildCount();return new L.DivIcon({html:"<div><span>"+r+"</span></div>",className:"marker-cluster "+a,iconSize:new L.Point(40,40)})}function addCircleLayer(e,a,r,t){let l={opacity:.5,radius:r,weight:5,color:t},n=L.circle([e,a],l),s={weight:10,color:t},o=L.polygon([[e,a]],s);circleLayer.addLayer(n),circleLayer.addLayer(o)}function removeCircleLayer(){circleLayer.clearLayers()}function createMarker(e){var a=e.dt+"<br/>",r="";e.acc>0&&(r=lang.accuracy+" : "+e.acc+" m<br/>");var t='<a href="#" data-lat="'+e.lat+'" data-lng="'+e.lng+'" class="btn-get-address">'+lang.address+"</a>",l=e.steps>0?lang.steps+": "+e.steps+"<br/>":"",n='<br/><br/><a href="#" data-url="'+jsObject.delete_marker_url+e.id+'" class="btn-delete">'+lang.delete_text+"</a>";let s="";s=e.popup?e.popup:a+r+l+t;let o={},i="#3388ff";switch(e.type){case 0:o.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconLocation").innerHTML}),s+=n;break;case 1:o.icon=L.ExtraMarkers.icon({markerColor:"green",shape:"circle",innerHTML:document.getElementById("iconFinances").innerHTML}),i="green",s+="<br/><br/><strong>"+e.description+" - "+e.value+" "+i18n.currency+"</strong>";break;case 2:o.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconCars").innerHTML}),i="yellow",s+="<br/><br/><strong>"+(0==e.description?lang.car_refuel:lang.car_service)+"</strong>";break;case 3:o.icon=L.ExtraMarkers.icon({markerColor:"orange",shape:"circle",innerHTML:document.getElementById("iconSplittedBills").innerHTML}),i="orange",s+="<br/><br/><strong>"+e.description+"</strong>";break;case 4:o.icon=L.ExtraMarkers.icon({markerColor:"pink",shape:"circle",innerHTML:document.getElementById("iconTimesheets").innerHTML}),i="pink";break;case 5:e.isCarrental?o.icon=L.ExtraMarkers.icon({markerColor:"red",shape:"circle",innerHTML:document.getElementById("iconCarRentals").innerHTML}):e.isHotel?o.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconHotels").innerHTML}):e.isEvent?o.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconEvents").innerHTML}):e.isPlane&&(o.icon=L.ExtraMarkers.icon({markerColor:"black",shape:"circle",innerHTML:document.getElementById("iconPlanes").innerHTML}))}var c=L.marker([e.lat,e.lng],o);switch(e.acc>0&&(c.on("mouseover",(function(a){addCircleLayer(e.lat,e.lng,e.acc,i)})),c.on("mouseout",(function(e){removeCircleLayer()})),c.on("popupopen",(function(a){addCircleLayer(e.lat,e.lng,e.acc,i)})),c.on("popupclose",(function(e){removeCircleLayer()}))),e.type){case 0:layerLocationMarkers.addLayer(c),layerLocationClusters.addLayer(c);break;case 1:layerFinancesMarkers.addLayer(c),layerFinancesClusters.addLayer(c);break;case 2:layerCarsMarkers.addLayer(c),layerCarsClusters.addLayer(c);break;case 3:layerSplittedBillsMarkers.addLayer(c),layerSplittedBillsClusters.addLayer(c);break;case 4:layerTimesheetsMarkers.addLayer(c),layerTimesheetsClusters.addLayer(c);break;case 5:layerTrips.addLayer(c)}return c.bindPopup(s),c}function addRouteDetails(e){let a=detailsModal.querySelector(".modal-content");a.innerHTML="";for(const[r,t]of Object.entries(e)){if(!t||Array.isArray(t)&&0===t.length||"object"==typeof t&&0===Object.keys(t).length)continue;const e=Object.values(t).reduce(((e,a)=>e+Number(a)),0),l=document.createElement("details");l.classList.add("dt-wrapper");const n=document.createElement("summary"),s=lang[`${r}_module_name`]??r;n.textContent=`${s} (${e})`,l.appendChild(n);const o=document.createElement("table");o.classList.add("table","table-hover","small","dt-table");const i=document.createElement("thead"),c=document.createElement("tr"),d=document.createElement("th");d.textContent=lang.date;const y=document.createElement("th");y.textContent=lang.count,c.appendChild(d),c.appendChild(y),i.appendChild(c),o.appendChild(i);const u=document.createElement("tbody");for(const[e,a]of Object.entries(t)){const r=document.createElement("tr"),t=document.createElement("td");t.textContent=e;const l=document.createElement("td");l.textContent=a,r.appendChild(t),r.appendChild(l),u.appendChild(r)}o.appendChild(u),l.appendChild(o),a.appendChild(l)}}null!==locationFilter&&locationFilter.addEventListener("click",(function(e){e.preventDefault();let a=document.getElementById("search-form");a.style.height=a.scrollHeight+"px",a.classList.toggle("collapsed"),locationFilter.classList.toggle("hiddenSearch")})),document.getElementById("show-details-modal").addEventListener("click",(function(e){detailsModal.classList.add("visible"),detailsModal.focus()})),document.getElementById("modal-close-btn").addEventListener("click",(function(e){detailsModal.classList.remove("visible")}));const filterMapBtn=document.getElementById("filter-map");filterMapBtn&&filterMapBtn.addEventListener("click",(function(e){const a=mymap.getBounds(),r=new URLSearchParams({minLat:a.getSouthWest().lat.toFixed(6),minLng:a.getSouthWest().lng.toFixed(6),maxLat:a.getNorthEast().lat.toFixed(6),maxLng:a.getNorthEast().lng.toFixed(6)});window.location.href=`?${r.toString()}`}));