"use strict";const stepsList=document.querySelector("#recipes_steps"),addStepBtn=document.querySelector("#add-step-btn"),step_dummy=document.querySelector("#templates .step-dummy"),ingredient_dummy=document.querySelector("#templates .step-ingredient-dummy");function createUniqueID(){return Math.floor(Math.random()*Date.now())}function updateStepFields(){stepsList.querySelectorAll(".step:not(.step-dummy)").forEach((function(e,t){e.dataset.position=t,e.querySelectorAll("input, textarea, select").forEach((function(e){e.setAttribute("name",e.name.replace(/steps\[[^\]]*\]/,"steps["+t+"]"))}))}))}function createSortableSteps(e){new Sortable(e,{scroll:!0,scrollSensitivity:100,draggable:".step",swapThreshold:.9,fallbackOnBody:!0,handle:".step-handle",ghostClass:"step-drag",onUpdate:function(e){updateStepFields()},onStart:function(e){document.body.classList.add("sortable-select")},onEnd:function(e){document.body.classList.remove("sortable-select"),e.item.scrollIntoView()}})}function updateIngredientFields(e){e.querySelectorAll(".step-ingredient").forEach((function(e,t){e.querySelectorAll("input, textarea, select").forEach((function(e){e.setAttribute("name",e.name.replace(/\[ingredients\]\[[^\]]*\]/,"[ingredients]["+t+"]"))}))}))}addStepBtn.addEventListener("click",(function(e){e.preventDefault();let t=stepsList.querySelectorAll(".step").length,n=step_dummy.cloneNode(!0);n.classList.remove("hidden"),n.classList.remove("step-dummy"),n.dataset.idx=t,n.querySelector(".step_name").value="Schritt "+(t+1),n.querySelectorAll("input, textarea, select").forEach((function(e,n){e.setAttribute("name",e.name.replace("dummy",t)),e.removeAttribute("disabled")})),createSortableIngredients(n.querySelector(".step-ingredients")),stepsList.appendChild(n)})),document.addEventListener("click",(function(e){let t=e.target.closest(".add-ingredient-btn"),n=e.target.closest(".step-minus"),s=e.target.closest(".remove-ingredient"),r=e.target.closest(".step");if(t){e.preventDefault(),console.log("add ingredient");let t=r.dataset.idx,n=r.querySelector(".step-ingredients"),s=n.querySelectorAll(".step-ingredient").length,i=ingredient_dummy.cloneNode(!0);i.classList.remove("step-ingredient-dummy"),i.querySelectorAll("input, textarea, select").forEach((function(e,n){e.setAttribute("name",e.name.replace("dummy_step",t).replace("dummy_ingredient",s)),e.removeAttribute("disabled")})),n.appendChild(i);let l=createUniqueID(),a=i.querySelector(".step-ingredient-select");a.id=a.id+"-"+l,a.parentElement.id=a.parentElement.id+"-"+l,a.previousElementSibling.id=a.previousElementSibling.id+"-"+l,createChoiceIngredients(a)}n&&(e.preventDefault(),n.parentElement.parentElement.remove(),updateStepFields()),s&&(e.preventDefault(),s.parentElement.remove(),updateIngredientFields(r))})),createSortableSteps(stepsList);const stepsIngredients=stepsList.querySelectorAll(".step .step-ingredients");function createSortableIngredients(e){new Sortable(e,{draggable:".step-ingredient",swapThreshold:.9,fallbackOnBody:!0,handle:".ingredient-handle",ghostClass:"ingredient-drag",onUpdate:function(t){updateIngredientFields(e.closest(".step"))}})}async function createChoiceIngredients(e){new autoComplete({data:{src:async()=>{try{let t=await fetch(jsObject.groceries_search+"?query="+e.value+"&food=1",{method:"GET",credentials:"same-origin"}),n=await t.json();return"error"!==n.status?n.data:[]}catch(e){return[]}},keys:["text"],cache:!1},resultsList:{class:"groceries-suggestion",destination:"#"+e.parentElement.id,position:"beforeend",tag:"ul",noResults:!0,maxResults:10},resultItem:{highlight:!0},trigger:e=>e.length>0,threshold:1,debounce:100,selector:"#"+e.id,wrapper:!1}),e.addEventListener("selection",(function(t){const n=t.detail;e.value=n.selection.value.name;let s=e.closest(".step-ingredient").querySelector(".step-ingredient-unit"),r=e.closest(".step-ingredient").querySelector(".step-ingredient-id");""==s.value&&(s.value=n.selection.value.unit),r.value=n.selection.value.id})),e.addEventListener("results",(function(e){console.log(e.detail.results.length),0==e.detail.results.length?e.target.nextElementSibling.classList.add("hidden"):e.target.nextElementSibling.classList.remove("hidden")})),e.addEventListener("close",(function(e){e.target.nextElementSibling.classList.add("hidden")}))}stepsIngredients.forEach((function(e,t){createSortableIngredients(e);e.querySelectorAll(".step-ingredient-select").forEach((function(e,t){createChoiceIngredients(e)}))}));