"use strict";const recipesList=document.querySelector("#recipes_list"),loadingIconRecipes=document.querySelector("#loadingIconRecipes"),filterSearchRecipes=document.getElementById("filterSearchRecipes"),noticeModal=document.getElementById("notice-modal"),noticeModalClose=document.getElementById("modal-close-btn");document.addEventListener("click",(async function(e){let t=e.target.closest(".minus"),n=e.target.closest(".create-notice");if(t){e.preventDefault();let n=t.parentElement.parentElement,a={mealplan_recipe_id:n.dataset.id};try{let e=await getCSRFToken(!0);a.csrf_name=e.csrf_name,a.csrf_value=e.csrf_value;let t=await fetch(jsObject.recipes_mealplan_remove_recipe,{method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});(await t.json()).is_deleted&&n.remove()}catch(e){console.log(e)}}if(n){e.preventDefault();let t=n.parentElement.querySelector(".recipes-target").dataset.date;noticeModal.querySelector("input[name='date']").value=t,freeze(),noticeModal.showModal()}}));const recipesTargets=document.querySelectorAll(".recipes-target");function createSortable(e,t){if(document.querySelector(".mealplan-list-settings")){let n={group:{name:"recipes"},swapThreshold:.5,fallbackOnBody:!0,handle:".handle",dataIdAttr:"data-id",onUpdate:function(e){move_recipe(e)},onAdd:function(e){move_recipe(e)}};t&&(n.group.pull="clone",n.group.put=!1),new Sortable(e,n)}}function move_recipe(e){let t=e.to.dataset.date,n=e.item.dataset.recipe,a=e.item.dataset.id;createRecipeEntry(e.item,n,t,e.newDraggableIndex,a,null)}async function createRecipeEntry(e,t,n,a,c,i){var o={recipe:t,date:n,position:a,id:c,notice:i};try{const t=await getCSRFToken();o.csrf_name=t.csrf_name,o.csrf_value=t.csrf_value;const n=await fetch(jsObject.recipes_mealplan_move_recipe,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),a=await n.json();if("success"===a.status){let t=a.id;e.dataset.id=t,e.querySelector(".minus").classList.remove("hidden")}else e.remove()}catch(e){if(console.log(e),isOffline(e)){let e=new URLSearchParams(o).toString();saveDataWhenOffline(jsObject.recipes_mealplan_move_recipe,"POST",e)}}}async function getRecipes(){let e=filterSearchRecipes?filterSearchRecipes.value:"",t=jsObject.recipes_get_mealplan+"?type=mealplan&count=5&start=0&query="+e;loadingIconRecipes.classList.remove("hidden");try{const e=await fetch(t,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}),n=await e.json();if(recipesList.innerHTML="","error"!==n.status){if(loadingIconRecipes.classList.add("hidden"),parseInt(n.count)>0)recipesList.insertAdjacentHTML("beforeend",n.data),createSortable(recipesList,!0);else{let e=document.createElement("p");e.innerHTML=lang.nothing_found,recipesList.innerHTML="",recipesList.appendChild(e)}}}catch(e){console.log(e)}}recipesTargets.forEach((function(e,t){createSortable(e,!1)})),getRecipes(),filterSearchRecipes&&filterSearchRecipes.addEventListener("keyup",(function(e){e.preventDefault(),getRecipes()})),noticeModalClose&&noticeModalClose.addEventListener("click",(function(e){noticeModal.close(),noticeModal.querySelector("form").reset(),unfreeze()})),noticeModal.querySelector("form").addEventListener("submit",(function(e){e.preventDefault(),document.getElementById("loading-overlay").classList.remove("hidden");let t=noticeModal.querySelector('input[name="notice"]').value,n=noticeModal.querySelector('input[name="date"]').value,a=document.querySelector(".recipes-target[data-date='"+n+"']"),c=document.querySelector("#templates .mealplan-recipe").cloneNode(!0);c.querySelector("h3.title").innerHTML=t,a.appendChild(c),createRecipeEntry(c,null,n,999,null,t).then((function(){document.getElementById("loading-overlay").classList.add("hidden"),unfreeze(),noticeModal.querySelector("form").reset(),noticeModal.close()}))}));