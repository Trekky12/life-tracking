"use strict";const alert=document.querySelector("#passwordAlert"),alertDetail=alert.querySelector("#alertDetail"),saveBtn=document.querySelector("button#save_notice_password"),oldPassword=document.querySelector("input#inputOldPassword"),newPassword1=document.querySelector("input#inputNewPassword1"),newPassword2=document.querySelector("input#inputNewPassword2"),forgotPassword=document.querySelector("a#forgotPassword"),recoveryCodeWrapper=document.querySelector("#recoveryCodeWrapper"),recoveryCodeInput=document.querySelector("textarea#inputRecoveryCode");async function setPassword(){let e=await getEncryptionParameters();const t=e.data.iterations,a=e.data.testMessageEncryptedWithKEK,s=e.data.testMessageEncryptedWithRecoveryKey;let r,o;if(""!=oldPassword.value&&a){console.log("Update password from old password");let a=base64_to_buf(e.data.salt);const s=await createKeyMaterial(oldPassword.value),o=await deriveKEK(s,a,t);r=await getRawMasterKeyFromKEK(o,e.data.testMessageEncryptedWithKEK,e.data.masterKeyEncryptedWithKEK)}else if(""!=recoveryCodeInput.value&&24==recoveryCodeInput.value.split(" ").length&&s){console.log("update password from recovery code");const t=bip39.mnemonicToEntropy(recoveryCodeInput.value),a=fromHexString(t),s=await createKeyObject(a),o=e.data.masterKeyEncryptedWithRecoveryKey,d=await decryptData(s,o);r=base64_to_buf(d)}else{if(a)throw"Unknown error";console.log("No password set so set new password"),r=window.crypto.getRandomValues(new Uint8Array(32))}o=await createKeyObject(r);let d={};if(!s){let e=window.crypto.getRandomValues(new Uint8Array(32)),t=await createKeyObject(e),a=await encryptData(t,buff_to_base64(r));d.masterKeyEncryptedWithRecoveryKey=a;let s=await encryptData(o,buff_to_base64(e));d.recoveryKeyEncryptedWithMasterKey=s;const n=await encryptData(t,"test");d.testMessageEncryptedWithRecoveryKey=n}let n=window.crypto.getRandomValues(new Uint8Array(16));d.salt=buff_to_base64(n);const i=await createKeyMaterial(newPassword1.value);let l=t;d.iterations=l;const c=await deriveKEK(i,n,l),u=await encryptData(c,"test");d.testMessageEncryptedWithKEK=u;const w=await encryptData(c,buff_to_base64(r));d.masterKeyEncryptedWithKEK=w;let y=await getCSRFToken();d.csrf_name=y.csrf_name,d.csrf_value=y.csrf_value;let p=await fetch(jsObject.timesheets_notice_params_save,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if("success"!==(await p.json()).status)throw console.error("Unable to save parameters"),"Error saving parameters";return!0}window.crypto&&window.crypto.subtle||(alertDetail.innerHTML=lang.decrypt_error,alert.classList.remove("hidden"),alert.classList.add("danger"),document.querySelector("input#inputSetPassword").disabled=!0,document.querySelector("input#inputSetPassword2").disabled=!0),saveBtn.addEventListener("click",(async function(e){if(e.preventDefault(),alertDetail.innerHTML="",alert.classList.add("hidden"),alert.classList.remove("danger"),alert.classList.remove("success"),oldPassword.getAttribute("disabled")||""!=oldPassword.value||""!=recoveryCodeInput.value)if(""!=recoveryCodeInput.value&&24!=recoveryCodeInput.value.split(" ").length)alertDetail.innerHTML=lang.timesheets_recovery_wrong_size,alert.classList.remove("hidden"),alert.classList.add("danger"),alert.classList.remove("success");else if(""==newPassword1.value||""==newPassword2.value||newPassword1.value!==newPassword2.value)alertDetail.innerHTML=lang.timesheets_notice_password_no_match,alert.classList.remove("hidden"),alert.classList.add("danger"),alert.classList.remove("success");else try{await setPassword(),alertDetail.innerHTML=lang.timesheets_notice_password_success,alert.classList.remove("hidden"),alert.classList.remove("danger"),alert.classList.add("success"),oldPassword.parentElement.classList.remove("hidden"),oldPassword.removeAttribute("disabled"),recoveryCodeWrapper.classList.add("hidden"),forgotPassword.classList.remove("hidden")}catch(e){console.log(e),alertDetail.innerHTML=lang.timesheets_notice_password_wrong,alert.classList.remove("hidden"),alert.classList.add("danger"),alert.classList.remove("success")}else alertDetail.innerHTML=lang.timesheets_insert_password_or_recovery,alert.classList.remove("hidden"),alert.classList.add("danger"),alert.classList.remove("success");document.querySelector("form").reset(),loadingWindowOverlay.classList.add("hidden")})),forgotPassword.addEventListener("click",(async function(e){e.preventDefault(),recoveryCodeWrapper.classList.toggle("hidden"),oldPassword.getAttribute("disabled")?oldPassword.removeAttribute("disabled"):oldPassword.setAttribute("disabled",!0)}));