"use strict";const timesheetEncryptionWrapper=document.querySelector("#timesheetEncryptionWrapper");if(!timesheetEncryptionWrapper)throw"No notices here";const timesheetNoticeWrapper=document.querySelector("#timesheetNoticeWrapper"),loadingIconTimesheetNotice=document.querySelector("#loadingIconTimesheetNotice"),timesheetNoticeForm=document.querySelector("#timesheetNoticeForm"),timesheetLastSavedWrapper=document.querySelector("#lastSavedWrapper"),timesheetLastSaved=document.querySelector("#lastSaved"),alertError=document.querySelector("#alertError"),alertErrorDetail=alertError.querySelector("#alertErrorDetail"),projectID=parseInt(timesheetNoticeWrapper.dataset.project);let checkboxHideEmptyNoticeFields=document.getElementById("checkboxHideEmptyNoticeFields");const loadingFilesIcon=document.getElementById("loadingIconFileUpload"),fileInput=document.querySelector("#fileupload");window.crypto&&window.crypto.subtle||(alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),loadingIconTimesheetNotice.classList.add("hidden"),timesheetNoticeForm&&(timesheetNoticeForm.querySelectorAll("textarea, select, input").forEach((function(e){e.disabled=!0})),timesheetNoticeForm.querySelector('button[type="submit"]').classList.add("hidden")));let masterKey,currentNotice=getNoticeData();async function loadData(){const e=await getEncryptionParameters();if(!e.data.testMessageEncryptedWithKEK)return alertErrorDetail.innerHTML=lang.timesheets_no_password_set,alertError.classList.remove("hidden"),void loadingIconTimesheetNotice.classList.add("hidden");if(masterKey=await getMasterKeyFromStoreOrInput(projectID,e),!1===masterKey)return alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),void loadingIconTimesheetNotice.classList.add("hidden");let t=Array.from(timesheetEncryptionWrapper.querySelectorAll(".timesheet-notice"));for(const e of t){let t;try{t=await getNotice(e.dataset)}catch(e){return alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),document.getElementById("loading-overlay").classList.add("hidden"),void loadingIconTimesheetNotice.classList.add("hidden")}if(t){let a=!1;if(IsJsonString(t)&&(t=JSON.parse(t),"notice"in t&&1==t.length?(a=!1,t=t.notice):a=!0),a){for(const[a,n]of Object.entries(t)){let n=t[a],r=e.querySelector('[data-name="'+a+'"]');if(r)r.dataset.saved=1,!r.tagName||"textarea"!==r.tagName.toLowerCase()&&"input"!==r.tagName.toLowerCase()&&"select"!==r.tagName.toLowerCase()?n?r.innerHTML=n.replace(/(?:\r\n|\r|\n)/g,"<br>"):r.parentElement.dataset.empty=1:r.value=n;else{let t=e.dataset.view;if("edit"==t){console.log(a+" not found, appending manually!");const t=document.createElement("div");t.className="timesheet-notice-field";const r=document.createElement("div");r.className="form-group";const i=document.createElement("label");i.setAttribute("for",`input_${a}`),i.innerHTML=a;const o=document.createElement("textarea");o.className="form-control",o.id=`input_${a}`,o.name=a,o.dataset.name=a,o.dataset.default=0,o.dataset.saved=1,o.value=n,r.appendChild(i),r.appendChild(o),t.appendChild(r),e.appendChild(t)}else if("view"==t){console.log(a+" not found, appending manually!");const t=document.createElement("div");t.className="timesheet-notice-field";const r=document.createElement("h4");r.innerHTML=a+":";const i=document.createElement("p");i.className="notice-field",i.dataset.name=a,i.dataset.default=0,i.dataset.saved=1,i.innerHTML=n,t.appendChild(r),t.appendChild(i),e.appendChild(t)}}}e.querySelectorAll('[data-saved="0"]').forEach((function(e){e.parentElement.dataset.empty=1}))}else{let a=e.querySelector('[data-default="1"]');a&&a.tagName&&("textarea"===a.tagName.toLowerCase()||"input"===a.tagName.toLowerCase()||"select"===a.tagName.toLowerCase())?a.value=t:(t?a.innerHTML=t.replace(/(?:\r\n|\r|\n)/g,"<br>"):a.parentElement.dataset.empty=1,e.querySelectorAll('[data-default="0"]').forEach((function(e){e.parentElement.dataset.empty=1})))}}else e.closest(".timesheet-notice-wrapper").dataset.empty=1;checkboxHideEmptyNoticeFields&&checkboxHideEmptyNoticeFields.checked&&document.querySelectorAll('.timesheet-notice-field[data-empty="1"], .timesheet-notice-wrapper[data-empty="1"] .timesheet-notice-field').forEach((function(e){e.classList.add("hidden")}))}let a=Array.from(timesheetEncryptionWrapper.querySelectorAll(".timesheet-files"));for(const e of a)await loadFiles(e);loadingIconTimesheetNotice.classList.add("hidden"),timesheetEncryptionWrapper.classList.remove("hidden")}async function getNotice(e){if(!masterKey)throw console.error("masterKey missing"),"masterKey missing";let t=e.id,a=e.type,n="";"sheet"==a?n=jsObject.timesheets_sheets_notice_data:"customer"==a?n=jsObject.timesheets_customers_notice_data:"project"==a&&(n=jsObject.timesheets_project_notice_data);let r=await fetch(n+"?id="+t,{method:"GET",credentials:"same-origin"}),i=await r.json();if("error"!==i.status&&i.entry){let e,t=i.entry.notice,a=i.entry.encryptedCEK;timesheetLastSavedWrapper&&(timesheetLastSaved?(timesheetLastSaved.innerHTML=moment(i.entry.changedOn).format(i18n.dateformatJS.datetime),timesheetLastSavedWrapper.classList.remove("hidden")):timesheetLastSavedWrapper.classList.add("hidden"));try{const t=await decryptTextData(masterKey,a),n=base64_to_buf(t);e=await createKeyObject(n)}catch(e){throw console.error(`Unable to decrypt CEK - ${e}`),e}if(t)try{let a=await decryptTextData(e,t);return timesheetLastSaved&&(currentNotice=a),a}catch(e){throw console.error(`Unable to decrypt notice - ${e}`),e}}}function getNoticeData(){if(!timesheetNoticeForm)return;let e=Array.from(timesheetNoticeForm.querySelectorAll('input[type="text"], textarea, select')),t={};for(const a of e)a.tagName&&"select"===a.tagName.toLowerCase()?a.selectedIndex>=0&&(t[a.name]=a.options[a.selectedIndex].text):t[a.name]=a.value;return JSON.stringify(t)}async function saveNotice(e=!1){if(!masterKey)return alertErrorDetail.innerHTML=lang.encrypt_error,alertError.classList.remove("hidden"),void document.getElementById("loading-overlay").classList.add("hidden");e||(alertError.classList.add("hidden"),alertErrorDetail.innerHTML="",document.getElementById("loading-overlay").classList.remove("hidden"));let t=getNoticeData();if(e&&currentNotice&&currentNotice===t)return void console.log("No changes, not saving!");let a={};a.is_autosave=e?1:0;const n=window.crypto.getRandomValues(new Uint8Array(32)),r=await createKeyObject(n);a.encryptedCEK=await encryptTextData(masterKey,buff_to_base64(n)),a.notice=await encryptTextData(r,t);try{let n=await getCSRFToken();a.csrf_name=n.csrf_name,a.csrf_value=n.csrf_value;let r=await fetch(timesheetNoticeForm.action,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await r.json();"success"===i.status&&(currentNotice=t,timesheetLastSavedWrapper&&(timesheetLastSaved?(timesheetLastSaved.innerHTML=moment(i.entry.changedOn).format(i18n.dateformatJS.datetime),timesheetLastSavedWrapper.classList.remove("hidden")):timesheetLastSavedWrapper.classList.add("hidden"))),e||("success"===i.status?(allowedReload=!0,window.location.reload(!0)):(document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=a.error,alertError.classList.remove("hidden")))}catch(t){if(console.log(t),!e)if(document.body.classList.contains("offline")){let e=new URLSearchParams(a).toString();saveDataWhenOffline(timesheetNoticeForm.action,timesheetNoticeForm.method,e)}else document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=t,alertError.classList.remove("hidden")}}loadData(),timesheetNoticeForm&&(timesheetNoticeForm.addEventListener("submit",(async function(e){e.preventDefault(),saveNotice(!1)})),setInterval((async function(){saveNotice(!0)}),12e4));let checkboxHideEmptySheets=document.getElementById("checkboxHideEmptySheets");async function loadFiles(e){let t=e.dataset.id;const a=await fetch(jsObject.timesheets_sheets_files+"?id="+t,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/json"}}),n=await a.json();if(0==n.length){const t=e.closest(".timesheet-files-wrapper");t&&(t.classList.add("hidden"),t.dataset.hidden=1,t.dataset.empty=1)}else n.forEach((async function(t){await addFile(e,t)}));fileInput&&fileInput.classList.remove("hidden")}async function addFile(e,t){let a;try{const e=await decryptTextData(masterKey,t.encryptedCEK),n=base64_to_buf(e);a=await createKeyObject(n)}catch(e){throw console.error(`Unable to decrypt CEK - ${e}`),e}try{let n=await decryptData(a,t.data),r=buff_to_base64(n);const i=document.createElement("div");if(i.className="timesheet-notice-file",t.type.startsWith("image/")){const e=document.createElement("img");e.src=`data:${t.type};base64,${r}`,e.alt=t.name,i.appendChild(e)}else{const e=document.createElement("p");e.textContent=t.name,i.appendChild(e)}let o=document.createElement("div");o.className="timesheet-notice-file-icons";let s=document.createElement("a");s.download=t.name;const c=atob(r),d=new Array(c.length);for(let e=0;e<c.length;e++)d[e]=c.charCodeAt(e);const l=new Uint8Array(d),m=new Blob([l],{type:t.type}),p=URL.createObjectURL(m);s.setAttribute("href",p),s.setAttribute("target","_blank");let h=document.createElement("span");if(h.innerHTML=document.getElementById("iconDownload").innerHTML,s.appendChild(h),o.appendChild(s),document.getElementById("iconTrash")){let e=document.createElement("a");e.href="#",e.dataset.url=t.delete,e.className="delete-timesheet-file";let a=document.createElement("span");a.innerHTML=document.getElementById("iconTrash").innerHTML,e.appendChild(a),o.appendChild(e)}i.appendChild(o),e.appendChild(i)}catch(e){throw console.error(`Unable to decrypt file - ${e}`),e}}checkboxHideEmptySheets&&checkboxHideEmptySheets.addEventListener("click",(function(e){document.querySelectorAll('.timesheet-notice-wrapper[data-empty="1"]').forEach((function(e){checkboxHideEmptySheets.checked?(e.classList.add("hidden"),e.dataset.hidden=1):(e.classList.remove("hidden"),e.dataset.hidden=0)})),document.querySelectorAll(".timesheet-wrapper").forEach((function(e){const t=e.querySelector(".timesheet-notice-wrapper"),a=e.querySelector(".timesheet-files-wrapper"),n="1"===t?.dataset.empty,r="1"===a?.dataset.empty;checkboxHideEmptySheets.checked&&n&&r?e.classList.add("hidden"):e.classList.remove("hidden")}))})),checkboxHideEmptyNoticeFields&&checkboxHideEmptyNoticeFields.addEventListener("click",(function(e){document.querySelectorAll('.timesheet-notice-field[data-empty="1"], .timesheet-notice-wrapper[data-empty="1"] .timesheet-notice-field').forEach((function(e){checkboxHideEmptyNoticeFields.checked?e.classList.add("hidden"):e.classList.remove("hidden")}))})),fileInput&&fileInput.addEventListener("change",(async function(e){const t=fileInput.files[0];if(!t)return;if(!masterKey)return;let a=await getCSRFToken();loadingFilesIcon.classList.remove("hidden");const n=await t.arrayBuffer(),r=window.crypto.getRandomValues(new Uint8Array(32)),i=await createKeyObject(r),o=await encryptTextData(masterKey,buff_to_base64(r)),s=await encryptBinaryData(i,n),c=new Blob([s],{type:"application/octet-stream"}),d=new FormData;d.append("file",c,t.name),d.append("type",t.type),d.append("encryptedCEK",o),d.append("csrf_name",a.csrf_name),d.append("csrf_value",a.csrf_value);try{const e=await fetch(fileInput.dataset.url,{method:"POST",credentials:"same-origin",body:d}),t=await e.json();loadingFilesIcon.classList.add("hidden"),"success"===t.status&&(fileInput.value="",addFile(fileInput.closest("#timesheetFilesWrapper").querySelector(".timesheet-files"),t))}catch(e){loadingFilesIcon.classList.add("hidden"),console.log(e)}})),document.addEventListener("click",(async function(e){let t=e.target.closest(".delete-timesheet-file");if(t){e.preventDefault();let a=lang.really_delete;if(!await confirmDialog(a,null))return loadingWindowOverlay.classList.add("hidden"),!1;let n=t.dataset.url;loadingFilesIcon.classList.remove("hidden");try{let e=await getCSRFToken(!0),a={};a.csrf_name=e.csrf_name,a.csrf_value=e.csrf_value;let r=await fetch(n,{method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});(await r.json()).is_deleted&&t.parentElement.parentElement.remove()}catch(e){console.log(e)}loadingFilesIcon.classList.add("hidden")}}));