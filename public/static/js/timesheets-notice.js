"use strict";const timesheetNoticeWrapper=document.querySelector("#timesheetNoticeWrapper"),loadingIconTimesheetNotice=document.querySelector("#loadingIconTimesheetNotice"),timesheetNoticeForm=document.querySelector("#timesheetNoticeForm"),timesheetLastSavedWrapper=document.querySelector("#lastSavedWrapper"),timesheetLastSaved=document.querySelector("#lastSaved"),alertError=document.querySelector("#alertError"),alertErrorDetail=alertError.querySelector("#alertErrorDetail"),projectID=parseInt(timesheetNoticeWrapper.dataset.project);let checkboxHideEmptyNoticeFields=document.getElementById("checkboxHideEmptyNoticeFields");window.crypto&&window.crypto.subtle||(alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),timesheetNoticeForm&&(timesheetNoticeForm.querySelectorAll("textarea, select, input").forEach((function(e){e.disabled=!0})),timesheetNoticeForm.querySelector('button[type="submit"]').classList.add("hidden")));let KEK,masterKey,currentNotice=getNoticeData();async function checkPassword(){if(KEK=await getKEKfromStore(),KEK)try{let e=await getEncryptionParameters();await decryptTestMessageAndMasterKey(KEK,e.data.encryptedTestMessage,e.data.encryptedMasterKey)}catch(e){alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden");let t=await getStore();await t.delete(projectID);return void loadingIconTimesheetNotice.classList.add("hidden")}else{let e=await inputDialog(lang.timesheets_notice_password);if(!1===e)return alertError.classList.remove("hidden"),void loadingIconTimesheetNotice.classList.add("hidden");try{await createAndStoreKEK(e),KEK=await getKEKfromStore()}catch(e){return console.log(e),alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),void loadingIconTimesheetNotice.classList.add("hidden")}}let e=Array.from(timesheetNoticeWrapper.querySelectorAll(".timesheet-notice"));for(const t of e){let e;try{e=await getNotice(t.dataset)}catch(e){return alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),document.getElementById("loading-overlay").classList.add("hidden"),void loadingIconTimesheetNotice.classList.add("hidden")}if(e)if(IsJsonString(e)){e=JSON.parse(e);for(const[a,r]of Object.entries(e)){let r=e[a],o=t.querySelector('[data-name="'+a+'"]');o&&(!o.tagName||"textarea"!==o.tagName.toLowerCase()&&"input"!==o.tagName.toLowerCase()&&"select"!==o.tagName.toLowerCase()?r?o.innerHTML=r.replace(/(?:\r\n|\r|\n)/g,"<br>"):o.parentElement.dataset.empty=1:o.value=r)}}else{let a=t.querySelector('[data-default="1"]');a&&a.tagName&&("textarea"===a.tagName.toLowerCase()||"input"===a.tagName.toLowerCase()||"select"===a.tagName.toLowerCase())?a.value=e:(e?a.innerHTML=e.replace(/(?:\r\n|\r|\n)/g,"<br>"):a.parentElement.dataset.empty=1,t.querySelectorAll('[data-default="0"]').forEach((function(e){e.parentElement.dataset.empty=1})))}else t.closest(".timesheet-notice-wrapper").dataset.empty=1;checkboxHideEmptyNoticeFields&&checkboxHideEmptyNoticeFields.checked&&document.querySelectorAll('.timesheet-notice-field[data-empty="1"], .timesheet-notice-wrapper[data-empty="1"] .timesheet-notice-field').forEach((function(e){e.classList.add("hidden")}))}loadingIconTimesheetNotice.classList.add("hidden"),timesheetNoticeWrapper.classList.remove("hidden")}async function getNotice(e){if(!masterKey)throw console.error("masterKey missing"),"masterKey missing";let t=e.id,a=e.type,r="";"sheet"==a?r=jsObject.timesheets_sheets_notice_data:"customer"==a&&(r=jsObject.timesheets_customers_notice_data);let o=await fetch(r+"?id="+t,{method:"GET",credentials:"same-origin"}),n=await o.json();if("error"!==n.status&&n.entry){let e,t=n.entry.notice,a=n.entry.encryptedCEK;timesheetLastSavedWrapper&&(timesheetLastSaved?(timesheetLastSaved.innerHTML=moment(n.entry.changedOn).format(i18n.dateformatJS.datetime),timesheetLastSavedWrapper.classList.remove("hidden")):timesheetLastSavedWrapper.classList.add("hidden"));try{const t=await decryptData(masterKey,a),r=base64_to_buf(t);e=await createKeyObject(r)}catch(e){throw console.error(`Unable to decrypt CEK - ${e}`),e}if(t)try{let a=await decryptData(e,t);return timesheetLastSaved&&(currentNotice=a),a}catch(e){throw console.error(`Unable to decrypt notice - ${e}`),e}}}function getNoticeData(){if(!timesheetNoticeForm)return;let e=Array.from(timesheetNoticeForm.querySelectorAll('input[type="text"], textarea, select')),t={};for(const a of e)a.tagName&&"select"===a.tagName.toLowerCase()?a.selectedIndex>=0&&(t[a.name]=a.options[a.selectedIndex].text):t[a.name]=a.value;return JSON.stringify(t)}async function saveNotice(e=!1){if(!masterKey)return alertErrorDetail.innerHTML=lang.encrypt_error,alertError.classList.remove("hidden"),void document.getElementById("loading-overlay").classList.add("hidden");e||(alertError.classList.add("hidden"),alertErrorDetail.innerHTML="",document.getElementById("loading-overlay").classList.remove("hidden"));let t=getNoticeData();if(e&&currentNotice&&currentNotice===t)return void console.log("No changes, not saving!");let a={};a.is_autosave=e?1:0;const r=window.crypto.getRandomValues(new Uint8Array(32)),o=await createKeyObject(r);a.encryptedCEK=await encryptData(masterKey,buff_to_base64(r)),a.notice=await encryptData(o,t);try{let r=await getCSRFToken();a.csrf_name=r.csrf_name,a.csrf_value=r.csrf_value;let o=await fetch(timesheetNoticeForm.action,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),n=await o.json();"success"===n.status&&(currentNotice=t,timesheetLastSavedWrapper&&(timesheetLastSaved?(timesheetLastSaved.innerHTML=moment(n.entry.changedOn).format(i18n.dateformatJS.datetime),timesheetLastSavedWrapper.classList.remove("hidden")):timesheetLastSavedWrapper.classList.add("hidden"))),e||("success"===n.status?(allowedReload=!0,window.location.reload(!0)):(document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=a.error,alertError.classList.remove("hidden")))}catch(t){if(console.log(t),!e)if(document.body.classList.contains("offline")){let e=new URLSearchParams(a).toString();saveDataWhenOffline(timesheetNoticeForm.action,timesheetNoticeForm.method,e)}else document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=t,alertError.classList.remove("hidden")}}async function getEncryptionParameters(){let e={},t=await getCSRFToken();e.csrf_name=t.csrf_name,e.csrf_value=t.csrf_value;let a=await fetch(jsObject.timesheets_notice_params,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await a.json();if("success"!==r.status)throw"Unable to retrieve parameters";return r}async function decryptTestMessageAndMasterKey(e,t,a){try{if("test"!==await decryptData(e,t))throw"Wrong message!"}catch(e){throw console.error(`Unable to decrypt test message - ${e}`),e}try{const t=await decryptData(e,a),r=base64_to_buf(t);masterKey=await createKeyObject(r)}catch(e){throw console.error(`Unable to decrypt masterKey - ${e}`),e}return 0}async function createAndStoreKEK(e){let t=await getEncryptionParameters();const a=t.data.iterations,r=base64_to_buf(t.data.salt),o=await createKeyMaterial(e),n=await deriveKEK(o,r,a);return await decryptTestMessageAndMasterKey(n,t.data.encryptedTestMessage,t.data.encryptedMasterKey),(await getStore()).add({project:projectID,key:n}),0}async function getStore(){if("indexedDB"in window){let e=indexedDB.open("lifeTrackingData",2);return new Promise((function(t,a){e.onsuccess=function(){var a=e.result.transaction("keys","readwrite").objectStore("keys");t(a)}}))}}async function getKEKfromStore(){let e=await getStore();return await new Promise((function(t,a){let r=e.get(projectID);r.onsuccess=function(e){r.result&&t(r.result.key),t(null)}}))}function IsJsonString(e){try{JSON.parse(e)}catch(e){return!1}return!0}checkPassword(),timesheetNoticeForm&&(timesheetNoticeForm.addEventListener("submit",(async function(e){e.preventDefault(),saveNotice(!1)})),setInterval((async function(){saveNotice(!0)}),12e4));let checkboxHideEmptySheets=document.getElementById("checkboxHideEmptySheets");function createInputDialog(e,t){var a=document.createElement("div");a.id="input-modal",a.classList.add("modal"),a.classList.add("vertical-centered");var r=document.createElement("div");r.classList.add("modal-inner");var o=document.createElement("form"),n=document.createElement("div");n.classList.add("modal-content");var i=document.createElement("p");i.textContent=e,n.appendChild(i);var s=document.createElement("input");s.type="text",s.classList.add("form-control"),n.appendChild(s);var c=document.createElement("div");c.classList.add("modal-footer");var d=document.createElement("div");d.classList.add("buttons");var l=document.createElement("button");l.type="button",l.classList.add("button"),l.textContent=lang.ok;var m=document.createElement("button");function u(e){"Enter"===e.key?(e.preventDefault(),a.remove(),t(s.value),document.removeEventListener("keydown",u)):"Escape"!==e.key&&27!==e.keyCode||(e.preventDefault(),a.remove(),t(!1),document.removeEventListener("keydown",u))}m.classList.add("button","button-text","cancel"),m.type="button",m.textContent=lang.cancel,d.appendChild(l),d.appendChild(m),c.appendChild(d),o.appendChild(n),o.appendChild(c),r.appendChild(o),a.appendChild(r),document.body.appendChild(a),a.style.display="block",s.focus(),l.onclick=function(){a.remove(),t(s.value)},m.onclick=function(){a.remove(),t(!1),document.removeEventListener("keydown",u)},document.addEventListener("keydown",u)}function inputDialog(e){return new Promise(((t,a)=>{createInputDialog(e,t)}))}checkboxHideEmptySheets&&checkboxHideEmptySheets.addEventListener("click",(function(e){document.querySelectorAll('.timesheet-notice-wrapper[data-empty="1"]').forEach((function(e){checkboxHideEmptySheets.checked?e.classList.add("hidden"):e.classList.remove("hidden")}))})),checkboxHideEmptyNoticeFields&&checkboxHideEmptyNoticeFields.addEventListener("click",(function(e){document.querySelectorAll('.timesheet-notice-field[data-empty="1"], .timesheet-notice-wrapper[data-empty="1"] .timesheet-notice-field').forEach((function(e){checkboxHideEmptyNoticeFields.checked?e.classList.add("hidden"):e.classList.remove("hidden")}))}));