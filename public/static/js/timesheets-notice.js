"use strict";const timesheetNoticeWrapper=document.querySelector("#timesheetNoticeWrapper"),loadingIconTimesheetNotice=document.querySelector("#loadingIconTimesheetNotice"),timesheetNoticeForm=document.querySelector("#timesheetNoticeForm"),alertError=document.querySelector("#alertError"),alertErrorDetail=alertError.querySelector("#alertErrorDetail"),projectID=parseInt(timesheetNoticeWrapper.dataset.project);let aesKey;async function checkPassword(){if(aesKey=await getAESKeyFromStore(),!aesKey){let t=window.prompt(lang.timesheets_notice_password);var e={password:t};let r=await getCSRFToken();e.csrf_name=r.csrf_name,e.csrf_value=r.csrf_value;let o=await fetch(jsObject.timesheets_sheets_check_pw,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await o.json();if("success"===a.status){const e=base64_to_buf(a.data),r=await createKeyMaterial(t),o=await createsAESKey(r,e);(await getStore()).add({project:projectID,key:o}),aesKey=await getAESKeyFromStore()}else if("error"===a.status&&a.reason)return alertErrorDetail.innerHTML=a.reason,alertError.classList.remove("hidden"),void loadingIconTimesheetNotice.classList.add("hidden")}let t=Array.from(timesheetNoticeWrapper.querySelectorAll(".timesheet-notice"));for(const e of t){let t=parseInt(e.dataset.sheet),r=await getNotice(t);r&&(e.tagName&&"textarea"===e.tagName.toLowerCase()?e.value=r:e.innerHTML=r.replace(/(?:\r\n|\r|\n)/g,"<br>"))}loadingIconTimesheetNotice.classList.add("hidden"),timesheetNoticeWrapper.classList.remove("hidden")}async function getNotice(e){let t=await fetch(jsObject.timesheets_sheets_notice_data+"?sheet="+e,{method:"GET",credentials:"same-origin"}),r=await t.json();if("error"!==r.status&&r.entry){let e=r.entry.notice;if(e){if(!aesKey)return alertErrorDetail.innerHTML=lang.decrypt_error,void alertError.classList.remove("hidden");return await decryptData(e)}}}function createKeyMaterial(e){let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}function createsAESKey(e,t){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function encryptData(e){try{const t=window.crypto.getRandomValues(new Uint8Array(12)),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},aesKey,(new TextEncoder).encode(e)),o=new Uint8Array(r);let a=new Uint8Array(t.byteLength+o.byteLength);a.set(t,0),a.set(o,t.byteLength);return buff_to_base64(a)}catch(e){return console.log(`Error - ${e}`),alertErrorDetail.innerHTML=lang.encrypt_error,alertError.classList.remove("hidden"),""}}function buff_to_base64(e){return btoa(String.fromCharCode.apply(null,e))}function base64_to_buf(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(null)))}async function getStore(){if("indexedDB"in window){let e=indexedDB.open("lifeTrackingData",2);return new Promise((function(t,r){e.onsuccess=function(){var r=e.result.transaction("keys","readwrite").objectStore("keys");t(r)}}))}}async function getAESKeyFromStore(){let e=await getStore();return await new Promise((function(t,r){let o=e.get(projectID);o.onsuccess=function(e){o.result&&t(o.result.key),t(null)}}))}async function decryptData(e){try{const t=base64_to_buf(e),r=t.slice(0,12),o=t.slice(12),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:r},aesKey,o);return(new TextDecoder).decode(a)}catch(e){return console.log(`Error - ${e}`),alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),""}}window.crypto&&window.crypto.subtle||(alertErrorDetail.innerHTML=lang.decrypt_error,alertError.classList.remove("hidden"),timesheetNoticeForm&&(timesheetNoticeForm.querySelectorAll("textarea, select, input").forEach((function(e){e.disabled=!0})),timesheetNoticeForm.querySelector('button[type="submit"]').classList.add("hidden"))),checkPassword(),timesheetNoticeForm&&timesheetNoticeForm.addEventListener("submit",(async function(e){e.preventDefault(),alertError.classList.add("hidden"),alertErrorDetail.innerHTML="",document.getElementById("loading-overlay").classList.remove("hidden");const t=timesheetNoticeForm.querySelector("#inputNotice");var r={};r.notice=await encryptData(t.value),getCSRFToken().then((function(e){return r.csrf_name=e.csrf_name,r.csrf_value=e.csrf_value,fetch(timesheetNoticeForm.action,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})})).then((function(e){return e.json()})).then((function(e){"success"===e.status?(allowedReload=!0,window.location.reload(!0)):(document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=e.message,alertError.classList.remove("hidden"))})).catch((function(e){console.log(e),document.getElementById("loading-overlay").classList.add("hidden"),alertErrorDetail.innerHTML=e,alertError.classList.remove("hidden")}))}));