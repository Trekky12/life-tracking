"use strict";let layerTrains=new L.LayerGroup,layerCars=new L.LayerGroup,layerPlanes=new L.LayerGroup,layerCarRentals=new L.LayerGroup,layerHotels=new L.LayerGroup,layerEvents=new L.LayerGroup,controlLayer=null,mymap=null,routeControl=null;const tripDays=document.querySelectorAll(".trip_day"),changeDayLinks=document.querySelectorAll(".change_day"),today=moment(Date.now()).format("YYYY-MM-DD"),currentDayButton=document.querySelector('.change_day[data-date="'+today+'"]'),newEventButton=document.querySelector("#new-event-btn");let addEventLink="";function changeDay(e){let a=e.dataset.date;getMarkers(a,a).then((function(){if(a){let e=document.getElementById("trip_day_"+a);tripDays.forEach((function(e){e.classList.add("hidden")})),e.classList.remove("hidden")}else tripDays.forEach((function(e){e.classList.remove("hidden")}));changeDayLinks.forEach((function(e){e.querySelector("button").classList.add("gray")})),e.querySelector("button").classList.remove("gray")}))}newEventButton&&(addEventLink=newEventButton.href),null!==changeDayLinks&&changeDayLinks.forEach((function(e,a){e.addEventListener("click",(function(a){a.preventDefault(),newEventButton&&(newEventButton.href=addEventLink+e.search),changeDay(e)}))}));let descriptionLinks=document.querySelectorAll(".trip_day .description_text");descriptionLinks.forEach((function(e,a){e.addEventListener("click",(function(e){e.preventDefault(),e.target.parentElement.classList.toggle("active")}))}));const from=document.getElementById("inputStart").value,to=document.getElementById("inputEnd").value;function getMarkers(e,a){return fetch(jsObject.trip_markers_url+"?from="+e+"&to="+a,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(e){return e.json()})).then((function(e){drawMarkers(e)})).catch((function(e){console.log(e)}))}function drawMarkers(e){layerTrains.clearLayers(),layerCars.clearLayers(),layerPlanes.clearLayers(),layerCarRentals.clearLayers(),layerHotels.clearLayers(),layerEvents.clearLayers();let a=[],t=0;for(t in e){let r=e[t];if(null===r.data.start_lat||null===r.data.start_lng)continue;let n={};r.isCarrental?n.icon=L.ExtraMarkers.icon({icon:"fa-car",markerColor:"red",shape:"circle",prefix:"fa"}):r.isHotel?n.icon=L.ExtraMarkers.icon({icon:"fa-bed",markerColor:"blue",shape:"circle",prefix:"fa"}):r.isEvent?n.icon=L.ExtraMarkers.icon({icon:"fa-calendar-o",markerColor:"yellow",shape:"circle",prefix:"fa"}):r.isPlane&&(n.icon=L.ExtraMarkers.icon({icon:"fa-plane",markerColor:"black",shape:"circle",prefix:"fa"}));let l=L.marker([r.data.start_lat,r.data.start_lng],n),o=document.createElement("a");o.classList.add("navigation-btn"),o.innerHTML=lang.set_navigation,o.addEventListener("click",(function(){let e=0;routeControl.getWaypoints()[0].latLng&&(e=routeControl.getWaypoints().length-1);let a=L.Routing.waypoint(l.getLatLng(),r.data.name);routeControl.spliceWaypoints(e,1,a),routeControl.show()}));let i=document.createElement("div"),s=document.createElement("h4");s.innerHTML=r.data.name;let d=document.createElement("p");if(d.innerHTML=r.data.popup,i.appendChild(s),i.appendChild(d),i.appendChild(o),l.bindPopup(i),a.push(l),r.isCarrental?layerCarRentals.addLayer(l):r.isHotel?layerHotels.addLayer(l):r.isEvent?layerEvents.addLayer(l):r.isTrain?layerTrains.addLayer(l):r.isPlane?layerPlanes.addLayer(l):r.isCar&&layerCars.addLayer(l),null!==r.data.end_lat&&null!==r.data.end_lat){let e=L.marker([r.data.end_lat,r.data.end_lng],n);a.push(e);let t=[[r.data.start_lat,r.data.start_lng],[r.data.end_lat,r.data.end_lng]];if(r.isCarrental)layerCarRentals.addLayer(e);else if(r.isHotel)layerHotels.addLayer(e);else if(r.isEvent)layerEvents.addLayer(e);else if(r.isTrain){let e=[];e[0]=L.polyline(t,{color:"black",weight:"5"}).bindPopup(i),e[1]=L.polyline(t,{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(i),e[2]=L.polyline(t,{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(i),layerTrains.addLayer(L.layerGroup(e)),layerTrains.removeLayer(l)}else if(r.isPlane){let a=calculateMidPoint(l,e),t=L.curve(["M",[r.data.start_lat,r.data.start_lng],"Q",a,[r.data.end_lat,r.data.end_lng]],{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(i);layerPlanes.addLayer(l),layerPlanes.addLayer(t)}else if(r.isCar){let e=[];e[0]=L.polyline(t,{color:"gray",weight:"5"}).bindPopup(i),e[1]=L.polyline(t,{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(i),layerCars.addLayer(L.layerGroup(e)),layerCars.removeLayer(l)}}}if(a.length>0){var r=new L.featureGroup(a);mymap.fitBounds(r.getBounds())}}function initMap(){mymap=L.map("trip-map",{fullscreenControl:!0}).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(mymap),mymap.addLayer(layerPlanes),mymap.addLayer(layerTrains),mymap.addLayer(layerCars),mymap.addLayer(layerCarRentals),mymap.addLayer(layerHotels),mymap.addLayer(layerEvents),controlLayer=L.control.layers(null,null,{collapsed:!1}),controlLayer.addOverlay(layerPlanes,"<span id='layerPlanes'></span>"),controlLayer.addOverlay(layerTrains,"<span id='layerTrains'></span>"),controlLayer.addOverlay(layerCars,"<span id='layerStreets'></span>"),controlLayer.addOverlay(layerCarRentals,"<span id='layerCarrental'></span>"),controlLayer.addOverlay(layerHotels,"<span id='layerHotels'></span>"),controlLayer.addOverlay(layerEvents,"<span id='layerEvents'></span>"),controlLayer.addTo(mymap);var e=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0}});mymap.addControl(e),L.easyPrint({position:"bottomleft",sizeModes:["A4Portrait","A4Landscape"],spinnerBgColor:"#1565c0"}).addTo(mymap),currentDayButton?changeDay(currentDayButton):getMarkers(from,to),routeControl=L.Routing.control({waypoints:[],geocoder:L.Control.Geocoder.nominatim(),autoRoute:!0,createMarker:function(){return null},router:new L.Routing.OSRMv1({profile:"driving",suppressDemoServerWarning:!0}),show:!1,collapsible:!0,addWaypoints:!0,reverseWaypoints:!0,language:i18n.routing,showAlternatives:!1,routeWhileDragging:!1}).addTo(mymap),routeControl.on("routingerror",(function(e){429===e.error.target.status?alert(lang.routing_error_too_many_requests):alert(lang.routing_error)}))}function calculateMidPoint(e,a){let t=e.getLatLng(),r=a.getLatLng();var n=r.lng-t.lng,l=r.lat-t.lat,o=Math.sqrt(Math.pow(n,2)+Math.pow(l,2)),i=Math.atan2(l,n),s=o/2/Math.cos(.314),d=i+.314,c=s*Math.cos(d)+t.lng;return[s*Math.sin(d)+t.lat,c]}initMap();