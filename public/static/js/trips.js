"use strict";const routeModal=document.getElementById("route-modal"),loadingOverlay=document.getElementById("loading-overlay");let layerTrains=new L.LayerGroup,layerCars=new L.LayerGroup,layerPlanes=new L.LayerGroup,layerCarRentals=new L.LayerGroup,layerHotels=new L.LayerGroup,layerEvents=new L.LayerGroup,layerWaypoints=new L.LayerGroup,layerShips=new L.LayerGroup,controlLayer=null,mymap=null,routeControl=null,my_markers=[];const tripDays=document.querySelectorAll(".trip_day"),changeDayLinks=document.querySelectorAll(".change_day"),today=moment(Date.now()).format("YYYY-MM-DD"),currentDayButton=document.querySelector('.change_day[data-date="'+today+'"]'),newEventButton=document.querySelector("#new-event-btn");let addEventLink="";function changeDay(e){let t=e.dataset.date;fromInput.value=t,toInput.value=t,newEventButton&&(newEventButton.href=addEventLink+e.search),window.history.pushState({},"",window.location.pathname+e.search),getMarkers(t,t).then((function(){if(t){let e=document.getElementById("trip_day_"+t);tripDays.forEach((function(e){"trip_day_none"!==e.id&&e.classList.add("hidden")})),e.classList.remove("hidden")}else tripDays.forEach((function(e){e.classList.remove("hidden")}));changeDayLinks.forEach((function(e){e.querySelector("button").classList.add("button-outlined")})),e.querySelector("button").classList.remove("button-outlined")}))}newEventButton&&(addEventLink=newEventButton.href),null!==changeDayLinks&&changeDayLinks.forEach((function(e,t){e.addEventListener("click",(function(t){t.preventDefault(),changeDay(e)}))}));let descriptionLinks=document.querySelectorAll(".trip_day .description_text");descriptionLinks.forEach((function(e,t){e.addEventListener("click",(function(e){e.preventDefault(),e.target.parentElement.classList.toggle("active")}))}));const fromInput=document.getElementById("inputStart"),toInput=document.getElementById("inputEnd"),routeBtn=document.getElementById("createRoute");routeBtn&&routeBtn.addEventListener("click",(function(e){e.preventDefault(),routeControl.setWaypoints([]),my_markers.forEach((function(e,t){e.data.isPlane||e.data.isWithoutDate||addWaypoint(e)})),routeControl.show()}));const reloadTripBtn=document.getElementById("reloadTrip");function getMarkers(e,t){return fetch(jsObject.trip_markers_url+"?from="+e+"&to="+t,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(e){return e.json()})).then((function(e){drawMarkers(e)})).catch((function(e){console.log(e)}))}function drawMarkers(e){layerTrains.clearLayers(),layerCars.clearLayers(),layerPlanes.clearLayers(),layerCarRentals.clearLayers(),layerHotels.clearLayers(),layerEvents.clearLayers(),layerWaypoints.clearLayers(),layerShips.clearLayers(),my_markers=[];let t=0;for(t in e){let n=e[t];if(console.log(n),null===n.data.start_lat&&null!==n.data.end_lat&&(n.data.start_lat=n.data.end_lat),null===n.data.start_lng&&null!==!n.data.end_lng&&(n.data.start_lng=n.data.end_lng),null===n.data.start_lat||null===n.data.start_lng)continue;let a={saved:!0};n.isCarrental?a.icon=L.ExtraMarkers.icon({markerColor:"red",shape:"circle",innerHTML:document.getElementById("iconCarRentals").innerHTML}):n.isHotel?a.icon=L.ExtraMarkers.icon({markerColor:"blue",shape:"circle",innerHTML:document.getElementById("iconHotels").innerHTML}):n.isEvent?a.icon=L.ExtraMarkers.icon({markerColor:"yellow",shape:"circle",innerHTML:document.getElementById("iconEvents").innerHTML}):n.isPlane&&(a.icon=L.ExtraMarkers.icon({markerColor:"black",shape:"circle",innerHTML:document.getElementById("iconPlanes").innerHTML}));let r=L.marker([n.data.start_lat,n.data.start_lng],a);r.data=n,r.name=n.data.name,r.address=n.data.start_address;let o=getAddToRouteLink(r),l=document.createElement("div");if(!n.isWaypoint){let e=document.createElement("h4");e.innerHTML=n.data.name;let t=document.createElement("p");t.innerHTML=n.data.popup,l.appendChild(e),l.appendChild(t)}if(l.appendChild(o),n.isWaypoint){let e=getDeleteWaypointLink(n.data.id,r,!0);l.appendChild(document.createElement("br")),l.appendChild(e)}if(r.bindPopup(l),my_markers.push(r),n.isCarrental?layerCarRentals.addLayer(r):n.isHotel?layerHotels.addLayer(r):n.isEvent?layerEvents.addLayer(r):n.isTrain?layerTrains.addLayer(r):n.isPlane?layerPlanes.addLayer(r):n.isCar?layerCars.addLayer(r):n.isWaypoint?layerWaypoints.addLayer(r):n.isShip&&layerShips.addLayer(r),null!==n.data.end_lat&&null!==n.data.end_lng&&n.data.start_lat!==n.data.end_lat&&n.data.start_lng!==n.data.end_lng){let e=L.marker([n.data.end_lat,n.data.end_lng],a);e.data=n,e.name=n.data.name,e.address=n.data.end_address,my_markers.push(e);n.data.start_lat,n.data.start_lng,n.data.end_lat,n.data.end_lng;if(n.isCarrental)layerCarRentals.addLayer(e);else if(n.isHotel)layerHotels.addLayer(e);else if(n.isEvent)layerEvents.addLayer(e);else if(n.isTrain){let t=[],a=calculateMidPoint(r,e);t[0]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"black",weight:"5"}).bindPopup(l),t[1]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(l),t[2]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(l),layerTrains.addLayer(L.layerGroup(t)),layerTrains.removeLayer(r)}else if(n.isPlane){let t=calculateMidPoint(r,e),a=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",t,[n.data.end_lat,n.data.end_lng]],{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(l);layerPlanes.addLayer(r),layerPlanes.addLayer(a)}else if(n.isCar){let t=[],a=calculateMidPoint(r,e);t[0]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"gray",weight:"5"}).bindPopup(l),t[1]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(l),layerCars.addLayer(L.layerGroup(t)),layerCars.removeLayer(r)}else if(n.isShip){let t=[],a=calculateMidPoint(r,e);t[0]=L.curve(["M",[n.data.start_lat,n.data.start_lng],"Q",a,[n.data.end_lat,n.data.end_lng]],{color:"blue",weight:"5",dashArray:"10, 10",dashOffset:"0"}).bindPopup(l),layerShips.addLayer(L.layerGroup(t)),layerShips.removeLayer(r)}}}if(my_markers.length>0){var n=new L.featureGroup(my_markers);mymap.fitBounds(n.getBounds())}}function getNextWaypointPos(){let e=0,t=routeControl.getWaypoints().length,n=routeControl.getWaypoints()[0].latLng,a=routeControl.getWaypoints()[t-1].latLng;return n&&(e=routeControl.getWaypoints().length-1),n&&a&&(e=routeControl.getWaypoints().length),e}function addWaypoint(e){let t=getNextWaypointPos(),n=e.name?e.name+" ("+e.address+")":null,a=L.Routing.waypoint(e.getLatLng(),n,{saved:e.options.saved});return routeControl.spliceWaypoints(t,1,a),t}function RoutingMachineGeocoder(e){const t=e.reverse;return"AsyncFunction"===t[Symbol.toStringTag]&&(e.reverse=function(e,n,a,r){t.apply(this,[e,n]).then(a.bind(r))}),e}function initMap(){mymap=L.map("trip-map",{fullscreenControl:{pseudoFullscreen:!0}}).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(mymap),mymap.addLayer(layerPlanes),mymap.addLayer(layerTrains),mymap.addLayer(layerCars),mymap.addLayer(layerCarRentals),mymap.addLayer(layerHotels),mymap.addLayer(layerEvents),mymap.addLayer(layerWaypoints),mymap.addLayer(layerShips),controlLayer=L.control.layers(null,null,{collapsed:!1}),controlLayer.addOverlay(layerPlanes,"<span id='layerPlanes'>"+document.getElementById("iconPlanes").innerHTML+"</span>"),controlLayer.addOverlay(layerTrains,"<span id='layerTrains'>"+document.getElementById("iconTrains").innerHTML+"</span>"),controlLayer.addOverlay(layerShips,"<span id='layerShips'>"+document.getElementById("iconShips").innerHTML+"</span>"),controlLayer.addOverlay(layerCars,"<span id='layerStreets'>"+document.getElementById("iconStreets").innerHTML+"</span>"),controlLayer.addOverlay(layerCarRentals,"<span id='layerCarrental'>"+document.getElementById("iconCarRentals").innerHTML+"</span>"),controlLayer.addOverlay(layerHotels,"<span id='layerHotels'>"+document.getElementById("iconHotels").innerHTML+"</span>"),controlLayer.addOverlay(layerEvents,"<span id='layerEvents'>"+document.getElementById("iconEvents").innerHTML+"</span>"),controlLayer.addTo(mymap);var e=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0}});mymap.addControl(e),L.easyPrint({position:"bottomleft",sizeModes:["A4Portrait","A4Landscape"],spinnerBgColor:"#1565c0"}).addTo(mymap),fromInput.value||toInput.value||!currentDayButton?(getMarkers(fromInput.value,toInput.value),newEventButton&&(newEventButton.href=addEventLink+"?from="+fromInput.value+"&to="+toInput.value)):changeDay(currentDayButton);let t=new(L.Routing.Plan.extend({createGeocoders:function(){var e=L.Routing.Plan.prototype.createGeocoders.call(this);let t=createButton(e,"add"),n=createButton(e,"reverse"),a=createButton(e,"walk"),r=createButton(e,"bike"),o=createButton(e,"car",!0);L.DomEvent.on(t,"click",(function(){this.spliceWaypoints(routeControl.getWaypoints().length,0,null)}),this),L.DomEvent.on(n,"click",(function(){let e=routeControl.getWaypoints().reverse();this.setWaypoints(e)}),this),L.DomEvent.on(a,"click",(function(){setRoutingProfile("mapbox/walking")}),this),L.DomEvent.on(r,"click",(function(){setRoutingProfile("mapbox/cycling")}),this),L.DomEvent.on(o,"click",(function(){setRoutingProfile("mapbox/driving")}),this);let l=createButton(e,"save");L.DomEvent.on(l,"click",(async function(){let e=await inputDialog(lang.trips_route_name_prompt,!1);!1!==e&&getCSRFToken().then((function(t){let n={name:e,start_date:fromInput.value,end_date:toInput.value,waypoints:routeControl.getWaypoints(),profile:routeControl.getRouter().options.profile};return n.csrf_name=t.csrf_name,n.csrf_value=t.csrf_value,fetch(jsObject.trip_add_route,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})})).then((function(e){return e.json()})).then((function(e){"success"===e.status?alert(lang.trips_route_saved_successfully):alert(lang.trips_route_saved_error)})).catch((function(e){console.log(e),alert(lang.trips_route_saved_error)}))}),this);let i=createButton(e,"load");return L.DomEvent.on(i,"click",(function(){freeze(),loadingOverlay.classList.remove("hidden"),fetch(jsObject.trip_list_routes,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(e){return e.json()})).then((function(e){let t=routeModal.querySelector("table"),n=t.querySelector("tbody");n.innerHTML="",e.forEach((function(e){let a=document.createElement("tr"),r=document.createElement("td");r.innerHTML=e.name,a.appendChild(r);let o=document.createElement("td");o.innerHTML=e.start_date,a.appendChild(o);let l=document.createElement("td"),i=document.createElement("a");i.href="#",i.dataset.route=e.id,i.classList.add("btn-route");let s=document.createElement("span");s.innerHTML=document.getElementById("iconRoute").innerHTML,i.appendChild(s),l.appendChild(i),a.appendChild(l),t.addEventListener("click",(function(e){let t=e.target.closest(".btn-route");if(t){e.preventDefault();let n=t.dataset.route;return fetch(jsObject.trip_route_waypoints+"?route="+n,{method:"GET",credentials:"same-origin"}).then((function(e){return e.json()})).then((function(e){if(e.profile&&setRoutingProfile(e.profile),routeControl.setWaypoints(e.waypoints),routeModal.classList.remove("visible"),e.start_date){changeDay(document.querySelector('.change_day[data-date="'+e.start_date+'"]'))}})).catch((function(e){console.log(e)}))}}));let d=document.createElement("td"),c=document.createElement("a");c.href="#",c.dataset.url=e.delete,c.classList.add("btn-delete");let u=document.createElement("span");u.innerHTML=document.getElementById("iconTrash").innerHTML,c.appendChild(u),d.appendChild(c),a.appendChild(d),n.appendChild(a)}));new JSTable(t,{perPage:10,labels:tableLabels,layout:{top:null,bottom:"{pager}"},columns:[{select:0,sortable:!0},{select:[1],render:function(e,t){let n=e.innerHTML;return n?moment(n).format(i18n.dateformatJS.date):""}},{select:[2,3],sortable:!1,searchable:!1}]})})).catch((function(e){console.log(e)})).finally((function(){routeModal.classList.add("visible"),loadingOverlay.classList.add("hidden"),unfreeze()}))}),this),e}}))([],{geocoder:RoutingMachineGeocoder(new L.Control.Geocoder.Mapbox({reverseQueryParams:{language:i18n.routing},apiKey:mapbox_token})),createMarker:function(e,t){if(t.options.saved)return null;let n={saved:!1,draggable:this.draggableWaypoints},a=L.marker(t.latLng,n),r=document.createElement("div"),o=getAddToRouteLink(a),l=saveWaypointLink(a,t),i=getDeleteWaypointLink(null,a,!1);return r.appendChild(o),r.appendChild(document.createElement("br")),r.appendChild(l),r.appendChild(document.createElement("br")),r.appendChild(i),a.bindPopup(r),a},routeWhileDragging:!1,reverseWaypoints:!1,addWaypoints:!0,language:i18n.routing,draggableWaypoints:!0});routeControl=L.Routing.control({waypoints:[],autoRoute:!0,router:L.Routing.mapbox(mapbox_token,{profile:"mapbox/driving",routingOptions:{alternatives:!1,steps:!1},language:i18n.routing}),show:!1,collapsible:!0,collapseBtn:function(e){var t=L.DomUtil.create("span",e.options.collapseBtnClass);t.innerHTML=document.getElementById("iconRoute").innerHTML,L.DomEvent.on(t,"click",e._toggle,e),e._container.insertBefore(t,e._container.firstChild)},showAlternatives:!1,routeWhileDragging:!1,plan:t,attachResultsToContainer:!0}).addTo(mymap),routeControl.on("routingerror",(function(e){429==e.error.target.status?alert(lang.routing_error_too_many_requests):alert(lang.routing_error)})),mymap.on("contextmenu",(function(e){addWaypoint(L.marker(e.latlng,{})),routeControl.show()})),mymap.on("movestart zoomstart",(function(e){isMapMove=!0})),mymap.on("moveend zoomend",(function(e){isMapMove=!1})),mymap.on("fullscreenchange",(function(e){mymap.isFullscreen()?isMapMove=!1:isMapMove=!0}))}function calculateMidPoint(e,t){let n=e.getLatLng(),a=t.getLatLng();var r=a.lng-n.lng,o=a.lat-n.lat,l=Math.sqrt(Math.pow(r,2)+Math.pow(o,2)),i=Math.atan2(o,r),s=l/2/Math.cos(.314),d=i+.314,c=s*Math.cos(d)+n.lng;return[s*Math.sin(d)+n.lat,c]}function createButton(e,t,n=!1){var a=L.DomUtil.create("button","",e);switch(a.setAttribute("type","button"),a.title=t,a.classList.add("leaflet-routing-btn"),a.classList.add(t),t){case"walk":a.innerHTML=document.getElementById("iconWalking").innerHTML;break;case"car":a.innerHTML=document.getElementById("iconCarRentals").innerHTML;break;case"bike":a.innerHTML=document.getElementById("iconBiking").innerHTML;break;case"load":a.innerHTML=document.getElementById("iconMaps").innerHTML;break;case"save":a.innerHTML=document.getElementById("iconSave").innerHTML;break;case"add":a.innerHTML=document.getElementById("iconAdd").innerHTML;break;case"reverse":a.innerHTML=document.getElementById("iconReverse").innerHTML}return n&&a.classList.add("active"),a}function getAddToRouteLink(e){let t=document.createElement("a");return t.classList.add("navigation-btn"),t.innerHTML=lang.routing_add_to_route,t.addEventListener("click",(function(){addWaypoint(e),routeControl.show()})),t}function saveWaypointLink(e,t){let n=document.createElement("a");return n.classList.add("navigation-btn"),n.innerHTML=lang.trips_waypoint_save,n.addEventListener("click",(function(){getCSRFToken().then((function(n){let a={start_lat:e.getLatLng().lat,start_lng:e.getLatLng().lng,type:"WAYPOINT",start_date:fromInput.value,end_date:toInput.value};return t.name&&(a.start_address=t.name),a.csrf_name=n.csrf_name,a.csrf_value=n.csrf_value,fetch(jsObject.trip_add_waypoint,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})})).then((function(e){return e.json()})).then((function(t){let n=L.marker(e.getLatLng(),{saved:!0}),a=document.createElement("div"),r=getAddToRouteLink(n),o=getDeleteWaypointLink(t.id,n,!0);a.appendChild(r),a.appendChild(document.createElement("br")),a.appendChild(o),n.bindPopup(a),layerWaypoints.addLayer(n),mymap.removeLayer(e)})).catch((function(e){console.log(e)}))})),n}function getDeleteWaypointLink(e,t,n=!1){let a=document.createElement("a");return a.classList.add("navigation-btn"),a.innerHTML=lang.delete_text,a.addEventListener("click",(function(){n&&getCSRFToken().then((function(t){let n={};return n.csrf_name=t.csrf_name,n.csrf_value=t.csrf_value,fetch(jsObject.trip_delete_waypoint+"?id="+e,{method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})})).then((function(e){return e.json()})).then((function(e){mymap.removeLayer(t),my_markers.splice(my_markers.indexOf(t),1)})).catch((function(e){console.log(e)}));let a=null,r=0;routeControl.getWaypoints().forEach((function(e){e.latLng&&e.latLng.lat===t.getLatLng().lat&&e.latLng.lng===t.getLatLng().lng&&(a=r),r++})),null!==a&&routeControl.spliceWaypoints(a,1)})),a}function setRoutingProfile(e){routeControl.getRouter().options.profile=e,routeControl.route();let t=document.querySelector(".leaflet-routing-geocoders .leaflet-routing-btn.walk"),n=document.querySelector(".leaflet-routing-geocoders .leaflet-routing-btn.bike"),a=document.querySelector(".leaflet-routing-geocoders .leaflet-routing-btn.car");switch(e){case"mapbox/walking":t.classList.add("active"),n.classList.remove("active"),a.classList.remove("active");break;case"mapbox/cycling":t.classList.remove("active"),n.classList.add("active"),a.classList.remove("active");break;case"mapbox/driving":t.classList.remove("active"),n.classList.remove("active"),a.classList.add("active")}}null!==reloadTripBtn&&reloadTripBtn.addEventListener("click",(function(e){e.preventDefault(),loadingWindowOverlay.classList.remove("hidden"),window.location.reload()})),initMap(),tripDays.forEach((function(e){new Sortable(e,{draggable:".trip_event",handle:".trip-icon",ghostClass:"trip_event-placeholder",dataIdAttr:"data-event",onUpdate:function(e){var t={events:this.toArray()};getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.trip_event_position_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){getMarkers(fromInput.value,toInput.value)})).catch((function(e){console.log(e)}))}})})),document.getElementById("modal-close-btn").addEventListener("click",(function(e){routeModal.classList.remove("visible")}));