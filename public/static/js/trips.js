"use strict";let layerTrains=new L.LayerGroup,layerCars=new L.LayerGroup,layerPlanes=new L.LayerGroup,layerCarRentals=new L.LayerGroup,layerHotels=new L.LayerGroup,layerEvents=new L.LayerGroup,controlLayer=null,mymap=null,routeControl=null,my_markers=[];const tripDays=document.querySelectorAll(".trip_day"),changeDayLinks=document.querySelectorAll(".change_day"),today=moment(Date.now()).format("YYYY-MM-DD"),currentDayButton=document.querySelector('.change_day[data-date="'+today+'"]'),newEventButton=document.querySelector("#new-event-btn");let addEventLink="";function changeDay(e){let t=e.dataset.date;fromInput.value=t,toInput.value=t,newEventButton&&(newEventButton.href=addEventLink+e.search),getMarkers(t,t).then((function(){if(t){let e=document.getElementById("trip_day_"+t);tripDays.forEach((function(e){e.classList.add("hidden")})),e.classList.remove("hidden")}else tripDays.forEach((function(e){e.classList.remove("hidden")}));changeDayLinks.forEach((function(e){e.querySelector("button").classList.add("gray")})),e.querySelector("button").classList.remove("gray")}))}newEventButton&&(addEventLink=newEventButton.href),null!==changeDayLinks&&changeDayLinks.forEach((function(e,t){e.addEventListener("click",(function(t){t.preventDefault(),changeDay(e)}))}));let descriptionLinks=document.querySelectorAll(".trip_day .description_text");descriptionLinks.forEach((function(e,t){e.addEventListener("click",(function(e){e.preventDefault(),e.target.parentElement.classList.toggle("active")}))}));const fromInput=document.getElementById("inputStart"),toInput=document.getElementById("inputEnd"),routeBtn=document.getElementById("createRoute");function getMarkers(e,t){return fetch(jsObject.trip_markers_url+"?from="+e+"&to="+t,{method:"GET",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(e){return e.json()})).then((function(e){drawMarkers(e)})).catch((function(e){console.log(e)}))}function drawMarkers(e){layerTrains.clearLayers(),layerCars.clearLayers(),layerPlanes.clearLayers(),layerCarRentals.clearLayers(),layerHotels.clearLayers(),layerEvents.clearLayers(),my_markers=[];let t=0;for(t in e){let a=e[t];if(null===a.data.start_lat||null===a.data.start_lng)continue;let r={};a.isCarrental?r.icon=L.ExtraMarkers.icon({icon:"fa-car",markerColor:"red",shape:"circle",prefix:"fa"}):a.isHotel?r.icon=L.ExtraMarkers.icon({icon:"fa-bed",markerColor:"blue",shape:"circle",prefix:"fas"}):a.isEvent?r.icon=L.ExtraMarkers.icon({icon:"fa-calendar-alt",markerColor:"yellow",shape:"circle",prefix:"fas"}):a.isPlane&&(r.icon=L.ExtraMarkers.icon({icon:"fa-plane",markerColor:"black",shape:"circle",prefix:"fas"}));let n=L.marker([a.data.start_lat,a.data.start_lng],r);n.data=a,n.name=a.data.name,n.address=a.data.start_address;let o=document.createElement("a");o.classList.add("navigation-btn"),o.innerHTML=lang.routing_add_to_route,o.addEventListener("click",(function(){addWaypoint(n),routeControl.show()}));let l=document.createElement("div"),i=document.createElement("h4");i.innerHTML=a.data.name;let s=document.createElement("p");if(s.innerHTML=a.data.popup,l.appendChild(i),l.appendChild(s),l.appendChild(o),n.bindPopup(l),my_markers.push(n),a.isCarrental?layerCarRentals.addLayer(n):a.isHotel?layerHotels.addLayer(n):a.isEvent?layerEvents.addLayer(n):a.isTrain?layerTrains.addLayer(n):a.isPlane?layerPlanes.addLayer(n):a.isCar&&layerCars.addLayer(n),null!==a.data.end_lat&&null!==a.data.end_lat){let e=L.marker([a.data.end_lat,a.data.end_lng],r);e.data=a,e.name=a.data.name,e.address=a.data.end_address,my_markers.push(e);let t=[[a.data.start_lat,a.data.start_lng],[a.data.end_lat,a.data.end_lng]];if(a.isCarrental)layerCarRentals.addLayer(e);else if(a.isHotel)layerHotels.addLayer(e);else if(a.isEvent)layerEvents.addLayer(e);else if(a.isTrain){let e=[];e[0]=L.polyline(t,{color:"black",weight:"5"}).bindPopup(l),e[1]=L.polyline(t,{color:"black",weight:"3",dashArray:"20, 20",dashOffset:"0"}).bindPopup(l),e[2]=L.polyline(t,{color:"white",weight:"3",dashArray:"20, 20",dashOffset:"20"}).bindPopup(l),layerTrains.addLayer(L.layerGroup(e)),layerTrains.removeLayer(n)}else if(a.isPlane){let t=calculateMidPoint(n,e),r=L.curve(["M",[a.data.start_lat,a.data.start_lng],"Q",t,[a.data.end_lat,a.data.end_lng]],{color:"black",weight:"3",dashArray:"10, 10"}).bindPopup(l);layerPlanes.addLayer(n),layerPlanes.addLayer(r)}else if(a.isCar){let e=[];e[0]=L.polyline(t,{color:"gray",weight:"5"}).bindPopup(l),e[1]=L.polyline(t,{color:"white",weight:"1",dashArray:"10, 10",dashOffset:"0"}).bindPopup(l),layerCars.addLayer(L.layerGroup(e)),layerCars.removeLayer(n)}}}if(my_markers.length>0){var a=new L.featureGroup(my_markers);mymap.fitBounds(a.getBounds())}}function getNextWaypointPos(){let e=0,t=routeControl.getWaypoints().length,a=routeControl.getWaypoints()[0].latLng,r=routeControl.getWaypoints()[t-1].latLng;return a&&(e=routeControl.getWaypoints().length-1),a&&r&&(e=routeControl.getWaypoints().length),e}function addWaypoint(e){let t=getNextWaypointPos(),a=e.name+" ("+e.address+")",r=L.Routing.waypoint(e.getLatLng(),a,{fixed:!0});routeControl.spliceWaypoints(t,1,r)}function initMap(){mymap=L.map("trip-map",{fullscreenControl:!0}).setView([default_location.lat,default_location.lng],default_location.zoom),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(mymap),mymap.addLayer(layerPlanes),mymap.addLayer(layerTrains),mymap.addLayer(layerCars),mymap.addLayer(layerCarRentals),mymap.addLayer(layerHotels),mymap.addLayer(layerEvents),controlLayer=L.control.layers(null,null,{collapsed:!1}),controlLayer.addOverlay(layerPlanes,"<span id='layerPlanes'></span>"),controlLayer.addOverlay(layerTrains,"<span id='layerTrains'></span>"),controlLayer.addOverlay(layerCars,"<span id='layerStreets'></span>"),controlLayer.addOverlay(layerCarRentals,"<span id='layerCarrental'></span>"),controlLayer.addOverlay(layerHotels,"<span id='layerHotels'></span>"),controlLayer.addOverlay(layerEvents,"<span id='layerEvents'></span>"),controlLayer.addTo(mymap);var e=L.control.locate({strings:{title:lang.set_current_location,showPopup:!1},locateOptions:{enableHighAccuracy:!0},icon:"fas fa-map-marker-alt"});mymap.addControl(e),L.easyPrint({position:"bottomleft",sizeModes:["A4Portrait","A4Landscape"],spinnerBgColor:"#1565c0"}).addTo(mymap),currentDayButton?changeDay(currentDayButton):getMarkers(fromInput.value,toInput.value);let t=new(L.Routing.Plan.extend({createGeocoders:function(){var e=L.Routing.Plan.prototype.createGeocoders.call(this);let t=createButton(e,"walk"),a=createButton(e,"bike"),r=createButton(e,"car",!0);return L.DomEvent.on(t,"click",(function(){routeControl.getRouter().options.profile="mapbox/walking",routeControl.route(),t.classList.add("active"),a.classList.remove("active"),r.classList.remove("active")}),this),L.DomEvent.on(a,"click",(function(){routeControl.getRouter().options.profile="mapbox/cycling",routeControl.route(),t.classList.remove("active"),a.classList.add("active"),r.classList.remove("active")}),this),L.DomEvent.on(r,"click",(function(){routeControl.getRouter().options.profile="mapbox/driving",routeControl.route(),t.classList.remove("active"),a.classList.remove("active"),r.classList.add("active")}),this),e}}))([],{geocoder:new L.Control.Geocoder.Mapbox(mapbox_token,{reverseQueryParams:{language:i18n.routing}}),createMarker:function(e,t){return t.options.fixed?null:L.marker(t.latLng,{})},routeWhileDragging:!1,reverseWaypoints:!0,addWaypoints:!0,language:i18n.routing,draggableWaypoints:!1});routeControl=L.Routing.control({waypoints:[],autoRoute:!0,router:L.Routing.mapbox(mapbox_token,{profile:"mapbox/driving",routingOptions:{alternatives:!1,steps:!1},language:i18n.routing}),show:!1,collapsible:!0,showAlternatives:!1,routeWhileDragging:!1,plan:t}).addTo(mymap),routeControl.on("routingerror",(function(e){429==e.error.target.status?alert(lang.routing_error_too_many_requests):alert(lang.routing_error)})),mymap.on("contextmenu",(function(e){let t=getNextWaypointPos();routeControl.spliceWaypoints(t,1,e.latlng)}))}function calculateMidPoint(e,t){let a=e.getLatLng(),r=t.getLatLng();var n=r.lng-a.lng,o=r.lat-a.lat,l=Math.sqrt(Math.pow(n,2)+Math.pow(o,2)),i=Math.atan2(o,n),s=l/2/Math.cos(.314),d=i+.314,c=s*Math.cos(d)+a.lng;return[s*Math.sin(d)+a.lat,c]}function createButton(e,t,a=!1){var r=L.DomUtil.create("button","",e);return r.setAttribute("type","button"),r.title=t,r.classList.add("leaflet-routing-btn"),r.classList.add(t),a&&r.classList.add("active"),r}routeBtn&&routeBtn.addEventListener("click",(function(e){e.preventDefault(),routeControl.setWaypoints([]),my_markers.forEach((function(e,t){e.data.isPlane||addWaypoint(e)})),routeControl.show()})),initMap(),tripDays.forEach((function(e){new Sortable(e,{draggable:".trip_event",handle:".icon",ghostClass:"trip_event-placeholder",dataIdAttr:"data-event",onUpdate:function(e){var t={events:this.toArray()};getCSRFToken().then((function(e){return t.csrf_name=e.csrf_name,t.csrf_value=e.csrf_value,fetch(jsObject.trip_event_position_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})})).then((function(e){return e.json()})).then((function(e){getMarkers(fromInput.value,toInput.value)})).catch((function(e){console.log(e)}))}})}));