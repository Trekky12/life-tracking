{% extends "base.twig" %}

{% set active = 'splitbills' %}

{% set hasMap = not entry.lat is null and not entry.lng is null %}

{% set settleUp = (type == 'settleup') or (not entry is null and entry.settleup == 1) %}

{% set foreignCurrency = (not group.currency is empty and group.currency != i18n.currency) %}

{% block javascript %}
	<script src="{{baseURL}}/static/js/splitbills.js?ver={{CACHEMISS}}"></script>
{% endblock %}

{% block pageheader %}
	<div class="page-header">
		<div class="page-headline">
			<a href="{{ url_for_with_last_query_params('splitbill_bills_recurring', {'group': group.hash})}}">
				<div tabindex="-1" class="icon-ripple-wrapper back-arrow">{{ fontawesome('fas fa-arrow-left') }}</div>
			</a>
			<h2>{{"RECURRING"|trans}}
				{% if settleUp %}
					{{"SPLITBILLS_SETTLE_UP"|trans}}
				{%else %}
					{{"SPLITBILL_BILL"|trans}}
				{% endif %}
				|
				{{group.name|raw}}</h2>
		</div>
	</div>
{% endblock %}

{% block body %}
	<div class="inner-content">
		<div class="page-content">

			<form class="form-horizontal" id="splitbillsBillsForm" action="{{ url_for('splitbill_bills_recurring_save', {'id' : entry.id, 'group' : group.hash}) }}" method="POST">
				<input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
				<input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">

				<input name="settleup" type="hidden" value="{% if settleUp %}1{% else %}0{% endif %}">

				<input name="paid_by" type="hidden" value="{% if not entry is null %}{{ entry.paid_by }}{% endif %}">
				<input name="spend_by" type="hidden" value="{% if not entry is null %}{{ entry.spend_by }}{% endif %}">

				{% if not entry is null %}
					<input name="id" id="entry_id" type="hidden" value="{{entry.id}}">
				{% endif %}

				<div class="form-group">
					<label for="inputName">{{"NAME"|trans}}</label>
					<input type="text" required class="form-control" id="inputName" name="name" {% if not entry is null %} value="{{entry.name|raw}}" {% elseif settleUp %} value="{{"SPLITBILLS_SETTLE_UP"|trans}}" {% endif %}>
				</div>

				{% if foreignCurrency %}
					<div class="two-columns mobile">
						<div class="form-group left">
							<label for="inputValueForeign">{{"VALUE"|trans}}
								({{ group.currency }})</label>
							<input type="number" step="any" inputmode="decimal" class="form-control" id="inputValueForeign" name="foreignValue" value="{{totalValueForeign}}">
						</div>
						<div class="form-group right">
							<label for="inputValue">{{"VALUE"|trans}}
								({{ i18n.currency }})</label>
							<input type="number" step="any" inputmode="decimal" readonly="readonly" class="form-control read-only" id="inputValue" name="value" value="{{totalValue}}">
						</div>
					</div>

					<div class="two-columns">
						<div class="form-group left">
							<label for="inputRate">{{"EXCHANGE_RATE"|trans}}
								({{ i18n.currency }}
								=>
								{{ group.currency }})
							</label>
							<input type="number" step="any" inputmode="decimal" class="form-control" id="inputRate" name="exchange_rate" value="{% if not entry is null %}{{entry.exchange_rate}}{% else %}{{ group.exchange_rate }}{% endif %}">
						</div>
						<div class="form-group right">
							<label for="inputFee">{{"EXCHANGE_FEE"|trans}}
								(%)
							</label>
							<input type="number" step="any" inputmode="decimal" class="form-control" id="inputFee" name="exchange_fee" value="{% if not entry is null %}{{entry.exchange_fee}}{% else %}{{ group.exchange_fee }}{% endif %}">
						</div>
					</div>
				{% else %}
					<div class="form-group">
						<label for="inputValue">{{"VALUE"|trans}}
							({{ i18n.currency }})</label>
						<input type="number" step="any" inputmode="decimal" class="form-control" id="inputValue" name="value" value="{{totalValue}}">
					</div>
				{% endif %}

				{% if group_users|length > 1 %}
					<h3 id="splitbill_headline">
						{% if settleUp %}
							{{"SPLITBILLS_SETTLE_UP_SENDER"|trans}}
						{%else %}
							{{"PAID"|trans}}
						{% endif %}
					</h3>
					<h4>{{ "REMAINING"|trans }}:
						<span id="remaining_paid">{{ 0|number_format(2) }}</span>
						{{ i18n.currency }}</h4>
					<div class="form-group splitbill-buttons">
						<button type="button" class="button splitbill_btn small {% if entry is null or entry.paid_by != " same"%}button-outlined{% endif %}" data-category="paid" data-type="same">{{ "SPLITBILLS_EQUALLY"|trans }}</button>
						{% for user_id in group_users|keys %}
							<button type="button" class="button splitbill_btn small {% if entry is null or entry.paid_by != user_id%}button-outlined{% endif %}" data-category="paid" data-type="person" data-id="{{ user_id }}">
								{% if settleUp %}
									{{ users[user_id].name }}
								{%else %}
									{{ "SPLITBILLS_BY_PERSON"|trans({'%user%': users[user_id].name}) }}
								{% endif %}
							</button>
						{% endfor %}
						<button type="button" class="button splitbill_btn small {% if entry is null or entry.paid_by != " individual" %}button-outlined{% endif %}" data-category="paid" data-type="individual">{{ "SPLITBILLS_INDIVIDUAL"|trans }}</button>
					</div>
					<div class="userlist {% if entry is null or entry.paid_by != " individual" %}hidden{% endif %}">
						<div class="user-entry header">
							<div class="user"></div>
							{% if foreignCurrency %}
								<div class="input-field">
									{{"VALUE"|trans}}
									({{ group.currency }})
								</div>
							{% endif %}
							<div class="input-field">
								{{"VALUE"|trans}}
								({{ i18n.currency }})
							</div>
							<div class="paymethod-field">
								{{"FINANCES_PAYMETHOD"|trans}}
							</div>
						</div>
						{% for user_id in group_users|keys %}
							<div class="form-group user-entry">
								<div class="user">
									{% if not settleUp %}
										{{"SPLITBILLY_PAID_SPEND_BY_PERSON"|trans}}
									{% endif %}
									{{ users[user_id].name }}
								</div>
								{% if foreignCurrency %}
									<div class="input-field" data-title="{{"VALUE"|trans}} ({{ group.currency }})">
										<input type="number" step="any" inputmode="decimal" class="form-control balance_paid_foreign" name="balance[{{ user_id }}][paid_foreign]" value="{% if not balance is empty and user_id in balance|keys %}{{balance[user_id]["paid_foreign"]}}{% else %}0{% endif %}">
									</div>
								{% endif %}
								<div class="input-field" data-title="{{"VALUE"|trans}} ({{ i18n.currency }})">
									<input type="number" step="any" inputmode="decimal" {% if foreignCurrency %} readonly="readonly" {% endif %} class="form-control balance_paid {% if foreignCurrency %}read-only{% endif %}" name="balance[{{ user_id }}][paid]" value="{% if not balance is empty and user_id in balance|keys %}{{balance[user_id]["paid"]}}{% else %}0{% endif %}">
								</div>
								<div class="paymethod-field" data-title="{{"FINANCES_PAYMETHOD"|trans}}">
									<div class="select-wrapper form-control">
										<select name="balance[{{ user_id }}][paymethod_spend]">
											<option value="">{{"DROPDOWN_NO_PAYMETHOD"|trans}}</option>
											{% for method in paymethods[user_id] %}
												<option value="{{method.id}}" {% if (not balance is empty and method.id == balance[user_id]["paymethod_spend"]) or (balance is empty and method.is_default == 1) %} selected {% endif %}>{{method.name|raw}}</option>
											{% endfor %}
										</select>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
					<h3 id="splitbill_headline">
						{% if settleUp %}
							{{"SPLITBILLS_SETTLE_UP_RECEIVER"|trans}}
						{%else %}
							{{"SPEND"|trans}}
						{% endif %}
					</h3>
					<h4>{{ "REMAINING"|trans }}:
						<span id="remaining_spend">{{ 0|number_format(2) }}</span>
						{{ i18n.currency }}</h4>
					<div class="form-group splitbill-buttons">
						<button type="button" class="button splitbill_btn small {% if entry is null or entry.spend_by != " same"%}button-outlined{% endif %}" data-category="spend" data-type="same">{{ "SPLITBILLS_EQUALLY"|trans }}</button>
						{% for user_id in group_users|keys %}
							<button type="button" class="button splitbill_btn small {% if entry is null or entry.spend_by != user_id%}button-outlined{% endif %}" data-category="spend" data-type="person" data-id="{{ user_id }}">
								{% if settleUp %}
									{{ users[user_id].name }}
								{%else %}
									{{ "SPLITBILLS_ONLY_PERSON"|trans({'%user%': users[user_id].name}) }}
								{% endif %}
							</button>
						{% endfor %}
						<button type="button" type="button" class="button splitbill_btn small {% if entry is null or entry.spend_by != " individual" %}button-outlined{% endif %}" data-category="spend" data-type="individual">{{ "SPLITBILLS_INDIVIDUAL"|trans }}</button>
					</div>
					<div class="userlist {% if entry is null or entry.spend_by != " individual" %}hidden{% endif %}">
						<div class="user-entry header">
							<div class="user"></div>
							{% if foreignCurrency %}
								<div class="input-field">
									{{"VALUE"|trans}}
									({{ group.currency }})
								</div>
							{% endif %}
							<div class="input-field">
								{{"VALUE"|trans}}
								({{ i18n.currency }})
							</div>
						</div>
						{% for user_id in group_users|keys %}
							<div class="form-group user-entry">
								<div class="user">
									{% if not settleUp %}
										{{"SPLITBILLY_PAID_SPEND_BY_PERSON"|trans}}
									{% endif %}
									{{ users[user_id].name }}
								</div>
								{% if foreignCurrency %}
									<div class="input-field" data-title="{{"VALUE"|trans}} ({{ group.currency }})">
										<input type="number" step="any" inputmode="decimal" class="form-control balance_spend_foreign" name="balance[{{ user_id }}][spend_foreign]" value="{% if not balance is empty and user_id in balance|keys %}{{balance[user_id]["spend_foreign"]}}{% else %}0{% endif %}">
									</div>
								{% endif %}
								<div class="input-field" data-title="{{"VALUE"|trans}} ({{ i18n.currency }})">
									<input type="number" step="any" inputmode="decimal" {% if foreignCurrency %} readonly="readonly" {% endif %} class="form-control balance_spend {% if foreignCurrency %}read-only{% endif %}" name="balance[{{ user_id }}][spend]" value="{% if not balance is empty and user_id in balance|keys %}{{balance[user_id]["spend"]}}{% else %}0{% endif %}">
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}

					<div class="form-group">
						<label for="inputValue">{{"FINANCES_PAYMETHOD"|trans}}</label>
						<div class="select-wrapper form-control">
							<select name="balance[{{ me }}][paymethod_spend]">
								<option value="">{{"DROPDOWN_NO_PAYMETHOD"|trans}}</option>
								{% for method in paymethods[me] %}
									<option value="{{method.id}}" {% if (not balance is empty and method.id == balance[me]["paymethod_spend"]) or (balance is empty and method.is_default == 1) %} selected {% endif %}>{{method.name|raw}}</option>
								{% endfor %}
							</select>
						</div>
					</div>

					<input type="hidden" class="balance_spend_foreign" name="balance[{{ me }}][spend_foreign]" value="{% if not balance is empty and me in balance|keys %}{{balance[me]["spend_foreign"]}}{% else %}0{% endif %}">
					<input type="hidden" {% if foreignCurrency %} readonly="readonly" {% endif %} class="balance_spend {% if foreignCurrency %}read-only{% endif %}" name="balance[{{ me }}][spend]" value="{% if not balance is empty and me in balance|keys %}{{balance[me]["spend"]}}{% else %}0{% endif %}">
					<input type="hidden" class="balance_paid_foreign" name="balance[{{ me }}][paid_foreign]" value="{% if not balance is empty and me in balance|keys %}{{balance[me]["paid_foreign"]}}{% else %}0{% endif %}">
					<input type="hidden" {% if foreignCurrency %} readonly="readonly" {% endif %} class="balance_paid {% if foreignCurrency %}read-only{% endif %}" name="balance[{{ me }}][paid]" value="{% if not balance is empty and me in balance|keys %}{{balance[me]["paid"]}}{% else %}0{% endif %}">

				{% endif %}

				<div class="form-group">
					<label for="inputNotice">{{"NOTICE"|trans}}</label>
					<input type="text" class="form-control" id="inputNotice" name="notice" {% if not entry is null %} value="{{entry.notice|raw}}{% endif %}">
				</div>

				<h3>{{"INTERVAL"|trans}}</h3>
				<div class="form-group">
					<label for="dateSelectField">{{"START"|trans}}</label>
					<div class="flatpickr-group" id="dateSelect">
						<input type="text" class="form-control" id="dateSelectField" name="start" value="{% if not entry is null and not entry.start is null %}{{entry.start|date('Y-m-d')}}{% endif %}" data-input/>

						<a class="flatpickr-input-button" title="toggle" data-toggle>
							{{ fontawesome('fas fa-calendar-days') }}
						</a>

						<a class="flatpickr-input-button" title="clear" data-clear>
							{{ fontawesome('fas fa-xmark') }}
						</a>
					</div>
				</div>
				<div class="form-group">
					<label for="dateSelectEndField">{{"END"|trans}}</label>
					<div class="flatpickr-group" id="dateSelectEnd">
						<input type="text" class="form-control" id="dateSelectEndField" name="end" value="{% if not entry is null and not entry.end is null%}{{entry.end|date('Y-m-d')}}{% endif %}" data-input/>

						<a class="flatpickr-input-button" title="toggle" data-toggle>
							{{ fontawesome('fas fa-calendar-days') }}
						</a>

						<a class="flatpickr-input-button" title="clear" data-clear>
							{{ fontawesome('fas fa-xmark') }}
						</a>
					</div>
				</div>
				<div class="form-group">
					<label for="inputUnit">{{"UNIT"|trans}}</label>
					<div class="select-wrapper form-control">
						<select id="inputUnit" name="unit">
							{% for unit, unitName in units %}
								<option value="{{unit}}" {% if (not entry is null and unit == entry.unit) or (entry is null and unit == 'month') %} selected {% endif %}>{{unitName|trans}}</option>
							{% endfor %}
						</select>
					</div>
				</div>
				<div class="form-group">
					<label for="inputMultiplier">{{"MULTIPLIER"|trans}}</label>
					<input type="number" class="form-control" id="inputMultiplier" name="multiplier" step="1" pattern="\d*" value="{% if not entry is null %}{{entry.multiplier}}{% else %}1{% endif %}">
				</div>

				<div class="form-group">
					<label class="checkbox" for="checkboxActive">
						<input name="is_active" type="checkbox" value="1" id="checkboxActive" {% if entry is not null and entry.is_active == 1 %} checked {% endif %}>
						{{"ACTIVE"|trans}}
					</label>
				</div>

				<div class="form-group btn">
					<button type="submit" class="button">
						{% if not entry is null %}
							{{"SAVE"|trans}}
						{% else %}
							{{"INSERT"|trans}}
						{% endif %}
					</button>
					{% if not entry is null %}
						<button id="cancel" class="button button-text">{{"CANCEL"|trans}}</button>
					{% endif %}
				</div>
			</form>
		</div>
	</div>
{% endblock %}
